---
phase: 03-ontology-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/ontology-relation-data.ts
  - src/components/charts/dashboard/OntologyChordView.tsx
  - src/components/charts/dashboard/OntologyForceView.tsx
  - src/components/charts/dashboard/OntologySankeyView.tsx
  - src/components/charts/dashboard/OntologyRelationChart.tsx
  - src/app/(authenticated)/page.tsx
autonomous: true
requirements:
  - DASH-04

must_haves:
  truths:
    - "Chord/Force/Sankey 3개 뷰를 토글로 전환할 수 있다"
    - "기본 뷰는 Force Graph이다"
    - "Chord Diagram에서 6개 온톨로지 타입 간 리본이 관계를 표시한다"
    - "Force Graph에서 6개 노드가 링크로 연결되고 호버 시 관계가 하이라이트된다"
    - "Sankey Diagram에서 All/Inbound/Outbound 방향 필터가 동작한다"
    - "Chord와 Force에는 방향 필터가 없다"
    - "모든 3개 뷰에서 호버 시 관계가 하이라이트된다"
    - "다크/라이트 테마 전환 시 3개 뷰 모두 색상이 즉시 반응한다"
  artifacts:
    - path: "src/lib/ontology-relation-data.ts"
      provides: "Data transformation: OntologyType[] to ChordData, ForceData, SankeyData"
      exports: ["buildChordData", "buildForceData", "buildSankeyData"]
      min_lines: 60
    - path: "src/components/charts/dashboard/OntologyRelationChart.tsx"
      provides: "Container with view toggle (Chord/Force/Sankey) and direction filter for Sankey"
      min_lines: 40
    - path: "src/components/charts/dashboard/OntologyChordView.tsx"
      provides: "D3 chord diagram with hover highlight"
      min_lines: 80
    - path: "src/components/charts/dashboard/OntologyForceView.tsx"
      provides: "D3 force-directed graph with hover highlight"
      min_lines: 80
    - path: "src/components/charts/dashboard/OntologySankeyView.tsx"
      provides: "D3 sankey diagram with direction filter and hover highlight"
      min_lines: 80
  key_links:
    - from: "src/lib/ontology-relation-data.ts"
      to: "@/data/studio-data"
      via: "getOntologyTypes() for source data"
      pattern: "getOntologyTypes"
    - from: "src/components/charts/dashboard/OntologyRelationChart.tsx"
      to: "src/lib/ontology-relation-data.ts"
      via: "import build functions for data transformation"
      pattern: "buildChordData|buildForceData|buildSankeyData"
    - from: "src/components/charts/dashboard/OntologySankeyView.tsx"
      to: "d3-sankey"
      via: "import sankey, sankeyLinkHorizontal, sankeyCenter"
      pattern: "from \"d3-sankey\""
    - from: "src/components/charts/dashboard/OntologyForceView.tsx"
      to: "d3"
      via: "import forceSimulation, forceLink, forceManyBody, forceCenter"
      pattern: "forceSimulation"
    - from: "src/app/(authenticated)/page.tsx"
      to: "src/components/charts/dashboard/OntologyRelationChart.tsx"
      via: "replace ontology relations skeleton with OntologyRelationChart"
      pattern: "OntologyRelationChart"
---

<objective>
Build the 3-view ontology relation chart (Chord/Force/Sankey) with data transformation layer, then integrate into the dashboard page as the final chart component.

Purpose: This is the most complex visualization in Phase 3, requiring 3 distinct D3 layout algorithms sharing the same source data. It validates cross-library integration (d3-chord, d3-force, d3-sankey), data transformation patterns, and multi-view component architecture. Completing this removes the last skeleton placeholder on the dashboard.
Output: OntologyRelationChart with toggle between Chord Diagram, Force Graph (default), and Sankey Diagram. Sankey has direction filter (All/Inbound/Outbound). All views have hover highlight. Dashboard page is fully populated.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ontology-dashboard/03-RESEARCH.md
@.planning/phases/03-ontology-dashboard/03-01-SUMMARY.md

@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
@src/data/studio-data.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data transformation layer + 3 D3 view components</name>
  <files>
    src/lib/ontology-relation-data.ts
    src/components/charts/dashboard/OntologyChordView.tsx
    src/components/charts/dashboard/OntologyForceView.tsx
    src/components/charts/dashboard/OntologySankeyView.tsx
  </files>
  <action>
    1. Create `src/lib/ontology-relation-data.ts`:
    - Import OntologyType from @/types, getOntologyTypes from @/data/studio-data

    Export interfaces and functions:

    a) ChordData: `{ matrix: number[][]; names: string[]; colors: string[] }`
       `buildChordData(types: OntologyType[]): ChordData`
       - Create 6x6 matrix from relations. matrix[sourceIdx][targetIdx] = Math.round(sourceType.nodeCount / 100) for each relation.
       - Diagonal = 0. names = type names. colors = chart-1 through chart-6 CSS var references.

    b) ForceData: `{ nodes: ForceNode[]; links: ForceLink[] }` where ForceNode = `{ id: string; name: string; nodeCount: number; color: string }`, ForceLink = `{ source: string; target: string; label: string }`
       `buildForceData(types: OntologyType[]): ForceData`
       - Nodes from types. Links from all relations (source = type name, target = relation target, label = relation name).

    c) SankeyData: `{ nodes: SankeyNodeData[]; links: SankeyLinkData[] }` where SankeyNodeData = `{ name: string; color: string }`, SankeyLinkData = `{ source: number; target: number; value: number; label: string }`
       `buildSankeyData(types: OntologyType[], direction: "all" | "inbound" | "outbound"): SankeyData`
       - For "outbound": direct mapping source->target with nodeCount as value
       - For "inbound": reverse source/target
       - For "all": include both directions, aggregate same source-target pairs (use Map to deduplicate)

    2. Create `src/components/charts/dashboard/OntologyChordView.tsx`:
    - "use client", Props: `{ data: ChordData; width: number; height: number }`
    - Use `useTheme()`, useRef, useEffect with resolvedTheme dep
    - D3: d3.chord() on matrix -> chord groups (arcs) + ribbons
    - Color arcs using resolved chart colors (resolveColor on data.colors[i])
    - Hover: on ribbon mouseenter, dim all other ribbons (opacity 0.1), highlight hovered (opacity 0.8). On mouseleave, restore all to 0.6.
    - Tooltip: show source type -> target type with relation count
    - Labels: type names along outer arcs
    - Cleanup: cleanupD3Svg, tooltip.destroy

    3. Create `src/components/charts/dashboard/OntologyForceView.tsx`:
    - "use client", Props: `{ data: ForceData; width: number; height: number }`
    - D3: forceSimulation with forceLink (id accessor = d.id), forceManyBody (strength -200), forceCenter(width/2, height/2), forceCollide(30)
    - Render nodes as circles (r based on Math.log(nodeCount) * 3, min 8, max 25), colored by chart series
    - Render links as lines, stroke = colors.gridLine, strokeWidth 1.5
    - Link labels: relation name text along links (small font, rotated)
    - Hover: on node mouseenter, highlight connected links and connected nodes (full opacity), dim all others (opacity 0.15). Show tooltip with type name and nodeCount.
    - CRITICAL: simulation.stop() in cleanup function to prevent memory leaks
    - Cleanup: simulation.stop(), observer.disconnect(), tooltip.destroy(), cleanupD3Svg()

    4. Create `src/components/charts/dashboard/OntologySankeyView.tsx`:
    - "use client", Props: `{ data: SankeyData; width: number; height: number; direction: "all" | "inbound" | "outbound" }`
    - Import sankey, sankeyLinkHorizontal, sankeyCenter from "d3-sankey"
    - D3: sankey layout with nodeWidth(15), nodePadding(10), nodeAlign(sankeyCenter), extent([[1, 5], [width-1, height-5]])
    - Render nodes as rects, colored by chart series (resolve data.nodes[i].color)
    - Render links using sankeyLinkHorizontal() as path d attribute, fill none, stroke = source node color at 0.3 opacity, strokeWidth = link width
    - Node labels: type names next to nodes
    - Hover: on link mouseenter, highlight link (opacity 0.6, strokeWidth * 1.2), show tooltip with source->target, label, value. Dim other links. On mouseleave, restore.
    - Handle edge case: "inbound" direction generates reversed links which can have self-referencing sankey nodes. Filter out links where source === target.
    - Cleanup: tooltip.destroy(), cleanupD3Svg()
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 4 files compile without errors. Import from "d3-sankey" resolves correctly.
  </verify>
  <done>ontology-relation-data.ts provides 3 data transformation functions. OntologyChordView, OntologyForceView, OntologySankeyView each render their respective D3 visualization with hover highlight and tooltips.</done>
</task>

<task type="auto">
  <name>Task 2: OntologyRelationChart container + page integration (DASH-04)</name>
  <files>
    src/components/charts/dashboard/OntologyRelationChart.tsx
    src/app/(authenticated)/page.tsx
  </files>
  <action>
    1. Create `src/components/charts/dashboard/OntologyRelationChart.tsx`:
    - "use client" component
    - Internal state: `viewType: "chord" | "force" | "sankey"` (default "force" per user decision)
    - Internal state: `sankeyDirection: "all" | "inbound" | "outbound"` (default "all") — only shown when viewType === "sankey"
    - Calls getOntologyTypes() from studio-data.ts, then buildChordData/buildForceData/buildSankeyData from ontology-relation-data.ts based on current viewType
    - Uses useRef for container, createDebouncedResizeObserver for sizing
    - Tracks container width/height in state

    Layout:
    - Header row: "Ontology Relations" title + view toggle (3 buttons or shadcn Tabs: "Chord" / "Force" / "Sankey")
    - Below header, conditionally: if viewType === "sankey", show direction filter (3 small buttons: "All" / "Inbound" / "Outbound")
    - Per user decision: Chord and Force have NO direction filter
    - Chart area: render the appropriate view component based on viewType, passing width/height from ResizeObserver

    Component rendering:
    - viewType === "chord" -> <OntologyChordView data={chordData} width={w} height={h} />
    - viewType === "force" -> <OntologyForceView data={forceData} width={w} height={h} />
    - viewType === "sankey" -> <OntologySankeyView data={sankeyData} width={w} height={h} direction={sankeyDirection} />

    data-testid="ontology-relation-chart"

    2. Update `src/app/(authenticated)/page.tsx`:
    - Replace the "Ontology Relations" skeleton (Row 3 right) with OntologyRelationChart
    - Import OntologyRelationChart
    - After this, NO skeleton placeholders remain — all 7 dashboard components are live
    - Remove any unused ChartSkeleton imports if all placeholders are replaced
  </action>
  <verify>
    `npm run build` passes. Dashboard Row 3 right shows the OntologyRelationChart. Toggle between Chord/Force/Sankey views works. Sankey view shows direction filter. Force view is shown by default. All views have hover highlight. Theme toggle updates colors.
  </verify>
  <done>OntologyRelationChart container manages view toggle (default: Force) and Sankey direction filter. All 3 views render correctly. Dashboard page is fully populated with zero remaining skeletons — all 7 components (MetricCards, Gauges, DualLineChart, OntologyRelationChart, NodeScatterPlot, ResourceBarChart, RecentAlerts) are live.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npm run build` — successful build
3. Chord diagram shows 6 arcs with ribbons connecting ontology types
4. Force graph (default view) shows 6 nodes with relation links and labels
5. Sankey diagram shows flows between ontology types
6. View toggle switches between all 3 views correctly
7. Sankey direction filter (All/Inbound/Outbound) changes visible links
8. Direction filter is HIDDEN for Chord and Force views (per user decision)
9. Hovering on any view highlights the relevant relationship and shows tooltip
10. Force simulation stops cleanly on unmount (no console warnings)
11. Theme toggle updates all 3 view colors immediately
12. Dashboard page has ALL 7 components rendered — no skeleton placeholders remain
</verification>

<success_criteria>
- ontology-relation-data.ts transforms OntologyType[] into 3 distinct data formats
- OntologyChordView renders D3 chord with hover highlight
- OntologyForceView renders D3 force graph with simulation cleanup
- OntologySankeyView renders D3 sankey with direction-filtered data
- OntologyRelationChart toggles between 3 views with Force as default
- Sankey view has direction filter, Chord/Force do not (per user decision)
- All views have hover highlight (per user decision)
- Dashboard page is 100% complete with all 7 components live
</success_criteria>

<output>
After completion, create `.planning/phases/03-ontology-dashboard/03-04-SUMMARY.md`
</output>
