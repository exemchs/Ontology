---
phase: 03-ontology-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/charts/dashboard/NodeScatterPlot.tsx
  - src/components/charts/dashboard/ResourceBarChart.tsx
  - src/app/(authenticated)/page.tsx
autonomous: true
requirements:
  - DASH-05
  - DASH-06

must_haves:
  truths:
    - "산점도에 12개 노드가 Latency(x) x Throughput(y) 좌표로 표시된다"
    - "산점도 노드에 SVG feGaussianBlur 글로우 효과가 적용된다"
    - "산점도 호버 시 노드명, latency, throughput이 tooltip으로 나타난다"
    - "리소스 바 차트에 12개 노드의 CPU/Memory/Disk가 3색 바로 표시된다"
    - "Stacked/Grouped 토글 시 바 레이아웃이 애니메이션으로 전환된다"
    - "다크/라이트 테마 전환 시 산점도와 바 차트 색상이 즉시 반응한다"
  artifacts:
    - path: "src/components/charts/dashboard/NodeScatterPlot.tsx"
      provides: "D3 scatter plot with glow effect and tooltips"
      min_lines: 80
    - path: "src/components/charts/dashboard/ResourceBarChart.tsx"
      provides: "D3 stacked/grouped bar chart with animated toggle"
      min_lines: 100
  key_links:
    - from: "src/components/charts/dashboard/NodeScatterPlot.tsx"
      to: "@/data/dashboard-data"
      via: "getDashboardScatterData() for scatter point data"
      pattern: "getDashboardScatterData"
    - from: "src/components/charts/dashboard/NodeScatterPlot.tsx"
      to: "@/components/charts/shared/chart-tooltip"
      via: "createTooltip for hover info"
      pattern: "createTooltip"
    - from: "src/components/charts/dashboard/ResourceBarChart.tsx"
      to: "@/data/dashboard-data"
      via: "getDashboardResourceBars() for bar data"
      pattern: "getDashboardResourceBars"
    - from: "src/app/(authenticated)/page.tsx"
      to: "src/components/charts/dashboard/NodeScatterPlot.tsx"
      via: "replace scatter skeleton with NodeScatterPlot"
      pattern: "NodeScatterPlot"
    - from: "src/app/(authenticated)/page.tsx"
      to: "src/components/charts/dashboard/ResourceBarChart.tsx"
      via: "replace bar skeleton with ResourceBarChart"
      pattern: "ResourceBarChart"
---

<objective>
Build the NodeScatterPlot and ResourceBarChart D3 components, then integrate them into the dashboard page (Row 4) replacing skeleton placeholders.

Purpose: The scatter plot validates the SVG glow filter pattern and tooltip integration with point data. The bar chart validates the stacked-to-grouped animated transition pattern that will be reused in Phases 5 and 6. Both charts complete Row 4 of the dashboard layout.
Output: Scatter plot showing 12 nodes with glow effect and tooltips, bar chart with animated Stacked/Grouped toggle showing CPU/Memory/Disk per node.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ontology-dashboard/03-RESEARCH.md
@.planning/phases/03-ontology-dashboard/03-01-SUMMARY.md

@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
@src/data/dashboard-data.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NodeScatterPlot D3 component (DASH-05)</name>
  <files>src/components/charts/dashboard/NodeScatterPlot.tsx</files>
  <action>
    Create `src/components/charts/dashboard/NodeScatterPlot.tsx`:
    - "use client" component
    - Calls `getDashboardScatterData()` internally for data
    - Uses `useTheme()` for theme reactivity

    D3 rendering logic with margins {top: 20, right: 20, bottom: 40, left: 50}:
    - X axis: d3.scaleLinear() for latency (ms), axisBottom with "Latency (ms)" label
    - Y axis: d3.scaleLinear() for throughput (ops/sec), axisLeft with "Throughput (ops/s)" label
    - Grid lines: horizontal + vertical grid, stroke = colors.gridLine at 0.1 opacity
    - SVG glow filter: Create `<defs><filter>` with feGaussianBlur (stdDeviation=4) + feMerge pattern (blur layer under SourceGraphic). Use unique filter ID via useId() or random string.
    - Circles: r=6, fill by status color (healthy = colors.chart1, warning = colors.chart4, error = colors.chart8 or a red tone), opacity 0.8
    - Apply glow filter to ALL scatter circles via `filter: url(#filterId)`
    - Tooltip: createTooltip(), show on circle mouseenter with node name, latency (ms), throughput (ops/s), status. Hide on mouseleave.
    - Hover effect: increase circle radius to 8 and opacity to 1 on mouseenter, restore on mouseleave

    Cleanup: observer.disconnect(), tooltip.destroy(), cleanupD3Svg()
    data-testid="node-scatter-plot"
  </action>
  <verify>
    `npx tsc --noEmit` passes. Scatter plot renders 12 circles with glow effect. Hovering shows tooltip with node info.
  </verify>
  <done>NodeScatterPlot renders D3 scatter with X=latency, Y=throughput, 12 nodes with status-based coloring, SVG glow filter on all points, and tooltip on hover. Responsive and theme-aware.</done>
</task>

<task type="auto">
  <name>Task 2: ResourceBarChart D3 component + page integration (DASH-06)</name>
  <files>
    src/components/charts/dashboard/ResourceBarChart.tsx
    src/app/(authenticated)/page.tsx
  </files>
  <action>
    1. Create `src/components/charts/dashboard/ResourceBarChart.tsx`:
    - "use client" component
    - Internal state: `layout: "stacked" | "grouped"` (default "stacked") using useState
    - Calls `getDashboardResourceBars()` internally for data
    - Uses `useTheme()` for theme reactivity

    D3 rendering logic with margins {top: 20, right: 20, bottom: 60, left: 50}:
    - X axis: d3.scaleBand() with node names, axisBottom with rotated labels (-45 degrees) for 12 nodes
    - Y axis: d3.scaleLinear(), axisLeft with "%" label
    - Colors: CPU = colors.chart1, Memory = colors.chart2, Disk = colors.chart3
    - Legend: 3 color swatches with labels (CPU, Memory, Disk) at top of chart

    Stacked layout:
    - Use d3.stack() with keys ["cpu", "memory", "disk"] to compute y0/y1 per segment
    - Render rect groups per category, positioned via x(name) and y(d[1]), height = y(d[0]) - y(d[1])

    Grouped layout:
    - Create inner d3.scaleBand() for 3 categories within each node band
    - Each bar: x = x(name) + innerScale(category), width = innerScale.bandwidth(), y = y(value), height = y(0) - y(value)

    Toggle animation:
    - When layout state changes, DO NOT re-append SVG. Instead, select existing rects and transition them (duration=500ms) to new positions.
    - Strategy: Always render rects with both stacked data (d[0], d[1] from stack) and raw value. Store both in data binding. Transition attrs based on layout mode.
    - If full re-render approach is simpler: cleanupD3Svg + re-render with new layout. The visual transition won't be as smooth but is acceptable for POC.

    Toggle UI: Two small buttons or shadcn Tabs above the chart for "Stacked" / "Grouped"
    Tooltip: createTooltip(), show on bar hover with node name, resource type, value %
    Cleanup: observer.disconnect(), tooltip.destroy(), cleanupD3Svg()
    data-testid="resource-bar-chart"

    2. Update `src/app/(authenticated)/page.tsx`:
    - Replace the "Node Scatter Plot" skeleton (Row 4 left) with NodeScatterPlot
    - Replace the "Resource Bar Chart" skeleton (Row 4 right) with ResourceBarChart
    - Import NodeScatterPlot and ResourceBarChart
    - Only 1 skeleton placeholder remaining after this: Row 3 right (Ontology Relations) — handled by Plan 04
  </action>
  <verify>
    `npm run build` passes. Dashboard Row 4 shows scatter plot (left) and bar chart (right). Stacked/Grouped toggle transitions between layouts. Tooltips work on both charts.
  </verify>
  <done>ResourceBarChart renders D3 stacked/grouped bar chart with 12 nodes x 3 resources, animated toggle, and tooltips. Dashboard page Row 4 now has NodeScatterPlot (left) and ResourceBarChart (right), with only the Ontology Relations skeleton remaining.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npm run build` — successful build
3. Scatter plot shows 12 circles positioned by latency/throughput with visible glow effect
4. Scatter hover tooltip shows node name, latency, throughput, status
5. Bar chart shows 12 nodes with 3-color (CPU/Memory/Disk) stacked bars by default
6. Stacked/Grouped toggle transitions bar positions
7. Bar hover tooltip shows node name, resource type, percentage
8. Theme toggle updates both charts' colors immediately
9. Both charts resize correctly when container changes
</verification>

<success_criteria>
- NodeScatterPlot.tsx renders D3 scatter with glow filter, status-based colors, and tooltips
- ResourceBarChart.tsx renders D3 bars with stacked/grouped toggle and tooltips
- Both use cleanupD3Svg, createDebouncedResizeObserver, getChartColors, createTooltip patterns
- Both respond to theme changes
- Dashboard page has only 1 skeleton remaining (Ontology Relations for Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/03-ontology-dashboard/03-03-SUMMARY.md`
</output>
