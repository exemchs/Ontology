---
phase: 03-ontology-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/charts/dashboard/ResourceGauge.tsx
  - src/components/charts/dashboard/DualLineChart.tsx
  - src/app/(authenticated)/page.tsx
autonomous: true
requirements:
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "CPU/Memory/Disk 게이지 3개가 270도 아크로 렌더되고 각각 퍼센트 값과 라벨이 표시된다"
    - "80% 이상 게이지에 SVG feGaussianBlur 글로우 효과가 나타난다"
    - "듀얼 라인 차트에 Agent Request Rate + Query QPS 두 선이 시간축으로 표시된다"
    - "hourly/daily 토글 시 데이터 간격이 5분/60분으로 전환되고 차트가 재렌더된다"
    - "다크/라이트 테마 전환 시 게이지와 라인 차트 색상이 즉시 반응한다"
  artifacts:
    - path: "src/components/charts/dashboard/ResourceGauge.tsx"
      provides: "D3 270-degree arc gauge with threshold glow"
      min_lines: 80
    - path: "src/components/charts/dashboard/DualLineChart.tsx"
      provides: "D3 dual-line time series with hourly/daily toggle"
      min_lines: 100
  key_links:
    - from: "src/components/charts/dashboard/ResourceGauge.tsx"
      to: "@/components/charts/shared/chart-utils"
      via: "import cleanupD3Svg, createDebouncedResizeObserver"
      pattern: "cleanupD3Svg"
    - from: "src/components/charts/dashboard/ResourceGauge.tsx"
      to: "@/components/charts/shared/chart-theme"
      via: "import getChartColors for resolved colors"
      pattern: "getChartColors"
    - from: "src/components/charts/dashboard/DualLineChart.tsx"
      to: "@/data/dashboard-data"
      via: "getDashboardTimeSeries(interval) for data"
      pattern: "getDashboardTimeSeries"
    - from: "src/components/charts/dashboard/DualLineChart.tsx"
      to: "@/components/charts/shared/chart-tooltip"
      via: "createTooltip for hover info"
      pattern: "createTooltip"
    - from: "src/app/(authenticated)/page.tsx"
      to: "src/components/charts/dashboard/ResourceGauge.tsx"
      via: "replace gauge skeleton with ResourceGauge components"
      pattern: "ResourceGauge"
---

<objective>
Build the ResourceGauge and DualLineChart D3 components, then integrate them into the dashboard page replacing their skeleton placeholders.

Purpose: These are the first two D3 charts in the platform. They validate the D3-in-React pattern (useEffect + cleanup + ResizeObserver + theme reactivity) that all subsequent charts will follow. The gauge validates SVG arc math and filter effects; the line chart validates axes, scales, and interactive toggles.
Output: 3 functioning gauges with 270-degree arcs and threshold glow, 1 dual-line chart with hourly/daily toggle, all responsive and theme-aware.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ontology-dashboard/03-RESEARCH.md
@.planning/phases/03-ontology-dashboard/03-01-SUMMARY.md

@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
@src/components/charts/shared/ChartSkeleton.tsx
@src/components/charts/shared/ChartEmpty.tsx
@src/data/dashboard-data.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ResourceGauge D3 component (DASH-02)</name>
  <files>src/components/charts/dashboard/ResourceGauge.tsx</files>
  <action>
    Create `src/components/charts/dashboard/ResourceGauge.tsx`:
    - "use client" component
    - Props: `{ data: GaugeData; className?: string }` (import GaugeData from @/types)
    - Use `useTheme()` from next-themes, include `resolvedTheme` in useEffect deps for theme reactivity
    - Use the established D3-in-React pattern:
      1. `useRef<HTMLDivElement>(null)` for container
      2. `useEffect` with destroyed flag
      3. `cleanupD3Svg(container)` before render and in cleanup
      4. `createDebouncedResizeObserver` for responsive resize
      5. Cleanup: observer.disconnect() + cleanupD3Svg()

    D3 rendering logic:
    - 270-degree arc: startAngle = -3*PI/4 (-135deg), endAngle = 3*PI/4 (+135deg), gap at bottom (6 o'clock)
    - Background track arc: full 270 degrees, fill with colors.gridLine at 0.3 opacity, cornerRadius(4)
    - Value arc: from startAngle to computed valueAngle based on (data.value / data.max), cornerRadius(4)
    - Value arc fill: resolve data.color via resolveColor() from chart-theme (since data.color is a CSS var reference like "var(--color-chart-1)")
    - SVG glow filter: create `<defs><filter id="gauge-glow-{unique}">` with `feGaussianBlur stdDeviation=3.5` + `feComposite operator=over`. Use React useId() or Math.random() for unique filter ID to avoid collisions.
    - Apply glow filter only when data.value/data.max >= 0.8 (80% threshold)
    - Center text: value with "%" suffix in bold 24px, label below in 12px muted text
    - Compute sizing from container dimensions: outerRadius = min(width, height) * 0.4, innerRadius = outerRadius * 0.75

    Handle empty data with ChartEmpty fallback.
    Add data-testid="resource-gauge-{data.label.toLowerCase()}" on the container div.
  </action>
  <verify>
    `npx tsc --noEmit` passes. The component renders a 270-degree arc with correct angle math (gap at bottom). Glow effect appears when value >= 80%.
  </verify>
  <done>ResourceGauge renders a 270-degree D3 arc with value fill, background track, center text, and SVG glow filter at 80% threshold. Responds to theme changes and container resize.</done>
</task>

<task type="auto">
  <name>Task 2: DualLineChart D3 component + page integration (DASH-03)</name>
  <files>
    src/components/charts/dashboard/DualLineChart.tsx
    src/app/(authenticated)/page.tsx
  </files>
  <action>
    1. Create `src/components/charts/dashboard/DualLineChart.tsx`:
    - "use client" component
    - Internal state: `interval: "hourly" | "daily"` (default "hourly") using useState
    - Calls `getDashboardTimeSeries(interval)` to get data (re-calls when interval changes)
    - Uses `useTheme()` for theme reactivity in useEffect

    D3 rendering logic with margins {top: 20, right: 20, bottom: 40, left: 50}:
    - X axis: d3.scaleTime() using extent of first series time values, axisBottom with d3.timeFormat (auto-detect format based on interval)
    - Y axis: d3.scaleLinear() from 0 to max of all values, axisLeft with formatNumber from chart-utils
    - Grid lines: horizontal grid using y-axis ticks, stroke = colors.gridLine at 0.1 opacity
    - Two lines: d3.line() with curveMonotoneX interpolation, stroke = resolved series colors, strokeWidth = 2
    - Dots on data points: small circles (r=3) at each data point, matching line color
    - Tooltip: createTooltip() from chart-tooltip.ts, show on dot hover with time + value
    - Legend: render in SVG or as React elements below the chart, showing series name + color dot
    - Toggle UI: Two small buttons or shadcn Tabs (use the already-installed Tabs component) above the chart for "Hourly" / "Daily" switching. Keep it minimal — just text buttons with active state styling.

    Handle cleanup: observer.disconnect(), tooltip.destroy(), cleanupD3Svg().
    data-testid="dual-line-chart"

    2. Update `src/app/(authenticated)/page.tsx`:
    - Replace the 3 gauge skeleton placeholders (Row 2) with 3 ResourceGauge components, each receiving one item from getDashboardGauges()
    - Replace the "Dual Line Chart" skeleton (Row 3 left) with DualLineChart component
    - Import ResourceGauge and DualLineChart
    - Keep the remaining 2 chart skeletons (Row 3 right = Ontology Relations, Row 4 = Scatter + Bar) as placeholders for Plans 03/04
  </action>
  <verify>
    `npm run build` passes. Dashboard shows 3 gauges (CPU/Memory/Disk) with 270-degree arcs and a dual-line chart with hourly/daily toggle. Hovering on line data points shows tooltip. Theme toggle updates chart colors.
  </verify>
  <done>DualLineChart renders 2 time-series lines with axes, grid, tooltips, and hourly/daily toggle. Dashboard page now has working MetricCards, ResourceGauges, DualLineChart, RecentAlerts, with only 3 skeleton placeholders remaining (Ontology Relations, Scatter, Bar).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npm run build` — successful build
3. 3 gauges display with 270-degree arcs, values, and labels (CPU, Memory, Disk)
4. Gauge glow effect activates when value exceeds 80%
5. Dual line chart shows 2 lines with different colors
6. Hourly/Daily toggle changes the data interval and re-renders the chart
7. Hovering data points shows tooltip with formatted time and value
8. Switching between dark/light theme updates all chart colors immediately
</verification>

<success_criteria>
- ResourceGauge.tsx renders D3 270-degree arcs with correct angle math (gap at 6 o'clock)
- SVG feGaussianBlur glow filter activates at 80% threshold
- DualLineChart.tsx renders 2 time-series lines with D3 scales and axes
- Hourly/daily toggle changes data interval and re-renders
- Both charts use established patterns: cleanupD3Svg, createDebouncedResizeObserver, getChartColors, createTooltip
- Both charts respond to theme changes via resolvedTheme dependency
- Dashboard page integrates gauges and line chart, replacing skeleton placeholders
</success_criteria>

<output>
After completion, create `.planning/phases/03-ontology-dashboard/03-02-SUMMARY.md`
</output>
