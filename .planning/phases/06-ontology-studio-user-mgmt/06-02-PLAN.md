---
phase: 06-ontology-studio-user-mgmt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/charts/studio/OntologyGraph.tsx
autonomous: true
requirements: [STUD-03]

must_haves:
  truths:
    - "D3 ontology graph renders 6 type nodes with edges between them"
    - "Graph switches between Force, Radial, and Hierarchy layout modes via toggle"
    - "Nodes can be dragged in Force mode and zoom/pan works in all modes"
    - "Bidirectional edges render as curved arcs with arrowhead markers"
    - "Edge filter (All/Outbound/Inbound) visually filters displayed edges"
  artifacts:
    - path: "src/components/charts/studio/OntologyGraph.tsx"
      provides: "D3 ontology graph with 3 layout modes"
      exports: ["OntologyGraph"]
      min_lines: 200
  key_links:
    - from: "src/components/charts/studio/OntologyGraph.tsx"
      to: "src/data/studio-data.ts"
      via: "receives OntologyType[] as prop, builds graph data internally"
      pattern: "OntologyType.*relations"
    - from: "src/components/charts/studio/OntologyGraph.tsx"
      to: "src/components/charts/shared/chart-utils.ts"
      via: "uses createDebouncedResizeObserver for responsive sizing"
      pattern: "createDebouncedResizeObserver"
    - from: "src/components/charts/studio/OntologyGraph.tsx"
      to: "src/components/charts/shared/chart-theme.ts"
      via: "resolves chart colors for nodes from CSS variables"
      pattern: "resolveChartColor|getComputedStyle"
---

<objective>
Build the D3 OntologyGraph component supporting Force, Radial, and Hierarchy layout modes with zoom/pan, node dragging, bidirectional edge rendering, and edge filtering.

Purpose: This is the highest-complexity visualization in Phase 6 -- a single SVG container that transitions between three fundamentally different D3 layout algorithms (forceSimulation, tree+radial projection, tree+cartesian). Isolating it in its own plan ensures quality within context budget.

Output: 1 file -- OntologyGraph.tsx (self-contained D3 chart component).
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ontology-studio-user-mgmt/06-CONTEXT.md
@.planning/phases/06-ontology-studio-user-mgmt/06-RESEARCH.md

@src/types/index.ts
@src/data/studio-data.ts
@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: D3 OntologyGraph with Force/Radial/Hierarchy modes</name>
  <files>src/components/charts/studio/OntologyGraph.tsx</files>
  <action>
Create `src/components/charts/studio/OntologyGraph.tsx` (`"use client"`).

**Props interface:**
```typescript
interface OntologyGraphProps {
  types: OntologyType[];
  selectedType: OntologyType | null;
  onSelectType?: (type: OntologyType) => void;
  edgeFilter: "all" | "outbound" | "inbound";
  className?: string;
}
```

**Internal types:**
```typescript
type GraphMode = "force" | "radial" | "hierarchy";

interface GraphNode {
  id: string;
  name: string;
  nodeCount: number;
  x?: number;
  y?: number;
  fx?: number | null;
  fy?: number | null;
}

interface GraphLink {
  source: string | GraphNode;
  target: string | GraphNode;
  name: string;
  direction: "outbound" | "inbound";
}
```

**Graph Data Builder:**
- `buildGraphData(types, edgeFilter, selectedType)` function:
  - Creates nodes from all 6 types.
  - Creates links from type.relations:
    - "all" filter: include all relations from all types.
    - "outbound" filter: if selectedType is set, only include relations where source = selectedType.name. If no selection, show all.
    - "inbound" filter: if selectedType is set, scan all types for relations whose target = selectedType.name. If no selection, show all.
  - Deduplicate bidirectional edges (Equipment->Process and Process->Equipment should both render, but as separate curved arcs).

**Mode Toggle:**
- Render a mode toggle bar at the top of the graph area using shadcn-style buttons (3 buttons: Force/Radial/Hierarchy) or a segmented control. Use simple button group with active state styling.
- State: `const [mode, setMode] = useState<GraphMode>("force")` (Force is default per locked decision).

**SVG Structure:**
- `<svg>` fills container via ref + `createDebouncedResizeObserver` from chart-utils.ts.
- `<defs>` with arrow marker for directed edges:
  ```
  <marker id="arrow-{uniqueId}" viewBox="0 0 10 10" refX="20" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
    <path d="M 0 0 L 10 5 L 0 10 Z" fill="currentColor" />
  </marker>
  ```
  Use a unique ID prefix (useId or useRef) to avoid marker ID collisions if multiple graphs render.
- `<g class="zoom-group">` for zoom transform -- all nodes/edges inside this group.

**Layout Engines:**

1. **Force mode (default):**
   - `d3.forceSimulation(nodes)` with:
     - `forceLink(links).id(d => d.id).distance(120).strength(0.5)`
     - `forceManyBody().strength(-500)`
     - `forceCenter(width/2, height/2)`
     - `forceCollide(50)`
     - `alphaDecay(0.02)` for smooth stabilization
   - On each tick: update node `cx/cy` and link path `d` attributes.
   - Node drag via `d3.drag()`: set `fx/fy` on drag, clear `fx/fy` on dragend (or keep pinned -- Claude's discretion).
   - CRITICAL: Stop simulation when switching away from Force mode (`simulation.stop()`).

2. **Radial mode:**
   - Stop force simulation if running.
   - Create virtual root: `{ name: "root", children: types.map(...) }`.
   - `d3.tree().size([2 * Math.PI, radius])` where `radius = Math.min(width, height) / 2 - 80`.
   - Convert polar to Cartesian: `x = cx + r * cos(angle - PI/2)`, `y = cy + r * sin(angle - PI/2)`.
   - Animate nodes from current position to radial positions using `d3.transition().duration(500)`.
   - Edges rendered as arcs between nodes (not tree links -- overlay edge rendering using the relation data, not hierarchy parent-child).

3. **Hierarchy (Tree) mode:**
   - Stop force simulation if running.
   - Same virtual root approach.
   - `d3.tree().size([width - 120, height - 120])`.
   - Animate nodes from current position to tree positions using `d3.transition().duration(500)`.
   - Edges as overlay arcs (same as Radial).

**Edge Rendering:**
- Use curved arcs (`<path>`) for all edges, not straight lines. This prevents bidirectional edge overlap.
- Path generator: `M${sx},${sy} A${dr},${dr} 0 0,1 ${tx},${ty}` where `dr = Math.sqrt(dx*dx + dy*dy) * 1.2`.
- Each edge ends with arrowhead marker via `marker-end="url(#arrow-{id})"`.
- Edge color: use muted foreground color from CSS variables (via getComputedStyle or direct var reference).
- On hover: highlight edge with brighter color and show tooltip with relation name.

**Node Rendering:**
- Circles with radius proportional to `Math.sqrt(nodeCount) * 0.15 + 15` (clamped between 15-40px).
- Fill color from chart series palette (`--chart-1` through `--chart-6`), resolved via chart-theme.ts or direct CSS variable usage.
- Node label below circle (type name).
- Selected node: thicker stroke + subtle glow/ring.
- Click handler: call `onSelectType` prop.
- `data-testid="graph-node-{name}"` on each node group.

**Zoom/Pan:**
- `d3.zoom().scaleExtent([0.3, 3]).on("zoom", ...)` applied to SVG.
- Transforms the `g.zoom-group` element.
- CRITICAL: Store zoom transform in a ref and reapply after mode transitions to preserve user's zoom state. Per research Pitfall 2: do NOT reset zoom on React re-renders. Apply zoom behavior once in initial useEffect, not on every state change.

**Cleanup:**
- useEffect cleanup: stop simulation, remove zoom handlers, disconnect ResizeObserver.
- Use `cleanupD3Svg` from chart-utils for thorough SVG cleanup.

**Responsive sizing:**
- Use `createDebouncedResizeObserver` to get container dimensions.
- Recenter force simulation or recompute tree layout on resize.
- Per research Pitfall 6: only initialize graph after ResizeObserver reports valid dimensions (width > 0, height > 0).

Add `data-testid="ontology-graph"` on the container.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compilation. The component can be tested standalone by temporarily importing it in a test page or by verifying it renders when integrated in Plan 03. Key checks:
- No TypeScript errors
- All D3 imports resolve (d3-force, d3-hierarchy, d3-zoom, d3-selection, d3-drag, d3-transition)
- Chart utility imports resolve (createDebouncedResizeObserver, cleanupD3Svg)
  </verify>
  <done>OntologyGraph.tsx exports a working D3 graph component with Force/Radial/Hierarchy modes, zoom/pan, node drag, bidirectional edge arcs, edge filtering, and responsive sizing</done>
</task>

</tasks>

<verification>
- `npm run build` passes (or at minimum, the OntologyGraph.tsx file has no TypeScript errors when checked with `npx tsc --noEmit`)
- OntologyGraph component exports correctly
- All D3 sub-module imports are valid
- Component uses createDebouncedResizeObserver for responsive sizing
- Component includes cleanup in useEffect return (simulation stop, zoom handler removal, ResizeObserver disconnect)
- Three mode buttons render (Force/Radial/Hierarchy)
- SVG defs include arrow marker for directed edges
</verification>

<success_criteria>
- OntologyGraph renders 6 nodes with edges in an SVG
- Force mode: nodes positioned by simulation, draggable, zoom/pan works
- Radial mode: nodes arranged in circular pattern, animated transition from previous positions
- Hierarchy mode: nodes arranged in tree layout, animated transition
- Bidirectional edges render as separate curved arcs with arrowheads
- Edge filter prop controls which edges are visible
- Selected type node is visually highlighted
- Clicking a node triggers onSelectType callback
- Responsive to container resize
- Proper cleanup on unmount (no memory leaks from simulation/observers)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ontology-studio-user-mgmt/06-02-SUMMARY.md`
</output>
