---
phase: 06-ontology-studio-user-mgmt
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - src/components/charts/studio/TypeDistributionChart.tsx
  - src/components/users/UsersPage.tsx
  - src/components/users/UserTable.tsx
  - src/components/users/RoleBadge.tsx
  - src/components/users/RoleTooltip.tsx
  - src/app/admin/users/page.tsx
  - src/components/studio/StudioPage.tsx
  - src/app/layout.tsx
autonomous: true
requirements: [STUD-04, USER-01, USER-02, USER-03]

must_haves:
  truths:
    - "Type distribution bar chart renders records/queries for 6 types with Stacked/Grouped toggle"
    - "User table displays 5 users with username, email, role badge, and last login"
    - "4 role badges are color-coded (red/blue/gray/outline for super_admin/service_app/data_analyst/auditor)"
    - "Hovering a role badge shows Tooltip with PII access permission summary"
    - "Role dropdown in user table changes role in client state only (no DB persist)"
    - "OntologyGraph and TypeDistributionChart are wired into StudioPage replacing placeholders"
    - "RoleProvider wraps the app so role state is shared across pages"
  artifacts:
    - path: "src/components/charts/studio/TypeDistributionChart.tsx"
      provides: "D3 stacked/grouped bar chart for type distribution"
      exports: ["TypeDistributionChart"]
      min_lines: 100
    - path: "src/components/users/UserTable.tsx"
      provides: "User management table with role editing"
      min_lines: 60
    - path: "src/components/users/RoleBadge.tsx"
      provides: "Color-coded role badge component"
      exports: ["RoleBadge"]
      min_lines: 25
    - path: "src/components/users/RoleTooltip.tsx"
      provides: "Role permission description tooltip"
      exports: ["RoleTooltip"]
      min_lines: 25
    - path: "src/components/users/UsersPage.tsx"
      provides: "User management page orchestrator"
      min_lines: 30
    - path: "src/app/admin/users/page.tsx"
      provides: "Next.js route for /admin/users"
  key_links:
    - from: "src/components/charts/studio/TypeDistributionChart.tsx"
      to: "src/data/studio-data.ts"
      via: "calls getTypeDistribution() for chart data"
      pattern: "getTypeDistribution"
    - from: "src/components/users/UserTable.tsx"
      to: "src/utils/supabase/client.ts"
      via: "fetches users from Supabase users table"
      pattern: 'from.*"users".*select'
    - from: "src/components/users/UserTable.tsx"
      to: "src/contexts/RoleContext.tsx"
      via: "useRole hook for role change propagation (or local state per user)"
      pattern: "useRole|setCurrentRole"
    - from: "src/components/studio/StudioPage.tsx"
      to: "src/components/charts/studio/OntologyGraph.tsx"
      via: "imports and renders OntologyGraph in right panel top area"
      pattern: "OntologyGraph"
    - from: "src/app/layout.tsx"
      to: "src/contexts/RoleContext.tsx"
      via: "RoleProvider wraps children in root layout"
      pattern: "RoleProvider"
---

<objective>
Build TypeDistributionChart, the complete User Management page, and wire everything together -- integrating OntologyGraph and TypeDistributionChart into StudioPage, and wrapping the app with RoleProvider.

Purpose: Completes Phase 6 by delivering the remaining D3 chart (stacked/grouped bar), the User Management page with Supabase data and role badges, and the final integration of all components into their pages.

Output: 8 files -- TypeDistributionChart, 4 user management components, admin route, updated StudioPage, updated root layout.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ontology-studio-user-mgmt/06-CONTEXT.md
@.planning/phases/06-ontology-studio-user-mgmt/06-RESEARCH.md
@.planning/phases/06-ontology-studio-user-mgmt/06-01-SUMMARY.md
@.planning/phases/06-ontology-studio-user-mgmt/06-02-SUMMARY.md

@src/types/index.ts
@src/data/studio-data.ts
@src/data/pii-config.ts
@src/lib/pii-masking.ts
@src/utils/supabase/client.ts
@src/contexts/RoleContext.tsx
@src/components/studio/StudioPage.tsx
@src/components/charts/studio/OntologyGraph.tsx
@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: D3 TypeDistributionChart (stacked/grouped bar chart)</name>
  <files>src/components/charts/studio/TypeDistributionChart.tsx</files>
  <action>
Create `src/components/charts/studio/TypeDistributionChart.tsx` (`"use client"`).

**Props:**
```typescript
interface TypeDistributionChartProps {
  className?: string;
}
```

**Data source:** Call `getTypeDistribution()` from `@/data/studio-data` on mount. Returns `TypeDistributionItem[]` with `{ name, records, queries, color }` for each of the 6 ontology types.

**Chart layout:**
- Toggle bar at top: "Stacked" / "Grouped" buttons (similar style to OntologyGraph mode toggle).
- State: `const [barMode, setBarMode] = useState<"stacked" | "grouped">("stacked")`.
- SVG with proper margins (top: 20, right: 20, bottom: 40, left: 60).
- Use `createDebouncedResizeObserver` for responsive sizing.

**Stacked mode:**
- Use `d3.stack().keys(["records", "queries"])` to compute stacked layout.
- `scaleBand` for x-axis (type names), `scaleLinear` for y-axis (total).
- Two stacked series per bar: records (bottom, chart-1 color) and queries (top, chart-2 color).
- X-axis labels rotated -45deg if needed for long names like "MaintenanceRecord".

**Grouped mode:**
- Outer `scaleBand` for type names with `padding(0.2)`.
- Inner `scaleBand` for ["records", "queries"] series within each group, `padding(0.05)`.
- Side-by-side bars for each type.

**Transition:**
- When toggling between stacked and grouped: animate bars using `d3.transition().duration(500)`.
- Animate `x`, `y`, `width`, `height` attributes of each rect.

**Axes:**
- X-axis at bottom with type names.
- Y-axis at left with formatted numbers using `formatNumber` from chart-utils.

**Legend:**
- Small legend showing Records (chart-1 color) and Queries (chart-2 color) using colored circles + text.

**Tooltip:**
- On bar hover, show tooltip with type name, records count, queries count using `chart-tooltip.ts` pattern (or a simple div tooltip).

**Colors:**
- Use `--chart-1` for records series, `--chart-2` for queries series (resolved via CSS variables or chart-theme.ts).

**Cleanup:**
- useEffect cleanup: disconnect ResizeObserver, cleanupD3Svg.

Add `data-testid="type-distribution-chart"`.
  </action>
  <verify>Run `npm run build` to confirm compilation. Component should render a bar chart with 6 groups and stacked/grouped toggle.</verify>
  <done>TypeDistributionChart renders stacked bars by default with smooth animated transition to grouped mode, showing records and queries for all 6 ontology types</done>
</task>

<task type="auto">
  <name>Task 2: User Management page (UserTable, RoleBadge, RoleTooltip, UsersPage, route)</name>
  <files>
    src/components/users/RoleBadge.tsx
    src/components/users/RoleTooltip.tsx
    src/components/users/UserTable.tsx
    src/components/users/UsersPage.tsx
    src/app/admin/users/page.tsx
  </files>
  <action>
**RoleBadge.tsx** (`"use client"`):
- Props: `{ role: Role }`.
- Uses shadcn Badge with CVA (class-variance-authority) for role-specific styling:
  - `super_admin`: red variant (`bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400`)
  - `service_app`: blue variant (`bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400`)
  - `data_analyst`: gray variant (`bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300`)
  - `auditor`: outline variant (`border border-current bg-transparent text-muted-foreground`)
- Display labels: "Super Admin", "Service App", "Data Analyst", "Auditor".
- Add `data-testid="role-badge-{role}"`.

**RoleTooltip.tsx** (`"use client"`):
- Props: `{ role: Role; children: React.ReactNode }`.
- Wraps children with shadcn `Tooltip` + `TooltipTrigger` + `TooltipContent`.
- Tooltip content shows PII access permission summary per role:
  - `super_admin`: "Full access to all PII fields (Plain text)"
  - `service_app`: "API access, masked PII for phone/email"
  - `data_analyst`: "Masked names/emails, denied phone/address"
  - `auditor`: "Read-only audit, denied all PII fields"
- Tooltip appears on hover with slight delay.
- Add `data-testid="role-tooltip-{role}"`.

**UserTable.tsx** (`"use client"`):
- Fetches user data from Supabase `users` table on mount using `createBrowserClient` from `@/utils/supabase/client`.
  - Query: `supabase.from("users").select("id, username, email, role, last_login").order("id")`.
  - Map snake_case DB fields to camelCase: `last_login -> lastLogin` (per Phase 1 decision: snake_case in DB, camelCase in TS).
- Shows loading skeleton (shadcn Skeleton) while fetching.
- Uses shadcn Table with columns: Username, Email, Role, Last Login.
- Each row:
  - Username and email as text.
  - Role column: RoleBadge wrapped in RoleTooltip. Additionally, show a small shadcn Select dropdown next to or replacing the badge that allows changing the role to any of the 4 options (super_admin/service_app/data_analyst/auditor).
  - Last Login: formatted as relative time (e.g., "2 hours ago") or absolute date string.
- Role change: updates the user's role in LOCAL STATE only (no Supabase update per user decision -- POC). Use component-level state `useState<User[]>(...)` and update the specific user's role in the array.
- Per user decision: "역할 변경은 클라이언트 상태에서만 반영 (POC이므로 DB 저장 불필요)".
- Per user decision: "Query Console의 PII 마스킹과 연동 가능하도록 역할 상태 공유" -- when a user's role is changed via the dropdown, also call `setCurrentRole` from `useRole()` context to update the global "viewing as" role state. The global role reflects the most recently changed role (simulating "viewing as this role").
- Add `data-testid="user-table"`.

**UsersPage.tsx** (`"use client"`):
- Renders a page header ("User Management" title, brief description).
- Renders UserTable.
- Wraps content in a container with consistent padding.
- Add `data-testid="users-page"`.

**page.tsx** (route, minimal server component):
```tsx
import { UsersPage } from "@/components/users/UsersPage";

export default function UsersRoute() {
  return <UsersPage />;
}
```

Ensure `src/app/admin/users/` directory is created. Route: `/admin/users`.

IMPORTANT: Wrap UserTable (or UsersPage) in a shadcn `TooltipProvider` if not already provided at a higher level, since RoleTooltip uses Tooltip which requires it.
  </action>
  <verify>
Run `npm run build`. Visit `/admin/users` in dev mode. Verify:
- Table loads 5 users from Supabase (or shows loading skeleton then data).
- Role badges are color-coded per role.
- Hovering a role badge shows tooltip with PII permission summary.
- Role dropdown allows changing a user's role (client-state only).
  </verify>
  <done>User Management page at /admin/users shows 5 users with color-coded role badges, permission tooltips, and client-side role editing via dropdown</done>
</task>

<task type="auto">
  <name>Task 3: Final integration -- wire graphs into StudioPage + RoleProvider in root layout</name>
  <files>
    src/components/studio/StudioPage.tsx
    src/app/layout.tsx
  </files>
  <action>
**StudioPage.tsx** (modify existing from Plan 01):
- Replace the right-panel placeholder divs with actual component imports:
  - Top: `<OntologyGraph types={types} selectedType={selectedType} onSelectType={setSelectedType} edgeFilter={edgeFilter} />` from `@/components/charts/studio/OntologyGraph`.
  - Bottom: `<TypeDistributionChart />` from `@/components/charts/studio/TypeDistributionChart`.
- Remove the placeholder Card/dashed-border elements.
- Ensure the OntologyGraph receives the correct props: `types`, `selectedType`, `onSelectType` (to sync selection between TypeList clicks and graph node clicks), and `edgeFilter`.
- The right panel should give the OntologyGraph roughly 60% of vertical space and TypeDistributionChart roughly 40%. Use flex-1 / flex ratios or explicit height splits.

**layout.tsx** (modify existing root layout):
- Import `RoleProvider` from `@/contexts/RoleContext`.
- Wrap the children (inside ThemeProvider) with `<RoleProvider>`:
  ```tsx
  <ThemeProvider ...>
    <RoleProvider>
      {children}
    </RoleProvider>
  </ThemeProvider>
  ```
- This makes `useRole()` available to all pages including both User Management and the future Query Console (Phase 7).
- Also wrap with `<TooltipProvider>` from shadcn (if not already present) so Tooltips work globally. Import from `@/components/ui/tooltip`.

IMPORTANT: Read the current layout.tsx carefully before modifying. Preserve all existing providers (ThemeProvider, etc.) and structure. Only add RoleProvider and TooltipProvider as additional wrappers.
  </action>
  <verify>
Run `npm run build`. Visit `/workspace/studio` -- should now show the full 2-panel layout with OntologyGraph (interactive D3 graph) in the top-right and TypeDistributionChart (bar chart) in the bottom-right. Visit `/admin/users` -- user table should work with role tooltips. Verify no build errors.
  </verify>
  <done>StudioPage displays OntologyGraph and TypeDistributionChart (no more placeholders). RoleProvider and TooltipProvider wrap the app in root layout. Both /workspace/studio and /admin/users routes fully functional.</done>
</task>

</tasks>

<verification>
- `npm run build` passes without errors
- `/workspace/studio` shows complete 2-panel layout:
  - Left: TypeList + TypeDetail with edge filter
  - Right top: Interactive OntologyGraph (Force mode default, switchable to Radial/Hierarchy)
  - Right bottom: TypeDistributionChart with Stacked/Grouped toggle
- `/admin/users` shows user table with 5 users, role badges, tooltips, role dropdown
- Role change in user table updates client state
- RoleProvider wraps the entire app (verifiable by useRole() not throwing in any page)
- TypeDistributionChart toggles between stacked and grouped with animation
- All data-testid attributes present for interactive elements
</verification>

<success_criteria>
- TypeDistributionChart renders 6 types with records/queries bars, Stacked/Grouped toggle animates transition
- User table fetches 5 users from Supabase with username, email, role badge, last login
- 4 role badges correctly color-coded: red (super_admin), blue (service_app), gray (data_analyst), outline (auditor)
- Tooltip on role badge hover shows PII permission summary text
- Role dropdown changes role in client state (no DB write)
- OntologyGraph and TypeDistributionChart integrated into StudioPage (no placeholders remain)
- RoleProvider available app-wide via root layout
- Both pages (/workspace/studio and /admin/users) render without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-ontology-studio-user-mgmt/06-03-SUMMARY.md`
</output>
