---
phase: 08-product-ux-refinement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/gpu/GpuFunnelChart.tsx
  - src/components/gpu/GpuDetailPanel.tsx
  - src/components/gpu/GpuThresholdForm.tsx
  - src/app/(authenticated)/monitoring/gpu/page.tsx
  - src/data/gpu-data.ts
autonomous: true
requirements:
  - UXR-02

must_haves:
  truths:
    - "GPU funnel chart shows Total > Allocated > Active > Effective pipeline as a visual funnel"
    - "Clicking a GPU card opens a right slide panel with detailed GPU metrics and process drilldown"
    - "Alert threshold form allows setting warning/critical thresholds per metric (UI only, mock save)"
    - "GPU comparison mode allows selecting 2-4 GPUs and overlaying their metrics on the same time axis"
  artifacts:
    - path: "src/components/gpu/GpuFunnelChart.tsx"
      provides: "CSS clip-path funnel chart for GPU pipeline"
      min_lines: 30
    - path: "src/components/gpu/GpuDetailPanel.tsx"
      provides: "Sheet-based slide panel with GPU details and process table"
      min_lines: 50
    - path: "src/components/gpu/GpuThresholdForm.tsx"
      provides: "Threshold setting form per metric with warning/critical inputs"
      min_lines: 40
    - path: "src/app/(authenticated)/monitoring/gpu/page.tsx"
      provides: "Extended GPU page with funnel, detail panel, threshold form, comparison mode"
      contains: "GpuFunnelChart"
  key_links:
    - from: "src/app/(authenticated)/monitoring/gpu/page.tsx"
      to: "src/components/gpu/GpuDetailPanel.tsx"
      via: "Sheet open state triggered by GPU card click"
      pattern: "selectedGpu|setSelectedGpu"
    - from: "src/components/gpu/GpuDetailPanel.tsx"
      to: "src/data/gpu-data.ts"
      via: "GPU data + process data import"
      pattern: "getGpuProcesses|getGpuData"
---

<objective>
Extend GPU Monitoring with a pipeline funnel chart, detail slide panel, alert threshold settings form, and enhanced comparison mode.

Purpose: Transform GPU Monitoring from a status overview into a full operational analysis tool with drill-down capabilities and alerting configuration.
Output: 3 new GPU components + extended page integration.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@src/app/(authenticated)/monitoring/gpu/page.tsx
@src/components/gpu/GpuCard.tsx
@src/components/gpu/GpuComparisonBar.tsx
@src/data/gpu-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GpuFunnelChart and GpuThresholdForm components</name>
  <files>
    src/components/gpu/GpuFunnelChart.tsx
    src/components/gpu/GpuThresholdForm.tsx
    src/data/gpu-data.ts
  </files>
  <action>
1. **GpuFunnelChart.tsx** (`"use client"`):
   - CSS clip-path approach (Claude's Discretion from research — simpler than D3 SVG).
   - Props: `{ stages: { label: string; value: number; color: string }[] }` or use hardcoded GPU pipeline stages.
   - 4 stages: Total GPUs (4) > Allocated (3) > Active (2) > Effective (1) — mock data.
   - Each stage is a div with:
     - Width proportional to value: `width: ${(stage.value / maxValue) * 100}%`
     - Centered horizontally with `mx-auto`
     - Background color from CSS variable (--chart-1 through --chart-4)
     - `clip-path: polygon(5% 0, 95% 0, 100% 100%, 0% 100%)` for trapezoid shape
     - Label + value text inside
   - Stages stacked vertically with small gaps
   - Wrap in Card with "GPU Pipeline" title

2. **GpuThresholdForm.tsx** (`"use client"`):
   - Props: none (self-contained form with internal state)
   - 4 metric rows: Utilization, Temperature, Memory, Power
   - Each row: metric label + warning input (number) + critical input (number) + unit label
   - Use shadcn `Input` (number type), `Label`, `Button`
   - "Save" button shows `toast.success("Thresholds saved (mock)")` from sonner
   - Internal state: `useState` with default thresholds (utilization: warn=80/crit=95, temp: warn=75/crit=85, memory: warn=85/crit=95, power: warn=250/crit=300)
   - Wrap in Card with "Alert Thresholds" title
   - Note: UI only, no actual alert triggering (per user decision: mock save)

3. **Extend `src/data/gpu-data.ts`**:
   - Add `getGpuFunnelData()` returning `{ label: string; value: number; color: string }[]` for 4 funnel stages
   - Add `getGpuDetailData(gpuId: string)` returning extended GPU metrics: DCGM fields (SM Clock, Memory Clock, PCIe TX/RX bandwidth, ECC errors) as mock values
  </action>
  <verify>
    - Both component files exist
    - `npx tsc --noEmit` passes
    - GpuFunnelChart renders 4 trapezoid stages
    - GpuThresholdForm has 4 metric rows with input fields
  </verify>
  <done>GpuFunnelChart displays visual pipeline funnel with 4 stages; GpuThresholdForm provides warning/critical threshold inputs for 4 metrics; gpu-data.ts extended with funnel and detail data</done>
</task>

<task type="auto">
  <name>Task 2: Create GpuDetailPanel and wire everything into GPU page</name>
  <files>
    src/components/gpu/GpuDetailPanel.tsx
    src/app/(authenticated)/monitoring/gpu/page.tsx
  </files>
  <action>
1. **GpuDetailPanel.tsx** (`"use client"`):
   - Props: `{ gpu: GpuData | null; processes: GpuProcess[]; onClose: () => void }`
   - Uses shadcn `Sheet`, `SheetContent`, `SheetHeader`, `SheetTitle` (same pattern as DGraph NodeDetailPanel from Phase 4)
   - Panel content when gpu is provided:
     - GPU model/name header
     - Key metrics grid: Utilization%, Temperature, Memory Used/Total, Power Draw
     - DCGM extended metrics section: SM Clock, Memory Clock, PCIe bandwidth, ECC errors (from getGpuDetailData)
     - Process table: PID, Command, State, User, Age, Core Utilization, Memory Utilization
       - Reuse GpuProcessesTable data format but display inline in the panel
     - Status badge (healthy/warning/error) with color coding
   - Sheet opens from right side, width ~[450px]
   - ScrollArea for content overflow

2. **Update `src/app/(authenticated)/monitoring/gpu/page.tsx`**:
   - Add state: `const [selectedGpu, setSelectedGpu] = useState<string | null>(null)`
   - Add state: `const [comparisonGpus, setComparisonGpus] = useState<string[]>([])`
   - Add state: `const [showThresholds, setShowThresholds] = useState(false)`

   - GPU card click handler: `onClick={() => setSelectedGpu(gpu.id)}`
     - Pass click handler to GpuCardGrid or directly to GpuCard components

   - Add GpuFunnelChart below GpuSummaryHeader (before the card grid)
   - Add GpuThresholdForm in a collapsible section (Button toggle + conditional render)
   - Add GpuDetailPanel as Sheet controlled by selectedGpu state

   - GPU comparison mode: Add multi-select checkboxes on GPU cards
     - When 2+ GPUs selected, show a comparison overlay section using existing GpuComparisonBar with filtered data
     - Toggle buttons or checkboxes on each GPU card for selection

   - Page layout order:
     1. GpuSummaryHeader (existing)
     2. GpuFunnelChart (new)
     3. GpuCardGrid (existing, with click + select handlers)
     4. GpuPerformanceTrend (existing)
     5. GpuHeatmapRidgelineToggle (existing)
     6. GpuComparisonBar (existing, filtered by selection)
     7. GpuHealthIssues (existing)
     8. GpuProcessesTable (existing)
     9. GpuThresholdForm (new, toggle)
     10. GpuDetailPanel Sheet (new, slide from right)
  </action>
  <verify>
    - GpuDetailPanel.tsx exists with Sheet usage
    - GPU page imports GpuFunnelChart, GpuDetailPanel, GpuThresholdForm
    - `npm run build` succeeds
    - Page has selectedGpu state management
  </verify>
  <done>GPU page extended with funnel chart, click-to-detail slide panel, threshold form, and comparison mode selection; all existing components preserved and new ones integrated</done>
</task>

</tasks>

<verification>
- 3 new GPU component files exist
- GPU page imports and renders all new components
- `npm run build` passes
- gpu-data.ts has new data functions
</verification>

<success_criteria>
- Funnel chart visually shows GPU pipeline (Total > Allocated > Active > Effective)
- Clicking GPU card opens right slide panel with detailed metrics and processes
- Threshold form shows 4 metric rows with warning/critical inputs and mock save
- Comparison mode allows selecting GPUs for overlay comparison
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-03-SUMMARY.md`
</output>
