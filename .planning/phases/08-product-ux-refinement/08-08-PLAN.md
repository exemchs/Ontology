---
phase: 08-product-ux-refinement
plan: 08
type: execute
wave: 2
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - src/app/(authenticated)/page.tsx
  - src/components/query/ChatbotPanel.tsx
  - src/components/query/QueryConsole.tsx
autonomous: true
requirements:
  - UXR-01
  - UXR-05

must_haves:
  truths:
    - "Dashboard page renders the DashboardGrid with all 13 widgets in a draggable grid"
    - "Dashboard has no tabs — single unified view"
    - "Old dashboard charts (MetricCard, gauges, line chart, scatter, bar, chord/force/sankey) are replaced"
    - "Chatbot floating panel is toggleable (show/hide) with a text input and mock responses"
    - "Chatbot is accessible from Query Console as a tab and as a global floating popup"
  artifacts:
    - path: "src/app/(authenticated)/page.tsx"
      provides: "Dashboard page rendering DashboardGrid"
      contains: "DashboardGrid"
    - path: "src/components/query/ChatbotPanel.tsx"
      provides: "Floating chatbot popup with text input and mock responses"
      min_lines: 50
  key_links:
    - from: "src/app/(authenticated)/page.tsx"
      to: "src/components/dashboard/DashboardGrid.tsx"
      via: "Component import and render"
      pattern: "DashboardGrid"
    - from: "src/components/query/ChatbotPanel.tsx"
      to: "src/components/query/QueryConsole.tsx"
      via: "Chatbot toggle button in console + floating panel"
      pattern: "ChatbotPanel|showChatbot"
---

<objective>
Wire the DashboardGrid into the main page (replacing the old dashboard), create the chatbot floating popup for Query Console, and finalize the dashboard + query console integration.

Purpose: This plan completes the dashboard overhaul by replacing the old static page and adds the chatbot as the final Query Console feature.
Output: Rebuilt dashboard page, chatbot floating panel with toggle.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@.planning/phases/08-product-ux-refinement/08-01-SUMMARY.md
@.planning/phases/08-product-ux-refinement/08-02-SUMMARY.md
@src/app/(authenticated)/page.tsx
@src/components/query/QueryConsole.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace dashboard page with DashboardGrid</name>
  <files>
    src/app/(authenticated)/page.tsx
  </files>
  <action>
Complete replacement of `src/app/(authenticated)/page.tsx`:

1. Remove ALL existing dashboard content — the old page has:
   - MetricCard imports (4 cards)
   - ResourceGauge (3 gauges)
   - DualLineChart
   - NodeScatterPlot
   - ResourceBarChart
   - OntologyRelationChart (Chord/Force/Sankey)
   - RecentAlerts
   - All the dashboard-data function calls at module scope
   - The grid layout with all card containers

2. Replace with a clean page that imports and renders DashboardGrid:
   ```tsx
   "use client";

   import { DashboardGrid } from "@/components/dashboard/DashboardGrid";

   export default function DashboardPage() {
     return (
       <div className="flex flex-1 flex-col gap-4 p-4">
         <div className="flex items-center justify-between">
           <div>
             <h1 className="text-2xl font-bold">Dashboard</h1>
             <p className="text-sm text-muted-foreground">
               Dgraph cluster overview — drag widgets to customize layout
             </p>
           </div>
         </div>
         <DashboardGrid />
       </div>
     );
   }
   ```

3. The page should be minimal — DashboardGrid handles ALL widget rendering, layout persistence, and reset functionality.

4. Keep `"use client"` directive (DashboardGrid is client-side).

5. **Note**: The old dashboard chart components (DualLineChart, ResourceGauge, NodeScatterPlot, etc.) remain in `src/components/charts/dashboard/` for potential reuse but are no longer imported by the page. Do NOT delete them — they may be useful as reference or in other contexts.

6. Verify no GPU tab — dashboard is a single unified view (per user decision: GPU tab removed, single dashboard).
  </action>
  <verify>
    - `src/app/(authenticated)/page.tsx` imports DashboardGrid
    - No imports of old chart components (ResourceGauge, DualLineChart, etc.)
    - `npm run build` succeeds
    - Page renders as a single view (no tabs)
  </verify>
  <done>Dashboard page completely replaced with DashboardGrid; single unified view with no tabs; all 13 widgets rendered in draggable grid; old chart components preserved but not imported</done>
</task>

<task type="auto">
  <name>Task 2: Create ChatbotPanel and integrate into Query Console</name>
  <files>
    src/components/query/ChatbotPanel.tsx
    src/components/query/QueryConsole.tsx
  </files>
  <action>
1. **ChatbotPanel.tsx** (`"use client"`):
   - A floating popup panel that can be shown/hidden with a toggle button.
   - Props: `{ isOpen: boolean; onToggle: () => void }`

   - Panel design:
     - Fixed position (bottom-right corner of screen): `fixed bottom-4 right-4 w-80 h-96`
     - Card with shadow-lg, rounded corners, z-50
     - Header: "Natural Language Query" title + close button (X icon)
     - Chat area: scrollable div showing conversation messages
     - Input area: text input + send button at bottom

   - Mock conversation:
     - Hardcoded initial message: "Ask me about your ontology schema in natural language. I'll help you write queries."
     - On user message submit:
       - Show user message in chat
       - After 500ms delay, show mock AI response based on simple keyword matching:
         - If contains "equipment" → "Try this query: `{ queryEquipment(func: has(equipment_id)) { uid equipment_id name } }`"
         - If contains "wafer" → "Here's a wafer query: `{ queryWafer(func: has(wafer_id)) { uid wafer_id status } }`"
         - Default → "I can help with queries about Equipment, Process, Wafer, Defect, Recipe, and Measurement types. Try asking about a specific type!"
     - Messages stored in useState array: `{ role: 'user' | 'assistant'; content: string }[]`

   - Toggle button (for embedding in other pages):
     - Small floating circle button with MessageCircle icon from lucide
     - Fixed bottom-right when panel is closed
     - Shows unread indicator dot

   - **Key UX**: The toggle (show/hide) is the core deliverable. The chatbot content is mock-only, no real LLM call (per research).

2. **Update QueryConsole.tsx**:
   - Add chatbot toggle state: `const [showChatbot, setShowChatbot] = useState(false)`
   - Add a "Natural Language" tab or button in the query area that opens ChatbotPanel
   - Render `<ChatbotPanel isOpen={showChatbot} onToggle={() => setShowChatbot(!showChatbot)} />`
   - The panel floats above the console content (not embedded in layout)

3. **Global floating popup consideration**:
   - ChatbotPanel is rendered at the QueryConsole level for POC
   - The fixed positioning makes it appear global (visible on top of everything)
   - For true global access, it would go in the authenticated layout — but for POC, Query Console is sufficient
   - Add a small toggle button (MessageCircle icon) in the query console header area
  </action>
  <verify>
    - ChatbotPanel.tsx exists with floating panel design
    - QueryConsole renders ChatbotPanel with toggle
    - Panel shows/hides on toggle button click
    - Mock responses appear after user messages
    - `npm run build` succeeds
  </verify>
  <done>ChatbotPanel renders as floating popup with text input and mock keyword-based responses; toggle button shows/hides panel; integrated into QueryConsole with Natural Language button</done>
</task>

</tasks>

<verification>
- Dashboard page imports only DashboardGrid (no old chart imports)
- ChatbotPanel.tsx exists with mock conversation
- `npm run build` passes
- Dashboard renders single unified view
- Chatbot panel toggles show/hide
</verification>

<success_criteria>
- Dashboard page shows DashboardGrid with 13 draggable widgets
- No GPU tab — single dashboard view
- Old dashboard chart components not imported (kept as files)
- Chatbot floating panel opens/closes via toggle
- Mock AI responses appear for query-related questions
- Chatbot accessible from Query Console
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-08-SUMMARY.md`
</output>
