---
phase: 08-product-ux-refinement
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/query/QueryConsole.tsx
  - src/components/query/QueryEditor.tsx
  - src/components/query/ResultViewBar.tsx
  - src/components/query/GraphPanelViewSelector.tsx
  - src/components/query/ResultTabs.tsx
  - src/components/query/SchemaExplorer.tsx
  - src/components/query/QueryHistory.tsx
  - src/lib/query-export.ts
autonomous: true
requirements:
  - UXR-05

must_haves:
  truths:
    - "Treemap, Arc Diagram, Scatter, and Distribution views are removed from Query Console"
    - "Only Graph (Node-Link) and Table views remain in the result view bar"
    - "Left panel has a schema explorer tree with types and predicates that insert into query on click"
    - "CodeMirror editor has schema-aware autocompletion for type and predicate names"
    - "Query history panel shows recent queries with re-execute capability"
    - "CSV and JSON export buttons download result data as files"
    - "Result tab badges show 'Nodes: N / Records: N' count"
    - "Graph view has type filter toggles to show/hide specific types"
  artifacts:
    - path: "src/components/query/SchemaExplorer.tsx"
      provides: "Schema tree panel with click-to-insert for query editor"
      min_lines: 50
    - path: "src/lib/query-export.ts"
      provides: "CSV and JSON export utility functions"
      exports: ["exportJson", "exportCsv"]
    - path: "src/components/query/QueryConsole.tsx"
      provides: "Restructured query console with 2 views and new features"
      contains: "SchemaExplorer"
    - path: "src/components/query/ResultViewBar.tsx"
      provides: "Simplified view bar with only Graph + Table"
  key_links:
    - from: "src/components/query/SchemaExplorer.tsx"
      to: "src/components/query/QueryEditor.tsx"
      via: "Callback to insert text at cursor position"
      pattern: "onInsert|insertText"
    - from: "src/components/query/QueryEditor.tsx"
      to: "@codemirror/autocomplete"
      via: "autocompletion extension with schema source"
      pattern: "autocompletion|schemaCompletionSource"
---

<objective>
Restructure Query Console: remove 4 visualization views, simplify to Graph+Table, add schema explorer with click-to-insert, CodeMirror autocompletion, query history, CSV/JSON export, result count badges, and graph type filtering.

Purpose: Transform the Query Console from a multi-view demo into a focused, productivity-oriented query tool with schema exploration and export capabilities.
Output: Schema explorer, autocompletion, export utilities, cleaned-up view system.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@src/components/query/QueryConsole.tsx
@src/components/query/QueryEditor.tsx
@src/components/query/ResultViewBar.tsx
@src/components/query/GraphPanelViewSelector.tsx
@src/components/query/views/ForceGraphView.tsx
@src/components/query/views/TableView.tsx
@src/data/studio-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove 4 views, create export utilities, and simplify view system</name>
  <files>
    src/components/query/ResultViewBar.tsx
    src/components/query/GraphPanelViewSelector.tsx
    src/components/query/QueryConsole.tsx
    src/components/query/ResultTabs.tsx
    src/lib/query-export.ts
  </files>
  <action>
**CRITICAL ORDER: Remove imports FIRST, then delete files.**

1. **Create `src/lib/query-export.ts`**:
   - `exportJson(data: Record<string, unknown>[], filename: string)`: Blob + URL.createObjectURL + anchor click (pattern from research)
   - `exportCsv(data: Record<string, unknown>[], filename: string)`: CSV header + rows + Blob download
   - Both handle empty data gracefully (return early if data.length === 0)

2. **Update `src/components/query/QueryConsole.tsx`**:
   - Remove imports for: TreemapView, ArcDiagramView, ScatterView, DistributionView
   - Remove any render conditions/cases for these 4 views
   - Remove PiiDemo import references if the "Treemap" was a PII view (check carefully)
   - Keep: ForceGraphView, TableView imports and rendering
   - Add import for exportJson, exportCsv from `@/lib/query-export`
   - Add export buttons (CSV/JSON) in the result area toolbar
   - Add result count badges: compute node count and record count from active tab data, display as "Nodes: N / Records: N" badge in tab headers

3. **Update `src/components/query/ResultViewBar.tsx`**:
   - Remove view options for Treemap, Arc, Scatter, Distribution
   - Keep only: "Table" and "Graph" view toggles
   - Simplify the toggle UI to 2 buttons

4. **Update `src/components/query/GraphPanelViewSelector.tsx`**:
   - If this component handles the 6-view tab bar, reduce to 2 views (Graph + Table)
   - Or remove this component entirely if ResultViewBar handles view switching

5. **Update `src/components/query/ResultTabs.tsx`**:
   - Add "Nodes: N / Records: N" badge to each tab label
   - Compute from tab.data: records = data.length, nodes = unique types/entities count

6. **Delete view files** (after all imports are removed):
   - `src/components/query/views/TreemapView.tsx`
   - `src/components/query/views/ArcDiagramView.tsx`
   - `src/components/query/views/ScatterView.tsx`
   - `src/components/query/views/DistributionView.tsx`

7. **Add Graph view type filter** to ForceGraphView or as an overlay:
   - Checkboxes/toggles for each type present in the graph data
   - Toggling off a type hides those nodes and their edges
   - State managed in QueryConsole, passed to ForceGraphView as `hiddenTypes: string[]` prop
  </action>
  <verify>
    - Deleted view files no longer exist: `ls src/components/query/views/` shows only ForceGraphView.tsx and TableView.tsx
    - `npm run build` succeeds (no broken imports)
    - ResultViewBar shows only 2 view options
    - query-export.ts exports exportJson and exportCsv
  </verify>
  <done>4 view files deleted, view system simplified to Graph+Table, export utilities created, result count badges added, graph type filter implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create SchemaExplorer and add CodeMirror autocompletion</name>
  <files>
    src/components/query/SchemaExplorer.tsx
    src/components/query/QueryEditor.tsx
    src/components/query/QueryConsole.tsx
  </files>
  <action>
1. **SchemaExplorer.tsx** (`"use client"`):
   - Props: `{ onInsert: (text: string) => void }`
   - Fetches types from `getOntologyTypes()` (from `@/data/studio-data`)
   - Renders a collapsible tree (similar pattern to StudioPage's SchemaTreeView but focused on query insertion):
     - Each type: clickable, inserts type name at cursor
     - Each predicate under type: clickable, inserts predicate name
     - Each relation: clickable, inserts relation name
   - Visual: compact tree with small icons (Type: Box icon, Predicate: Hash icon, Relation: ArrowRight icon)
   - Click action: calls `onInsert(text)` where text is the clicked type/predicate/relation name
   - Search/filter input at top
   - Card wrapper with "Schema" title
   - Max-height scroll for long lists

2. **Update QueryEditor.tsx** for autocompletion:
   - Import `autocompletion` from `@codemirror/autocomplete` (already bundled with @uiw/react-codemirror)
   - Import `CompletionContext` type
   - Create `schemaCompletionSource` function:
     - Build completions from `getOntologyTypes()`: type names (type: "type") + predicate names (type: "property") + relation names (type: "property")
     - Match word before cursor with `context.matchBefore(/\w*/)`
     - Return matching completions
   - Add `autocompletion({ override: [schemaCompletionSource] })` to the extensions array
   - Handle mode awareness: enable for GraphQL mode, simplify for DQL mode (only keywords)
   - **Pitfall avoidance**: If cm6-graphql provides its own completion, use `addToOptions` instead of `override` to avoid conflicts. Test and adjust.

3. **Update QueryEditor.tsx** for insert-at-cursor:
   - Expose a ref or callback to allow SchemaExplorer to insert text at cursor position
   - Use CodeMirror's `view.dispatch({ changes: { from: cursor, insert: text } })` API
   - Pass the insert function up to QueryConsole via ref or callback prop
   - `onInsertRef` pattern: `useImperativeHandle` to expose an `insertText(text: string)` method

4. **Update QueryConsole.tsx**:
   - Add SchemaExplorer to the left side of the console layout
   - Create a resizable split: SchemaExplorer (left, ~25% width) | Editor+Results (right, ~75% width)
   - Wire SchemaExplorer's `onInsert` to QueryEditor's `insertText`
   - Add query history with re-execute: update existing QueryHistory component to support re-execution (pass a callback that sets the editor content and re-runs)
  </action>
  <verify>
    - SchemaExplorer.tsx exists with tree structure
    - QueryEditor.tsx has autocompletion extension
    - QueryConsole renders SchemaExplorer in left panel
    - `npm run build` succeeds
  </verify>
  <done>SchemaExplorer tree renders with click-to-insert; CodeMirror autocompletion suggests type/predicate names; QueryConsole has left panel explorer with editor+results on right; query history supports re-execute</done>
</task>

</tasks>

<verification>
- Only ForceGraphView.tsx and TableView.tsx remain in views/
- SchemaExplorer.tsx exists with tree + click-to-insert
- QueryEditor.tsx has `autocompletion` extension import
- query-export.ts exports CSV/JSON functions
- ResultTabs shows node/record count badges
- `npm run build` passes with no broken imports
</verification>

<success_criteria>
- 4 old view files deleted, no broken imports
- Result view bar shows only Graph and Table
- Schema explorer tree visible in left panel with click-to-insert
- CodeMirror suggests type/predicate names on typing
- CSV/JSON export buttons download result data
- Tab badges show "Nodes: N / Records: N"
- Graph view allows filtering by type
- Query history allows re-execution
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-06-SUMMARY.md`
</output>
