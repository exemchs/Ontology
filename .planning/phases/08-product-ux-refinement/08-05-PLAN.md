---
phase: 08-product-ux-refinement
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/studio/SchemaTreeView.tsx
  - src/components/studio/OntologyMinimap.tsx
  - src/components/studio/SchemaHealthScore.tsx
  - src/components/studio/StudioPage.tsx
  - src/components/charts/studio/OntologyGraph.tsx
  - src/components/charts/studio/TypeDistributionTreemap.tsx
  - src/data/studio-data.ts
autonomous: true
requirements:
  - UXR-04

must_haves:
  truths:
    - "Left panel has a collapsible schema tree view with types > predicates/relations hierarchy"
    - "Right-click on tree items shows a context menu with actions"
    - "Graph area has a minimap in the lower-right corner showing viewport position"
    - "Schema health score badge shows 0-100 score with orphan/empty type detection"
    - "Records by Type uses a Treemap visualization instead of the existing bar chart"
    - "Hub type Top 5 and relation density metrics are displayed"
  artifacts:
    - path: "src/components/studio/SchemaTreeView.tsx"
      provides: "Collapsible tree with types > predicates/relations and context menu"
      min_lines: 60
    - path: "src/components/studio/OntologyMinimap.tsx"
      provides: "D3 minimap overlay showing graph viewport"
      min_lines: 40
    - path: "src/components/studio/SchemaHealthScore.tsx"
      provides: "Health score computation and display badge"
      min_lines: 30
    - path: "src/components/charts/studio/TypeDistributionTreemap.tsx"
      provides: "D3 treemap visualization for Records by Type"
      min_lines: 50
    - path: "src/components/studio/StudioPage.tsx"
      provides: "Extended studio layout with tree view, minimap, health score, treemap"
      contains: "SchemaTreeView"
  key_links:
    - from: "src/components/studio/SchemaHealthScore.tsx"
      to: "src/data/studio-data.ts"
      via: "getOntologyTypes() for health computation"
      pattern: "getOntologyTypes|computeHealthScore"
    - from: "src/components/studio/OntologyMinimap.tsx"
      to: "src/components/charts/studio/OntologyGraph.tsx"
      via: "Shared zoom transform state for viewport tracking"
      pattern: "zoomTransform|onZoomChange"
---

<objective>
Extend Ontology Studio with a schema tree view, graph minimap, health score badge, orphan/empty type detection, relation statistics, and a treemap visualization for Records by Type.

Purpose: Makes the ontology schema explorable through multiple interfaces (tree, graph, minimap) and adds quality metrics (health score, orphan detection) for schema governance.
Output: 4 new components + StudioPage and OntologyGraph extensions.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@src/components/studio/StudioPage.tsx
@src/components/charts/studio/OntologyGraph.tsx
@src/data/studio-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SchemaTreeView and SchemaHealthScore components</name>
  <files>
    src/components/studio/SchemaTreeView.tsx
    src/components/studio/SchemaHealthScore.tsx
    src/data/studio-data.ts
  </files>
  <action>
1. **SchemaTreeView.tsx** (`"use client"`):
   - Props: `{ types: OntologyType[]; selectedType: string | null; onSelectType: (name: string) => void }`
   - Renders a collapsible tree hierarchy:
     - Level 0: Each OntologyType as a tree root node (icon: Workflow from lucide)
     - Level 1a: "Predicates" group → individual predicates as leaves
     - Level 1b: "Relations" group → individual relations as leaves (show target type name)
   - Use shadcn `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent` for expand/collapse.
   - Or implement with recursive `<details>/<summary>` or custom div with ChevronRight/ChevronDown toggle.
   - Selected type highlighted with primary background.
   - Clicking a type name calls `onSelectType(typeName)`.

   - Right-click context menu (shadcn `ContextMenu`):
     - On type node: "View Details", "Edit Type", "Expand All"
     - On predicate: "Copy Name", "Filter by Predicate"
     - On relation: "Navigate to Target", "Copy Name"
     - Actions are UI-only (toast message on click, no real functionality needed for POC)

   - Scroll behavior: max-height with overflow-auto for long type lists.
   - Include a search/filter input at the top: `Input` with placeholder "Filter types..." that filters the tree.

2. **SchemaHealthScore.tsx** (`"use client"`):
   - Props: `{ types: OntologyType[] }`
   - Implements `computeHealthScore(types)` function (from research):
     - Orphan detection: types with no outbound relations AND not referenced by any other type's relations
     - Empty detection: types with nodeCount === 0
     - Score: `max(0, 100 - (orphans.length * 15) - (empties.length * 10))`
   - Renders:
     - Large score number (color: green >= 80, amber >= 50, red < 50)
     - Badge with "Healthy" / "Warning" / "Critical" text
     - Orphan types list (if any) with warning icon
     - Empty types list (if any) with info icon
     - Relation density: total relations / total types (formatted to 1 decimal)
     - Hub Type Top 5: types sorted by outbound relation count, show top 5 with counts
   - Wrap in Card with "Schema Health" title.

3. **Extend `src/data/studio-data.ts`** (if needed):
   - Ensure `getOntologyTypes()` returns types with `nodeCount` field for empty detection
   - Add `getSchemaStats()` returning computed statistics: total types, total relations, avg predicates per type, relation density
  </action>
  <verify>
    - SchemaTreeView.tsx exists with collapsible tree + context menu
    - SchemaHealthScore.tsx exists with computeHealthScore function
    - `npx tsc --noEmit` passes
  </verify>
  <done>SchemaTreeView renders collapsible type hierarchy with filter and context menu; SchemaHealthScore computes score with orphan/empty detection and displays hub types + relation density</done>
</task>

<task type="auto">
  <name>Task 2: Create OntologyMinimap and TypeDistributionTreemap</name>
  <files>
    src/components/studio/OntologyMinimap.tsx
    src/components/charts/studio/TypeDistributionTreemap.tsx
    src/components/charts/studio/OntologyGraph.tsx
  </files>
  <action>
1. **OntologyMinimap.tsx** (`"use client"`):
   - Props: `{ nodes: { x: number; y: number; name: string }[]; viewportTransform: { x: number; y: number; k: number }; graphWidth: number; graphHeight: number }`
   - Renders a small SVG (120x80px) positioned absolute in lower-right of graph container.
   - Background: semi-transparent dark card (bg-card/80 with border).
   - Node dots: small circles (r=2) at scaled positions. Use MINIMAP_SCALE = 120 / graphWidth.
   - Viewport rectangle: dashed stroke rect showing current visible area based on viewportTransform.
     - `vx = (-transform.x / transform.k) * MINIMAP_SCALE`
     - `vy = (-transform.y / transform.k) * MINIMAP_SCALE`
     - `vw = (graphWidth / transform.k) * MINIMAP_SCALE`
     - `vh = (graphHeight / transform.k) * MINIMAP_SCALE`
   - **Read-only**: No click-to-pan (per research: prevents infinite zoom loop).
   - Purely D3-managed: update SVG directly, no React state (60fps performance concern from research).

2. **Modify OntologyGraph.tsx** to expose zoom transform for minimap:
   - Add a callback prop or ref: `onZoomChange?: (transform: { x: number; y: number; k: number }, nodes: { x: number; y: number; name: string }[]) => void`
   - In the existing zoom handler (`zoomBehavior.on("zoom", ...)`), call `onZoomChange` with the current transform and node positions.
   - Export node positions from the force simulation for minimap rendering.
   - Alternatively, render OntologyMinimap INSIDE OntologyGraph.tsx as a sub-SVG to avoid prop drilling zoom state through React (preferred for performance — keeps minimap entirely in D3 scope).

3. **TypeDistributionTreemap.tsx** (`"use client"`):
   - D3 treemap replacing the existing bar chart for Records by Type.
   - Props: `{ types: OntologyType[] }` or fetches internally.
   - Use `d3.treemap()` with `d3.hierarchy()`:
     - Root: "Schema" → Children: each type with `value: nodeCount`
     - `.size([width, height])`, `.padding(2)`, `.round(true)`
   - Each cell: colored rect (chart-1 through chart-6) + label text (type name + count)
   - Hover tooltip with type name, node count, predicate count.
   - Use `d3.scaleOrdinal` with chart CSS variables for coloring.
   - Card wrapper with "Records by Type" title.
   - Follow established D3 patterns: cleanupD3Svg, ResizeObserver, getChartColors.
  </action>
  <verify>
    - OntologyMinimap.tsx exists with SVG rendering
    - TypeDistributionTreemap.tsx exists with d3.treemap usage
    - OntologyGraph.tsx modified with zoom change callback or internal minimap
    - `npm run build` succeeds
  </verify>
  <done>OntologyMinimap shows scaled node positions with viewport rectangle; TypeDistributionTreemap renders records as proportional colored rectangles; OntologyGraph exposes zoom state for minimap</done>
</task>

<task type="auto">
  <name>Task 3: Wire all new components into StudioPage</name>
  <files>
    src/components/studio/StudioPage.tsx
  </files>
  <action>
Update `src/components/studio/StudioPage.tsx`:

1. Import new components: SchemaTreeView, SchemaHealthScore, OntologyMinimap, TypeDistributionTreemap.

2. Restructure the layout from current 2-panel (35:65) to 3-section:
   - **Left panel (25-30% width)**: SchemaTreeView (top, scrollable) + SchemaHealthScore (bottom, fixed)
   - **Center panel (45-50% width)**: OntologyGraph with OntologyMinimap overlay (position relative container)
   - **Right panel (25% width)**: TypeDetail (existing, preserved)

   Alternative simpler layout if 3-panel is too complex:
   - **Left panel (35%)**: SchemaTreeView (replacing or above TypeList) + SchemaHealthScore
   - **Right panel (65%)**: OntologyGraph (with minimap) + TypeDistributionTreemap (replacing TypeDistributionChart)

   Use the simpler alternative — keep 2-panel but replace TypeList with SchemaTreeView and add SchemaHealthScore below it, replace TypeDistributionChart with TypeDistributionTreemap.

3. SchemaTreeView replaces TypeList:
   - Pass types, selectedType, onSelectType props (same data flow as current TypeList)
   - TypeDetail stays (shows when a type is selected)

4. SchemaHealthScore added below TypeDetail in the left panel (or as a collapsible section).

5. OntologyGraph container: wrap in `position: relative` div so OntologyMinimap can be `position: absolute; bottom: 8px; right: 8px`.

6. TypeDistributionTreemap replaces the existing TypeDistributionChart in the right panel below the graph.

7. Keep existing mode toggle (Force/Radial/Hierarchy) and edge filter.
  </action>
  <verify>
    - StudioPage imports all new components
    - SchemaTreeView is rendered (replacing or alongside TypeList)
    - SchemaHealthScore is visible in the page
    - TypeDistributionTreemap replaces TypeDistributionChart
    - `npm run build` succeeds
  </verify>
  <done>StudioPage restructured with SchemaTreeView replacing TypeList, SchemaHealthScore showing quality metrics, OntologyMinimap in graph corner, TypeDistributionTreemap replacing bar chart; all existing functionality preserved</done>
</task>

</tasks>

<verification>
- 4 new component files exist
- StudioPage renders all new components
- Existing OntologyGraph preserved with minimap addition
- Schema health score visible with orphan/empty detection
- `npm run build` passes
</verification>

<success_criteria>
- Schema tree view shows collapsible type > predicate/relation hierarchy with search filter
- Right-click context menu appears on tree items
- Minimap in graph corner shows viewport position (read-only)
- Health score badge shows 0-100 with color coding
- Orphan and empty types detected and displayed
- Records by Type rendered as treemap
- Hub Type Top 5 and relation density displayed
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-05-SUMMARY.md`
</output>
