---
phase: 08-product-ux-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - src/lib/dashboard-layout.ts
  - src/components/dashboard/widgets/SignalWidget.tsx
  - src/components/dashboard/widgets/SparklineWidget.tsx
  - src/components/dashboard/widgets/ThresholdWidget.tsx
  - src/components/dashboard/widgets/MetricCardWidget.tsx
  - src/components/dashboard/widgets/TrendChartWidget.tsx
  - src/components/dashboard/widgets/GpuSummaryWidget.tsx
  - src/components/dashboard/widgets/DailySummaryWidget.tsx
  - src/components/dashboard/DashboardGrid.tsx
  - src/data/dashboard-data.ts
autonomous: true
requirements:
  - UXR-01

must_haves:
  truths:
    - "react-grid-layout is installed and CSS imports are in globals.css"
    - "7 widget types render with mock data: Signal, Sparkline, Threshold, MetricCard, TrendChart, GpuSummary, DailySummary"
    - "DashboardGrid renders a 4-column draggable/resizable grid with all 13 widgets"
    - "Layout persists to localStorage and restores on page load"
    - "Layout reset returns to default widget positions"
  artifacts:
    - path: "src/lib/dashboard-layout.ts"
      provides: "localStorage layout save/load/reset helpers and DEFAULT_DASHBOARD_LAYOUT"
      exports: ["saveLayout", "loadLayout", "resetLayout", "DEFAULT_DASHBOARD_LAYOUT"]
    - path: "src/components/dashboard/DashboardGrid.tsx"
      provides: "ReactGridLayout wrapper with layout persistence"
      min_lines: 60
    - path: "src/components/dashboard/widgets/SignalWidget.tsx"
      provides: "Traffic light widget (green/yellow/red status + number)"
      min_lines: 20
    - path: "src/components/dashboard/widgets/SparklineWidget.tsx"
      provides: "Current value + mini line chart widget"
      min_lines: 30
    - path: "src/components/dashboard/widgets/ThresholdWidget.tsx"
      provides: "Time series with warning/critical horizontal lines"
      min_lines: 40
    - path: "src/components/dashboard/widgets/MetricCardWidget.tsx"
      provides: "Simple number + label metric card"
      min_lines: 15
    - path: "src/components/dashboard/widgets/TrendChartWidget.tsx"
      provides: "Area/line trend chart for disk/memory"
      min_lines: 40
    - path: "src/components/dashboard/widgets/GpuSummaryWidget.tsx"
      provides: "GPU status count + link to GPU Monitoring"
      min_lines: 20
    - path: "src/components/dashboard/widgets/DailySummaryWidget.tsx"
      provides: "Today vs yesterday comparison widget"
      min_lines: 20
  key_links:
    - from: "src/components/dashboard/DashboardGrid.tsx"
      to: "react-grid-layout"
      via: "ReactGridLayout component import"
      pattern: "import.*react-grid-layout"
    - from: "src/components/dashboard/DashboardGrid.tsx"
      to: "src/lib/dashboard-layout.ts"
      via: "loadLayout/saveLayout for persistence"
      pattern: "loadLayout|saveLayout"
---

<objective>
Install react-grid-layout, create the 7 widget component types, build the DashboardGrid container, and implement localStorage layout persistence for the new NOC-style dashboard.

Purpose: Foundation for the completely rebuilt dashboard — all widget components and the drag-drop grid infrastructure must exist before wiring them into the page.
Output: 7 widget components, DashboardGrid wrapper, layout persistence helpers, react-grid-layout installed with CSS.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@src/data/dashboard-data.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-grid-layout, create layout helpers, and CSS imports</name>
  <files>
    src/app/globals.css
    src/lib/dashboard-layout.ts
  </files>
  <action>
1. Run `npm install react-grid-layout` (v2.2.2). Verify no peer dep conflicts.

2. Add CSS imports to `src/app/globals.css` at the top (before other imports):
   ```css
   @import "react-grid-layout/css/styles.css";
   @import "react-resizable/css/styles.css";
   ```

3. Create `src/lib/dashboard-layout.ts` with:
   - `STORAGE_KEY = "exemble-dashboard-layout-v1"`
   - `DEFAULT_DASHBOARD_LAYOUT: Layout[]` — 13 widget entries for a 4-column grid (cols=4, rowHeight=80):
     - Row 0: signal-dgraph-target (1x2), signal-alpha-alive (1x2), sparkline-qps (1x3), sparkline-tps (1x3)
     - Row 1: metric-pending (1x2), metric-raft (1x2), metric-errors (1x2), metric-cache (1x2)
     - Row 2: threshold-p95 (2x4)
     - Row 3: trend-disk (2x4), trend-memory (2x4)
     - Row 4: gpu-summary (2x2), daily-summary (2x2)
   - `saveLayout(layout: Layout[]): void` — JSON.stringify to localStorage with try/catch
   - `loadLayout(defaults: Layout[]): Layout[]` — Parse from localStorage, merge missing widgets from defaults
   - `resetLayout(defaults: Layout[]): Layout[]` — Remove from localStorage, return defaults
   - Export type `WidgetConfig` with `{ id: string; type: 'signal' | 'sparkline' | 'threshold' | 'metric' | 'trend' | 'gpu-summary' | 'daily-summary'; title: string; props: Record<string, unknown> }`
   - Export `WIDGET_REGISTRY: WidgetConfig[]` mapping each of the 13 widget IDs to their type/title/props

   **Deviation note:** CONTEXT.md says "Supabase 서버 저장" but research confirmed no real Supabase auth users in POC. Using localStorage per research recommendation. Document this deviation in a code comment.
  </action>
  <verify>
    - `npm ls react-grid-layout` shows 2.2.2
    - `grep -c "react-grid-layout" src/app/globals.css` returns 1
    - TypeScript compiles: `npx tsc --noEmit src/lib/dashboard-layout.ts` (or `npm run build` partial check)
  </verify>
  <done>react-grid-layout installed, CSS imported in globals.css, layout helpers exported with 13-widget default layout and localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 2: Create 7 widget component types</name>
  <files>
    src/components/dashboard/widgets/SignalWidget.tsx
    src/components/dashboard/widgets/SparklineWidget.tsx
    src/components/dashboard/widgets/ThresholdWidget.tsx
    src/components/dashboard/widgets/MetricCardWidget.tsx
    src/components/dashboard/widgets/TrendChartWidget.tsx
    src/components/dashboard/widgets/GpuSummaryWidget.tsx
    src/components/dashboard/widgets/DailySummaryWidget.tsx
    src/data/dashboard-data.ts
  </files>
  <action>
All widgets are `"use client"` components. Each wraps content in a `Card` (shadcn) with compact padding. All must handle the react-grid-layout resize by using the container dimensions.

1. **SignalWidget** — Props: `{ label: string; value: number; status: 'healthy' | 'warning' | 'error' }`. Shows large number + colored circle icon (green/yellow/red). Use lucide `CircleDot` or `Circle` icons with status-based Tailwind colors. Used for DGraph Target count and Alpha Alive count.

2. **SparklineWidget** — Props: `{ label: string; value: number; unit: string; data: { time: string; value: number }[] }`. Shows current value prominently + recharts `LineChart` (already installed) as a mini sparkline below. Use `ResponsiveContainer` from recharts for auto-sizing. Sparkline: no axes, no grid, just the line + optional area fill with chart-1 color. Used for QPS and TPS.

3. **ThresholdWidget** — Props: `{ label: string; data: { time: string; value: number }[]; warningThreshold: number; criticalThreshold: number }`. D3 time-series line chart with two horizontal dashed lines (warning=amber, critical=red). Use existing `cleanupD3Svg` + `createDebouncedResizeObserver` patterns. Minimum height guard: `if (height < 20) return;` to prevent react-grid-layout resize flicker. Used for Query p95 latency.

4. **MetricCardWidget** — Props: `{ label: string; value: string | number; trend?: 'up' | 'down' | 'flat'; trendValue?: string }`. Simple card with large value, label, optional trend indicator (lucide TrendingUp/Down/Minus with green/red/muted). Reuse MetricCard pattern from Phase 3 but simplified for widget context. Used for Pending Queries, Raft Leader Changes, Errors/sec, Cache Hit Rate.

5. **TrendChartWidget** — Props: `{ label: string; series: { name: string; data: { time: string; value: number }[] }[] }`. D3 area chart showing 1-2 series over time with axes. Use established D3 patterns (cleanupD3Svg, ResizeObserver, getChartColors). Minimum height guard. Used for Disk Usage Trend and Alpha Memory Usage.

6. **GpuSummaryWidget** — Props: `{ active: number; idle: number; error: number }`. Shows three colored counts (green/muted/red) in a row + a "GPU Monitoring" link button using `next/link` to `/monitoring/gpu`. Used for GPU status overview.

7. **DailySummaryWidget** — Props: `{ queryCountChange: number; errorCount: number; errorCountYesterday: number }`. Shows today vs yesterday comparison: query count change as percentage with up/down arrow, error count comparison. Use green for improvement, red for degradation.

8. **Extend `src/data/dashboard-data.ts`** with new functions to generate mock data for widgets:
   - `getDashboardSignalData()` → returns `{ dgraphTarget: { value, status }, alphaAlive: { value, status } }`
   - `getDashboardSparklineData()` → returns QPS/TPS with 60 data points (1-hour, 1-min intervals)
   - `getDashboardThresholdData()` → returns p95 latency time series with warning=200ms, critical=500ms
   - `getDashboardMetricCards()` → returns Pending, Raft, Errors/sec, Cache Hit Rate
   - `getDashboardTrendData()` → returns disk usage + memory series
   - `getDashboardGpuSummary()` → returns { active, idle, error } counts
   - `getDashboardDailySummary()` → returns change rates

  Add jitter to time-series data for live feel (use inline addJitter helper, established pattern).
  </action>
  <verify>
    - All 7 widget files exist in `src/components/dashboard/widgets/`
    - Each file has `"use client"` directive
    - `npm run build` succeeds (or at minimum `npx tsc --noEmit`)
  </verify>
  <done>7 widget components created with proper typing and mock data functions; all follow established D3/shadcn patterns; dashboard-data.ts extended with widget data generators</done>
</task>

<task type="auto">
  <name>Task 3: Create DashboardGrid container component</name>
  <files>
    src/components/dashboard/DashboardGrid.tsx
  </files>
  <action>
Create `src/components/dashboard/DashboardGrid.tsx` as `"use client"` component:

1. Import `ReactGridLayout` from `react-grid-layout` and `Layout` type.
2. Import all 7 widget components.
3. Import `loadLayout`, `saveLayout`, `resetLayout`, `DEFAULT_DASHBOARD_LAYOUT`, `WIDGET_REGISTRY` from `@/lib/dashboard-layout`.
4. Import data functions from `@/data/dashboard-data`.

5. SSR safety pattern (from research):
   ```tsx
   const [mounted, setMounted] = useState(false);
   const containerRef = useRef<HTMLDivElement>(null);
   const [width, setWidth] = useState(1200);
   useEffect(() => {
     setMounted(true);
     if (containerRef.current) setWidth(containerRef.current.offsetWidth);
   }, []);
   ```

6. Layout state:
   ```tsx
   const [layout, setLayout] = useState<Layout[]>(() => loadLayout(DEFAULT_DASHBOARD_LAYOUT));
   const handleLayoutChange = useCallback((newLayout: Layout[]) => {
     setLayout(newLayout);
     saveLayout(newLayout);
   }, []);
   ```

7. Call data functions at module scope (outside component) for static generation compatibility (established pattern from Phase 3).

8. Render:
   - Container div with ref for width measurement
   - "Reset Layout" button (lucide RotateCcw icon) in top-right corner
   - `ReactGridLayout` with `cols={4}`, `rowHeight={80}`, `width={width}`, `isDraggable`, `isResizable`, `margin={[12, 12]}`, `onLayoutChange={handleLayoutChange}`
   - Map over `WIDGET_REGISTRY` to render each widget by type in a keyed div
   - Use a switch/map to render the correct widget component based on `config.type`

9. Reset handler: `const handleReset = () => setLayout(resetLayout(DEFAULT_DASHBOARD_LAYOUT));`

10. Add ResizeObserver on containerRef to update width on window resize.

11. Do NOT render grid until `mounted === true` to avoid SSR hydration mismatch.
  </action>
  <verify>
    - File exists at `src/components/dashboard/DashboardGrid.tsx`
    - Contains `ReactGridLayout` usage with `cols={4}`
    - Contains `loadLayout` and `saveLayout` calls
    - `npm run build` succeeds
  </verify>
  <done>DashboardGrid renders 13 widgets in a draggable/resizable 4-column grid with localStorage persistence and reset button</done>
</task>

</tasks>

<verification>
- `npm ls react-grid-layout` shows version 2.2.2
- `src/app/globals.css` contains react-grid-layout CSS imports
- All 7 widget files + DashboardGrid.tsx exist
- `npm run build` passes without errors
- Layout helpers export all 4 functions + DEFAULT_DASHBOARD_LAYOUT + WIDGET_REGISTRY
</verification>

<success_criteria>
- react-grid-layout installed and CSS imported
- 7 distinct widget types created with typed props
- DashboardGrid renders all 13 widgets in 4-column draggable grid
- Layout saves to localStorage on drag/resize and restores on load
- Reset button returns to default layout
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-01-SUMMARY.md`
</output>
