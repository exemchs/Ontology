---
phase: 08-product-ux-refinement
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dgraph/LatencyHistogram.tsx
  - src/components/dgraph/QueryHeatmap.tsx
  - src/components/dgraph/ErrorTimeline.tsx
  - src/components/dgraph/AlphaComparisonBar.tsx
  - src/components/dgraph/DgraphMonitoringPage.tsx
  - src/data/dgraph-data.ts
autonomous: true
requirements:
  - UXR-03

must_haves:
  truths:
    - "Latency histogram shows distribution of query latencies as D3 bars"
    - "Query heatmap displays time-of-day x query-type matrix with color intensity"
    - "Error timeline lists error events chronologically with severity and timestamps"
    - "Alpha comparison bar chart shows per-Alpha resource metrics side by side"
    - "Graph Cluster page title reads 'Graph Cluster' (renamed from DGraph Monitoring)"
  artifacts:
    - path: "src/components/dgraph/LatencyHistogram.tsx"
      provides: "D3 histogram of query latency distribution"
      min_lines: 50
    - path: "src/components/dgraph/QueryHeatmap.tsx"
      provides: "D3 heatmap of queries by time and type"
      min_lines: 60
    - path: "src/components/dgraph/ErrorTimeline.tsx"
      provides: "Scrollable error event list with timestamps"
      min_lines: 30
    - path: "src/components/dgraph/AlphaComparisonBar.tsx"
      provides: "Per-Alpha grouped bar chart for resource comparison"
      min_lines: 50
    - path: "src/components/dgraph/DgraphMonitoringPage.tsx"
      provides: "Extended page with 4 new chart sections"
      contains: "LatencyHistogram"
  key_links:
    - from: "src/components/dgraph/DgraphMonitoringPage.tsx"
      to: "src/components/dgraph/LatencyHistogram.tsx"
      via: "Component import and render in page grid"
      pattern: "LatencyHistogram"
    - from: "src/components/dgraph/LatencyHistogram.tsx"
      to: "src/data/dgraph-data.ts"
      via: "Data function import"
      pattern: "getDgraphLatencyData|getLatencyHistogramData"
---

<objective>
Extend Graph Cluster (DGraph Monitoring) with latency histogram, query heatmap, error timeline, and Alpha comparison bar chart. Rename page title to "Graph Cluster".

Purpose: Adds operational analytics depth — latency distribution, time-based query patterns, error tracking, and per-Alpha resource comparison for cluster operations.
Output: 4 new D3/React components + page integration + title rename.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-product-ux-refinement/08-RESEARCH.md
@src/components/dgraph/DgraphMonitoringPage.tsx
@src/data/dgraph-data.ts
@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LatencyHistogram, QueryHeatmap, and data extensions</name>
  <files>
    src/components/dgraph/LatencyHistogram.tsx
    src/components/dgraph/QueryHeatmap.tsx
    src/data/dgraph-data.ts
  </files>
  <action>
1. **Extend `src/data/dgraph-data.ts`** with new mock data functions:
   - `getDgraphLatencyData()`: Returns array of ~200 latency values (ms) with realistic distribution — most 10-100ms, some 100-500ms outliers. Use `Array.from` with random distribution.
   - `getDgraphHeatmapData()`: Returns `{ hour: number; queryType: string; count: number }[]` for 24 hours x 5 query types (mutation, query, schema, backup, health). Higher counts during business hours (9-18).
   - `getDgraphErrorLog()`: Returns `{ timestamp: Date; severity: 'error' | 'warning' | 'info'; message: string; alpha: string }[]` with ~15 mock entries. Messages like "Raft proposal timeout on Alpha-2", "Schema update conflict", "Memory pressure warning".
   - `getDgraphAlphaComparison()`: Returns per-Alpha metrics `{ alpha: string; cpu: number; memory: number; disk: number; qps: number }[]` for 3 Alphas.

2. **LatencyHistogram.tsx** (`"use client"`):
   - D3 histogram using established patterns (cleanupD3Svg, createDebouncedResizeObserver, getChartColors).
   - Props: none (fetches data internally) or `{ data: number[] }`.
   - Use `d3.bin()` to create histogram bins (10-15 bins across 0-500ms range).
   - X-axis: latency in ms. Y-axis: frequency count.
   - Bars colored with chart-1 CSS variable.
   - Hover tooltip showing bin range and count.
   - Card wrapper with "Latency Distribution" title.
   - Median + p95 vertical dashed lines (chart-4 for median, chart-8 for p95).

3. **QueryHeatmap.tsx** (`"use client"`):
   - D3 heatmap using scaleBand (x: hours 0-23, y: query types) + scaleSequential (interpolateBlues or interpolateYlOrRd).
   - Props: none (fetches data internally).
   - Grid of colored rectangles. Hover tooltip shows hour, type, count.
   - X-axis labels: 0, 3, 6, 9, 12, 15, 18, 21. Y-axis labels: query type names.
   - Color legend bar at bottom (like GPU heatmap pattern from Phase 5).
   - Card wrapper with "Query Pattern Heatmap" title.
   - Use existing heatmap pattern from GpuHeatmap.tsx as reference.
  </action>
  <verify>
    - Both component files exist with D3 chart implementations
    - dgraph-data.ts has 4 new data functions
    - `npx tsc --noEmit` passes
  </verify>
  <done>LatencyHistogram shows binned latency distribution with median/p95 lines; QueryHeatmap shows time-of-day x query-type color matrix; dgraph-data.ts extended with 4 new data generators</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorTimeline, AlphaComparisonBar, and wire into DgraphMonitoringPage</name>
  <files>
    src/components/dgraph/ErrorTimeline.tsx
    src/components/dgraph/AlphaComparisonBar.tsx
    src/components/dgraph/DgraphMonitoringPage.tsx
  </files>
  <action>
1. **ErrorTimeline.tsx** (`"use client"`):
   - React component (not D3 — a scrollable list is better as React).
   - Props: none (fetches data internally from getDgraphErrorLog).
   - Renders a vertical timeline list:
     - Each entry: severity badge (error=destructive, warning=amber, info=secondary), timestamp (relative time), alpha name, message text
     - Entries sorted by timestamp descending (newest first)
     - Max-height with overflow-auto scroll
     - Left border colored by severity (red for error, amber for warning, blue for info)
   - Card wrapper with "Error Log" title + total count badge.

2. **AlphaComparisonBar.tsx** (`"use client"`):
   - D3 grouped bar chart (same pattern as GpuComparisonBar from Phase 5).
   - Props: none (fetches from getDgraphAlphaComparison).
   - Groups: 3 Alphas. Metrics: CPU%, Memory%, Disk%, QPS (normalized to 0-100).
   - X-axis: Alpha names. Y-axis: percentage (0-100).
   - Legend for metrics. Hover tooltip with actual values.
   - Card wrapper with "Alpha Resource Comparison" title.

3. **Update `src/components/dgraph/DgraphMonitoringPage.tsx`**:
   - Import 4 new components: LatencyHistogram, QueryHeatmap, ErrorTimeline, AlphaComparisonBar.
   - **Rename page title**: Change the heading/title text from "DGraph Monitoring" to "Graph Cluster" (the breadcrumb is already "Graph Cluster" in navigation.ts).
   - Add new components below existing ones in a 2-column grid:
     - Row after existing charts: LatencyHistogram (col-span-1) + QueryHeatmap (col-span-1)
     - Next row: AlphaComparisonBar (col-span-1) + ErrorTimeline (col-span-1)
   - Keep all existing components (ClusterTopology, QueryScatterPlot, ShardBarChart, RecentEvents) in their current positions.
   - Keep existing NodePopover and NodeDetailPanel functionality.
  </action>
  <verify>
    - ErrorTimeline.tsx and AlphaComparisonBar.tsx exist
    - DgraphMonitoringPage imports all 4 new components
    - Page title changed to "Graph Cluster"
    - `npm run build` succeeds
  </verify>
  <done>4 new components integrated into Graph Cluster page; page title renamed to "Graph Cluster"; existing components preserved; new analytics section shows latency/heatmap/errors/alpha comparison</done>
</task>

</tasks>

<verification>
- 4 new component files exist in src/components/dgraph/
- DgraphMonitoringPage renders all new components
- Page heading says "Graph Cluster"
- `npm run build` passes
- dgraph-data.ts has getDgraphLatencyData, getDgraphHeatmapData, getDgraphErrorLog, getDgraphAlphaComparison
</verification>

<success_criteria>
- Latency histogram shows distribution with median/p95 markers
- Query heatmap shows 24h x 5-type color matrix
- Error timeline lists events with severity badges and relative times
- Alpha comparison shows per-Alpha resource bars
- Page title reads "Graph Cluster"
</success_criteria>

<output>
After completion, create `.planning/phases/08-product-ux-refinement/08-04-SUMMARY.md`
</output>
