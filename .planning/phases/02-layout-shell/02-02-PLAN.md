---
phase: 02-layout-shell
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/components/layout/app-sidebar.tsx
  - src/components/layout/header-bar.tsx
  - src/components/layout/welcome-popup.tsx
  - src/components/layout/command-palette.tsx
  - src/app/(authenticated)/layout.tsx
autonomous: true
requirements:
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05

must_haves:
  truths:
    - "사이드바에서 6개 페이지를 모두 클릭하여 이동할 수 있다"
    - "현재 페이지가 사이드바에서 하이라이트된다"
    - "사이드바를 접기 버튼으로 아이콘만 보이게 축소할 수 있다"
    - "사이드바 하단에 다크/라이트 테마 토글과 로그아웃 버튼이 있다"
    - "헤더에 브레드크럼이 현재 경로에 맞게 표시된다"
    - "Cmd+K로 Command Palette가 열리고 페이지 검색/이동이 동작한다"
    - "첫 방문 시 Welcome Popup이 한국어로 표시되고 닫으면 다시 나타나지 않는다"
    - "로그아웃 후 재로그인 시 Welcome Popup이 다시 나타난다"
  artifacts:
    - path: "src/components/layout/app-sidebar.tsx"
      provides: "Collapsible sidebar with 4 navigation groups, theme toggle, logout"
      min_lines: 80
    - path: "src/components/layout/header-bar.tsx"
      provides: "Header with breadcrumb, sidebar trigger, Cmd+K hint"
      min_lines: 30
    - path: "src/components/layout/welcome-popup.tsx"
      provides: "First-visit Korean greeting dialog"
      min_lines: 30
    - path: "src/components/layout/command-palette.tsx"
      provides: "Cmd+K command palette with page search and theme toggle"
      min_lines: 40
    - path: "src/app/(authenticated)/layout.tsx"
      provides: "Updated layout with SidebarProvider, AppSidebar, HeaderBar, WelcomePopup, CommandPalette"
      min_lines: 30
  key_links:
    - from: "src/components/layout/app-sidebar.tsx"
      to: "src/lib/navigation.ts"
      via: "import navigationGroups for rendering nav items"
      pattern: "import.*navigationGroups.*from.*@/lib/navigation"
    - from: "src/components/layout/app-sidebar.tsx"
      to: "src/hooks/use-auth.ts"
      via: "useAuth().logout for logout button"
      pattern: "useAuth\\(\\)"
    - from: "src/components/layout/header-bar.tsx"
      to: "src/lib/navigation.ts"
      via: "import breadcrumbMap for dynamic breadcrumb"
      pattern: "import.*breadcrumbMap.*from.*@/lib/navigation"
    - from: "src/components/layout/command-palette.tsx"
      to: "src/lib/navigation.ts"
      via: "import navigationGroups or allNavItems for search"
      pattern: "import.*from.*@/lib/navigation"
    - from: "src/components/layout/welcome-popup.tsx"
      to: "src/lib/auth.ts"
      via: "import WELCOME_KEY for sessionStorage"
      pattern: "import.*WELCOME_KEY.*from.*@/lib/auth"
    - from: "src/app/(authenticated)/layout.tsx"
      to: "src/components/layout/app-sidebar.tsx"
      via: "SidebarProvider wrapping AppSidebar + SidebarInset"
      pattern: "AppSidebar"
---

<objective>
Sidebar navigation, header bar, welcome popup, and command palette

Purpose: Complete the application shell chrome. After this plan, users can navigate all 6 pages via sidebar, see breadcrumbs, toggle theme, use Cmd+K command palette, and see a welcome greeting on first visit. This is the final plan for Phase 2.

Output: app-sidebar.tsx, header-bar.tsx, welcome-popup.tsx, command-palette.tsx, updated (authenticated)/layout.tsx
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-layout-shell/02-CONTEXT.md
@.planning/phases/02-layout-shell/02-RESEARCH.md
@.planning/phases/02-layout-shell/02-01-SUMMARY.md
@src/app/(authenticated)/layout.tsx
@src/lib/navigation.ts
@src/lib/auth.ts
@src/hooks/use-auth.ts
@src/components/ui/sidebar.tsx
@src/components/ui/command.tsx
@src/components/ui/dialog.tsx
@src/components/ui/breadcrumb.tsx
@src/components/ui/switch.tsx
@src/components/theme-provider.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: AppSidebar and HeaderBar components</name>
  <files>src/components/layout/app-sidebar.tsx, src/components/layout/header-bar.tsx</files>
  <action>
**src/components/layout/app-sidebar.tsx:** Per user locked decisions:
- `"use client"` directive
- Import shadcn Sidebar components: `Sidebar, SidebarContent, SidebarFooter, SidebarGroup, SidebarGroupContent, SidebarGroupLabel, SidebarHeader, SidebarMenu, SidebarMenuButton, SidebarMenuItem` from `@/components/ui/sidebar`
- Import `navigationGroups` from `@/lib/navigation`
- Import `useAuth` from `@/hooks/use-auth` for logout
- Import `usePathname` from `next/navigation` for active page detection
- Import `Link` from `next/link` for navigation
- Import `useTheme` from `next-themes` for theme toggle
- Import `Moon, Sun, LogOut` from `lucide-react`
- Import `Switch` from `@/components/ui/switch`

Structure:
- `<Sidebar collapsible="icon" className="border-r">` (per user decision: expand/collapse to icon-only)
- **SidebarHeader:** eXemble logo area. Show "eXemble" text (bold, brand color). When collapsed, show just "eX" or a small icon. Use the sidebar's `data-[state=collapsed]` to handle this via group-data attribute from useSidebar context.
- **SidebarContent:** Map over `navigationGroups`. For each group:
  - `<SidebarGroup>` with `<SidebarGroupLabel>{group.label}</SidebarGroupLabel>`
  - `<SidebarGroupContent>` with `<SidebarMenu>`
  - Each item: `<SidebarMenuItem>` -> `<SidebarMenuButton asChild isActive={pathname === item.url} tooltip={item.title}>` -> `<Link href={item.url}><item.icon /><span>{item.title}</span></Link>`
  - The `isActive` prop triggers `data-[active=true]` styling (built-in: `bg-sidebar-accent` + `font-medium`)
  - Per user decision: basic highlight for active page. Use shadcn's built-in active styling (no custom override needed). User will provide custom design reference later.
- **SidebarFooter:** Per user locked decision: dark/light theme toggle + logout button
  - Theme toggle row: `<Sun>` icon + `<Switch>` (checked when dark) + `<Moon>` icon. Use `useTheme()` to get/set theme.
  - Logout button: `<Button variant="ghost" size="sm" onClick={logout}>` with `<LogOut>` icon + "로그아웃" text
  - When sidebar collapsed: show only icons (theme switch and logout icon), text hides automatically via sidebar CSS

**src/components/layout/header-bar.tsx:** Per Claude's discretion for header composition:
- `"use client"` directive
- Import `SidebarTrigger` from `@/components/ui/sidebar`
- Import `Breadcrumb, BreadcrumbList, BreadcrumbItem, BreadcrumbLink, BreadcrumbPage, BreadcrumbSeparator` from `@/components/ui/breadcrumb`
- Import `Separator` from `@/components/ui/separator`
- Import `breadcrumbMap` from `@/lib/navigation`
- Import `usePathname` from `next/navigation`

Structure:
- `<header className="flex h-14 shrink-0 items-center gap-2 border-b px-4">`
- Left side: `<SidebarTrigger />` (toggles sidebar collapse) + `<Separator orientation="vertical" className="mr-2 h-4" />` + dynamic `<Breadcrumb>` based on current pathname
- Breadcrumb: look up `breadcrumbMap[pathname]`. Show `group > page` format. Group as `BreadcrumbLink`, page as `BreadcrumbPage`.
- Right side: Cmd+K hint button (a `<button>` or `<kbd>` styled element showing "Ctrl+K" or "Cmd+K" that opens the command palette). Use a `<button onClick={() => document.dispatchEvent(new KeyboardEvent('keydown', { key: 'k', metaKey: true }))}` approach, OR expose a simpler event. Actually, since command palette listens globally, just make this a visual hint: `<kbd className="pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-xs font-medium text-muted-foreground">Cmd+K</kbd>`. Wrap in a clickable button that dispatches the shortcut event for discoverability.
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no type errors.
2. Visually verify in dev server: sidebar renders 4 groups with correct icons and labels, clicking items navigates, active item is highlighted, collapse button works (icon-only mode), theme toggle switches dark/light, logout redirects to /login.
  </verify>
  <done>
Sidebar renders 4 navigation groups with 6 items total. Active page highlighted via shadcn built-in styling. Collapse toggles between full and icon-only mode. Footer has theme toggle (Switch) and logout button. Header shows dynamic breadcrumb matching current route. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Welcome popup, command palette, and layout integration</name>
  <files>src/components/layout/welcome-popup.tsx, src/components/layout/command-palette.tsx, src/app/(authenticated)/layout.tsx</files>
  <action>
**src/components/layout/welcome-popup.tsx:** Per user locked decisions:
- `"use client"` directive
- Import `Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter` from `@/components/ui/dialog`
- Import `Button` from `@/components/ui/button`
- Import `WELCOME_KEY` from `@/lib/auth`
- State: `open` boolean, initialized via useEffect checking `sessionStorage.getItem(WELCOME_KEY) !== "true"`
- On dismiss ("시작하기" button click): set `sessionStorage.setItem(WELCOME_KEY, "true")`, set `open` to `false`
- Content per user decision:
  - Title: "환영합니다" (welcome)
  - Description body: "eXemble Ontology Platform" on one line, "SK Siltron FAB POC Demo" on next line
  - Footer: "시작하기" button (primary, triggers dismiss)
- Dialog should NOT be closable by clicking outside or pressing Escape on first appearance (or if that feels too aggressive for a POC, allow Escape but still use onOpenChange to set the sessionStorage). Use `onOpenChange` to handle dismiss properly — when dialog closes by any means, set the sessionStorage key.
- Per user decision: session-based dismissal. Logout clears WELCOME_KEY (handled in use-auth.ts logout()), so popup reappears after re-login.

**src/components/layout/command-palette.tsx:** Per user locked decisions:
- `"use client"` directive
- Import `CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem` from `@/components/ui/command`
- Import `navigationGroups` from `@/lib/navigation`
- Import `useRouter` from `next/navigation`
- Import `useTheme` from `next-themes` (for theme toggle action per Claude's discretion)
- Import `Moon, Sun` from `lucide-react`

Structure:
- State: `open` boolean
- Keyboard listener in useEffect: listen for `keydown`, if `e.key === "k" && (e.metaKey || e.ctrlKey)` -> `e.preventDefault()` + toggle `open`. Clean up on unmount.
- `<CommandDialog open={open} onOpenChange={setOpen}>`
- `<CommandInput placeholder="페이지 검색..." />`
- `<CommandList>`
  - `<CommandEmpty>결과가 없습니다.</CommandEmpty>`
  - For each navigation group: `<CommandGroup heading={group.label}>` with items. Each item: `<CommandItem onSelect={() => { setOpen(false); router.push(item.url) }}><item.icon className="mr-2 h-4 w-4" />{item.title}</CommandItem>`
  - Per Claude's discretion: add a "Settings" or "Actions" group with "Toggle Theme" item using Moon/Sun icon. On select: `setOpen(false); setTheme(theme === "dark" ? "light" : "dark")`
- cmdk handles fuzzy search filtering and keyboard navigation (up/down/Enter) automatically. No custom filter needed.

**src/app/(authenticated)/layout.tsx:** UPDATE the existing auth-guarded layout from Plan 01:
- Keep the existing auth guard logic (null -> loading, false -> redirect, true -> render)
- Wrap children with the full sidebar layout:
  ```
  <SidebarProvider defaultOpen={true}>
    <AppSidebar />
    <SidebarInset>
      <HeaderBar />
      <main className="flex-1 overflow-auto p-6">
        {children}
      </main>
    </SidebarInset>
    <WelcomePopup />
    <CommandPalette />
  </SidebarProvider>
  ```
- Import: `SidebarProvider, SidebarInset` from `@/components/ui/sidebar`, `AppSidebar` from `@/components/layout/app-sidebar`, `HeaderBar` from `@/components/layout/header-bar`, `WelcomePopup` from `@/components/layout/welcome-popup`, `CommandPalette` from `@/components/layout/command-palette`
- WelcomePopup and CommandPalette are rendered as siblings (overlay dialogs, not blocking layout)
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no type errors.
2. Run `npm run build` to confirm production build succeeds.
3. Dev server verification:
   - After login, welcome popup appears with "환영합니다" title and "시작하기" button
   - Clicking "시작하기" dismisses popup; refreshing page does NOT show popup again (sessionStorage)
   - Clicking logout and re-logging in DOES show popup again (sessionStorage cleared)
   - Cmd+K (Mac) or Ctrl+K (Windows) opens command palette
   - Typing in command palette filters page options
   - Selecting a page navigates to it and closes palette
   - "Toggle Theme" action exists and switches dark/light
   - Empty search state shows "결과가 없습니다."
   - All sidebar navigation still works after layout update
  </verify>
  <done>
Welcome popup shows on first visit with Korean greeting, dismisses and stays dismissed within session, reappears after logout. Command palette opens with Cmd+K, searches 6 pages with fuzzy matching, includes theme toggle action. Authenticated layout wraps all pages with SidebarProvider + sidebar + header. All Phase 2 success criteria met: password gate, 6-page navigation, command palette, welcome popup. No TypeScript or build errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Full auth flow: open app -> redirect to /login -> enter "exem123" -> welcome popup appears -> "시작하기" -> dashboard with sidebar
4. Sidebar: 4 groups, 6 items, click each to navigate, active state highlighted
5. Sidebar collapse: toggle to icon-only mode and back
6. Theme toggle: switch works in sidebar footer, Cmd+K palette also offers toggle
7. Logout: clears session, redirects to login, welcome popup reappears on next login
8. Breadcrumb: updates correctly for each of the 6 routes
9. Command palette: Cmd+K opens, search filters pages, Enter navigates, Escape closes
10. Welcome popup: shows once per session, dismissed state persists in sessionStorage
</verification>

<success_criteria>
- Sidebar shows 4 navigation groups with all 6 pages, supports icon-only collapse mode
- Active page is visually highlighted in sidebar
- Theme toggle and logout button are in sidebar footer
- Header breadcrumb reflects current page path
- Cmd+K opens command palette with fuzzy page search and theme toggle action
- Welcome popup appears once on first authenticated visit, dismissible, session-scoped
- Complete app shell functional: login -> welcome -> navigate -> logout cycle works end to end
</success_criteria>

<output>
After completion, create `.planning/phases/02-layout-shell/02-02-SUMMARY.md`
</output>
