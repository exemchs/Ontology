---
phase: 04-dgraph-monitoring
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/components/dgraph/NodePopover.tsx
  - src/components/dgraph/NodeDetailPanel.tsx
  - src/components/dgraph/RecentEvents.tsx
  - src/components/dgraph/DgraphMonitoringPage.tsx
  - src/app/monitoring/dgraph/page.tsx
autonomous: true
requirements: [DGRP-04, DGRP-07]

must_haves:
  truths:
    - "Clicking a node in the topology opens a floating popover card showing name, status, CPU/Memory/Disk, QPS"
    - "Clicking the expand icon in the popover opens a right-side Sheet panel with full node details"
    - "Clicking outside the popover or on the SVG background closes it"
    - "Recent events list shows 10 events with severity badges and relative timestamps"
    - "The full DGraph Monitoring page renders topology, scatter, shard chart, and events in a responsive layout"
  artifacts:
    - path: "src/components/dgraph/NodePopover.tsx"
      provides: "Tier 1 floating popover card for node quick info"
      min_lines: 50
    - path: "src/components/dgraph/NodeDetailPanel.tsx"
      provides: "Tier 2 side panel content for expanded node details"
      min_lines: 60
    - path: "src/components/dgraph/RecentEvents.tsx"
      provides: "Event list with severity badges"
      min_lines: 40
    - path: "src/components/dgraph/DgraphMonitoringPage.tsx"
      provides: "Client component orchestrating all dgraph components"
      min_lines: 80
    - path: "src/app/monitoring/dgraph/page.tsx"
      provides: "Next.js route for /monitoring/dgraph"
      min_lines: 5
  key_links:
    - from: "src/components/dgraph/DgraphMonitoringPage.tsx"
      to: "src/components/dgraph/ClusterTopology.tsx"
      via: "Component import and onNodeClick handler"
      pattern: "ClusterTopology"
    - from: "src/components/dgraph/DgraphMonitoringPage.tsx"
      to: "src/components/dgraph/QueryScatterPlot.tsx"
      via: "Component import"
      pattern: "QueryScatterPlot"
    - from: "src/components/dgraph/DgraphMonitoringPage.tsx"
      to: "src/components/dgraph/ShardBarChart.tsx"
      via: "Component import"
      pattern: "ShardBarChart"
    - from: "src/components/dgraph/NodePopover.tsx"
      to: "src/data/dgraph-data.ts"
      via: "DgraphNode type import"
      pattern: "DgraphNode"
    - from: "src/components/dgraph/RecentEvents.tsx"
      to: "src/data/dgraph-data.ts"
      via: "getDgraphEvents() import"
      pattern: "getDgraphEvents"
    - from: "src/app/monitoring/dgraph/page.tsx"
      to: "src/components/dgraph/DgraphMonitoringPage.tsx"
      via: "Default import for page rendering"
      pattern: "DgraphMonitoringPage"
---

<objective>
Assemble the complete DGraph Monitoring page: node interaction UX (popover + side panel), recent events list, and the page orchestrator that composes all components into a responsive layout with the Next.js route.

Purpose: Wire together the topology, scatter, and shard components from Plans 04-01 and 04-02 with the remaining node detail UX and events list to produce a functional page.
Output: Complete /monitoring/dgraph route with all 7 DGRP requirements fulfilled.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-dgraph-monitoring/04-RESEARCH.md
@.planning/phases/04-dgraph-monitoring/04-CONTEXT.md
@.planning/phases/04-dgraph-monitoring/04-01-SUMMARY.md
@.planning/phases/04-dgraph-monitoring/04-02-SUMMARY.md
@src/types/index.ts
@src/data/dgraph-data.ts
@src/components/dgraph/ClusterTopology.tsx
@src/components/dgraph/QueryScatterPlot.tsx
@src/components/dgraph/ShardBarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build NodePopover, NodeDetailPanel, and RecentEvents</name>
  <files>
    src/components/dgraph/NodePopover.tsx
    src/components/dgraph/NodeDetailPanel.tsx
    src/components/dgraph/RecentEvents.tsx
  </files>
  <action>
**1. NodePopover.tsx** (`"use client"`)

Tier 1 floating popover card. Positioned absolutely based on screen coordinates from the topology click handler. This is a custom div, NOT shadcn Popover (per research: SVG triggers don't work with Radix Popover).

```typescript
interface NodePopoverProps {
  node: DgraphNode;
  x: number;  // screen X from onNodeClick
  y: number;  // screen Y from onNodeClick
  onClose: () => void;
  onExpand: (node: DgraphNode) => void;
}
```

**Layout (as described in research):**
```
┌─────────────────────────────┐
│ sks-alpha-03       [warning]│  <- name + Badge with status
│ 10.0.2.3:7080               │  <- host:port in text-muted-foreground
├─────────────────────────────┤
│ CPU    78.9%  ████████░░    │  <- mini progress bars using div width%
│ Memory 85.2%  █████████░    │
│ Disk   72.1%  ███████░░░    │
├─────────────────────────────┤
│ QPS: 1,247/min              │
│              [→ Details]    │  <- Maximize2 icon button → onExpand
└─────────────────────────────┘
```

Implementation:
- Position: `fixed` with `left` and `top` from props. Offset by -popoverWidth/2 horizontally, -popoverHeight - 20 vertically (above the node). Use a ref + useLayoutEffect to measure the popover and adjust if it goes off-screen.
- Background: `bg-popover border rounded-lg shadow-lg p-3 w-64`
- Name row: node name (text-sm font-medium) + Badge component from shadcn with status variant. Badge colors: healthy=default, warning=`bg-amber-500/10 text-amber-500 border-amber-500/20`, error=`bg-red-500/10 text-red-500 border-red-500/20`.
- Host row: `{node.host}:{node.port}` in text-xs text-muted-foreground
- Separator: `<Separator />` from shadcn
- Metric rows: three rows for CPU/Memory/Disk. Each: label (text-xs, w-16), percentage (text-xs font-mono, w-12 text-right), mini progress bar (flex-1 h-1.5 rounded-full bg-muted, inner div with width=percentage, bg color: <60% chart2/green, 60-80% chart4/amber, >80% chart5/red)
- QPS row: "QPS: {formatNumber(node.qps)}/min" in text-xs
- Expand button: ghost variant Button from shadcn, size sm, `Maximize2` icon from lucide-react, positioned bottom-right. Calls `onExpand(node)`.
- Close on Escape key: `useEffect` with keydown listener
- Click outside: the parent handles this via SVG background click

Import: `DgraphNode` from `@/data/dgraph-data`, `Badge` from `@/components/ui/badge`, `Button` from `@/components/ui/button`, `Separator` from `@/components/ui/separator`, `Maximize2` from `lucide-react`, `formatNumber` from chart-utils.

**2. NodeDetailPanel.tsx** (`"use client"`)

Tier 2 content that renders INSIDE a shadcn Sheet. The Sheet open/close is managed by the parent (DgraphMonitoringPage). This component only provides the content.

```typescript
interface NodeDetailPanelProps {
  node: DgraphNode;
  allNodes: DgraphNode[];
  links: DgraphLink[];
}
```

**Sections:**
1. **Header:** Node name (text-lg font-semibold), status Badge, type Badge (zero/alpha)
2. **Host info:** `{node.host}:{node.port}` in text-muted-foreground
3. **Metrics section (3 cards in a grid):**
   - CPU card: percentage + color-coded progress bar + "CPU Usage" label
   - Memory card: percentage + progress bar + "Memory" label
   - Disk card: percentage + progress bar + "Disk" label
   - Color coding same as popover: <60% green, 60-80% amber, >80% red
4. **QPS section:** Large number display `{formatNumber(node.qps)}` with "/min" suffix
5. **Connections section:** List nodes connected to this one (filter links where source or target matches node.id, look up connected node names from allNodes). Show each connection as: node name, connection type badge (zero-alpha/alpha-alpha/zero-zero), arrow icon.
6. **Separator + close hint:** "Press Esc or click outside to close"

Use shadcn `Card`, `CardContent`, `CardHeader` for metric cards. Use `ScrollArea` from shadcn for the overall panel content in case it overflows.

Import: `DgraphNode`, `DgraphLink` from `@/data/dgraph-data`, shadcn components, `formatNumber`.

**3. RecentEvents.tsx** (`"use client"`)

Simple React list component -- no D3 needed.

```typescript
interface RecentEventsProps {
  className?: string;
}
```

- Call `getDgraphEvents()` on mount (useMemo)
- Render a list of events, each showing:
  - Severity badge: error=red, warning=amber, info=blue (use shadcn Badge with custom classes)
  - Title (text-sm font-medium, truncated with `truncate` class)
  - Node name (text-xs text-muted-foreground)
  - Relative timestamp: "2m ago", "15m ago", "1h ago" -- compute from event.timestamp relative to now. Write a simple `formatRelativeTime(timestamp: string): string` helper inside the component.
- Each event is a row with flex layout, small left border colored by severity (border-l-2 with border-red-500/border-amber-500/border-blue-500)
- List container: `ScrollArea` with max-height for scrollability
- Add `data-testid="recent-events"` on the container

Import: `getDgraphEvents`, `DgraphEvent` from `@/data/dgraph-data`, `Badge` from shadcn, `ScrollArea` from shadcn.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify all three files exist and export their components.</verify>
  <done>NodePopover shows floating card with metrics and expand button. NodeDetailPanel shows full detail content for Sheet. RecentEvents lists 10 events with severity badges and relative timestamps.</done>
</task>

<task type="auto">
  <name>Task 2: Assemble DgraphMonitoringPage and create route</name>
  <files>
    src/components/dgraph/DgraphMonitoringPage.tsx
    src/app/monitoring/dgraph/page.tsx
  </files>
  <action>
**1. DgraphMonitoringPage.tsx** (`"use client"`)

Main orchestrator component that composes all dgraph components and manages shared state.

**State:**
- `popoverState: { node: DgraphNode; x: number; y: number } | null` -- for NodePopover
- `detailNode: DgraphNode | null` -- for Sheet/NodeDetailPanel
- `sheetOpen: boolean` -- controls Sheet visibility

**Data (loaded once via useMemo):**
- `nodes = getDgraphNodes()`
- `links = getDgraphLinks()`
(Scatter and shard charts load their own data internally.)

**Event handlers:**
- `handleNodeClick(node, x, y)`: If node is null/falsy, close popover. Otherwise, set popoverState.
- `handlePopoverClose()`: Set popoverState to null
- `handleExpand(node)`: Close popover, set detailNode, set sheetOpen to true
- `handleSheetClose()`: Set sheetOpen to false, set detailNode to null

**Layout (responsive grid):**
```
Desktop (lg+):
┌──────────────────────────────────┬──────────────────────┐
│                                  │                      │
│   Cluster Topology               │   Recent Events      │
│   (2/3 width, tall)              │   (1/3 width)        │
│                                  │                      │
├─────────────────┬────────────────┴──────────────────────┤
│                 │                                        │
│ Query Scatter   │  Shard Bar Chart                      │
│ (1/2 width)     │  (1/2 width)                          │
│                 │                                        │
└─────────────────┴───────────────────────────────────────┘
```

Using Tailwind grid:
```tsx
<div className="flex flex-col gap-4 p-4">
  {/* Page header */}
  <div>
    <h1 className="text-2xl font-bold">DGraph Monitoring</h1>
    <p className="text-sm text-muted-foreground">12-node cluster topology, query patterns, and shard distribution</p>
  </div>

  {/* Top row: Topology + Events */}
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <Card className="lg:col-span-2">
      <CardHeader className="pb-2">
        <CardTitle className="text-base">Cluster Topology</CardTitle>
      </CardHeader>
      <CardContent className="p-0 relative" style={{ height: 500 }}>
        <ClusterTopology onNodeClick={handleNodeClick} />
      </CardContent>
    </Card>
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-base">Recent Events</CardTitle>
      </CardHeader>
      <CardContent>
        <RecentEvents />
      </CardContent>
    </Card>
  </div>

  {/* Bottom row: Scatter + Shard */}
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-base">Query Performance</CardTitle>
        <CardDescription>Latency vs Throughput — brush to filter</CardDescription>
      </CardHeader>
      <CardContent>
        <QueryScatterPlot />
      </CardContent>
    </Card>
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-base">Shard Distribution</CardTitle>
        <CardDescription>Predicate sizes by group</CardDescription>
      </CardHeader>
      <CardContent>
        <ShardBarChart />
      </CardContent>
    </Card>
  </div>

  {/* Popover (fixed position, rendered when node clicked) */}
  {popoverState && (
    <NodePopover
      node={popoverState.node}
      x={popoverState.x}
      y={popoverState.y}
      onClose={handlePopoverClose}
      onExpand={handleExpand}
    />
  )}

  {/* Side panel Sheet (Tier 2 detail) */}
  <Sheet open={sheetOpen} onOpenChange={(open) => { if (!open) handleSheetClose(); }}>
    <SheetContent className="w-[400px] sm:w-[540px]">
      <SheetHeader>
        <SheetTitle>Node Details</SheetTitle>
      </SheetHeader>
      {detailNode && (
        <NodeDetailPanel
          node={detailNode}
          allNodes={nodes}
          links={links}
        />
      )}
    </SheetContent>
  </Sheet>
</div>
```

Import: All dgraph components (`ClusterTopology`, `QueryScatterPlot`, `ShardBarChart`, `NodePopover`, `NodeDetailPanel`, `RecentEvents`), data functions (`getDgraphNodes`, `getDgraphLinks`, `DgraphNode`, `DgraphLink`), shadcn components (`Card`, `CardContent`, `CardHeader`, `CardTitle`, `CardDescription`, `Sheet`, `SheetContent`, `SheetHeader`, `SheetTitle`).

**2. src/app/monitoring/dgraph/page.tsx**

Minimal server component wrapper:

```tsx
import DgraphMonitoringPage from "@/components/dgraph/DgraphMonitoringPage";

export default function DgraphMonitoringRoute() {
  return <DgraphMonitoringPage />;
}
```

Create the directory structure: `src/app/monitoring/dgraph/` (mkdir -p if needed).

This follows the Next.js App Router convention where `page.tsx` is a server component that renders a client component.
  </action>
  <verify>Run `npx tsc --noEmit`. Run `npm run build` to confirm the route compiles. Verify the route exists at `/monitoring/dgraph`. Check that all 6 dgraph component imports resolve.</verify>
  <done>DgraphMonitoringPage renders topology (2/3) + events (1/3) in top row, scatter (1/2) + shard (1/2) in bottom row. Node click opens popover, expand opens Sheet with full details. Route /monitoring/dgraph serves the page.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. Route `/monitoring/dgraph` exists and renders the page
4. NodePopover positions correctly near the clicked node
5. NodeDetailPanel renders inside Sheet with metrics, connections, QPS
6. RecentEvents shows 10 events with severity badges and relative timestamps
7. All 7 DGRP requirements are addressed across Plans 04-01, 04-02, and 04-03
8. Page layout is responsive (stacks on mobile, grid on desktop)
</verification>

<success_criteria>
- Clicking a topology node opens a floating popover with CPU/Memory/Disk bars and QPS
- Clicking the expand icon in popover opens the Sheet side panel with full details
- Clicking outside popover or SVG background closes the popover
- Sheet shows connections list, metric cards, and node information
- RecentEvents lists 10 events sorted by timestamp, with colored severity badges
- Page layout: topology + events on top, scatter + shard on bottom
- All components properly composed in DgraphMonitoringPage
- Route /monitoring/dgraph accessible via Next.js App Router
</success_criteria>

<output>
After completion, create `.planning/phases/04-dgraph-monitoring/04-03-SUMMARY.md`
</output>
