---
phase: 01-foundation-data-layer
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/charts/shared/chart-utils.ts
  - src/components/charts/shared/chart-theme.ts
  - src/components/charts/shared/chart-tooltip.ts
  - src/components/charts/shared/ChartSkeleton.tsx
  - src/components/charts/shared/ChartEmpty.tsx
autonomous: true
requirements:
  - FOUN-05
  - FOUN-06
  - FOUN-07
  - UX-01
  - UX-02
  - UX-03

must_haves:
  truths:
    - "cleanupD3Svg()로 D3 SVG를 안전하게 정리하고 ResizeObserver로 반응형 리사이즈를 처리할 수 있다"
    - "getChartColors()가 현재 테마의 CSS 변수를 resolve하여 D3에서 사용 가능한 색상 객체를 반환한다"
    - "createTooltip()으로 D3 차트 위에 일관된 스타일의 툴팁을 show/hide/destroy 할 수 있다"
    - "차트 로딩 중 스켈레톤, 데이터 없을 때 빈 상태 컴포넌트가 data-testid와 함께 렌더된다"
  artifacts:
    - path: "src/components/charts/shared/chart-utils.ts"
      provides: "D3 chart utility functions"
      exports: ["cleanupD3Svg", "formatNumber", "generateTimeSeriesData", "addJitter", "createDebouncedResizeObserver"]
      min_lines: 40
    - path: "src/components/charts/shared/chart-theme.ts"
      provides: "CSS variable resolver for D3 chart colors"
      exports: ["ChartColors", "getChartColors", "resolveColor", "isLightTheme"]
      min_lines: 40
    - path: "src/components/charts/shared/chart-tooltip.ts"
      provides: "D3 tooltip factory"
      exports: ["TooltipInstance", "createTooltip"]
      min_lines: 30
    - path: "src/components/charts/shared/ChartSkeleton.tsx"
      provides: "Loading skeleton for D3 charts"
      contains: "data-testid"
    - path: "src/components/charts/shared/ChartEmpty.tsx"
      provides: "Empty state for D3 charts"
      contains: "data-testid"
  key_links:
    - from: "src/components/charts/shared/chart-theme.ts"
      to: "src/app/globals.css"
      via: "getComputedStyle CSS variable resolution"
      pattern: "getComputedStyle.*--color-chart"
    - from: "src/components/charts/shared/chart-tooltip.ts"
      to: "src/app/globals.css"
      via: "CSS variable references for tooltip styling"
      pattern: "--color-material-tooltip"
---

<objective>
D3 차트 공통 유틸리티 3종 + 로딩/빈 상태 UX 컴포넌트 2종 구축

Purpose: 이후 모든 D3 차트(19개)가 공통으로 사용하는 유틸리티를 제공한다. SVG 클린업, ResizeObserver, 숫자 포매팅, 테마 색상 해석, 툴팁 팩토리를 표준화하여 각 차트에서 반복 구현을 방지한다. 로딩/빈 상태 컴포넌트로 차트 UX 일관성을 확보한다.

Output: chart-utils.ts, chart-theme.ts, chart-tooltip.ts, ChartSkeleton.tsx, ChartEmpty.tsx
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-layer/01-RESEARCH.md (D3 utility API design, tooltip pattern, loading/empty state examples)
@.planning/phases/01-foundation-data-layer/01-01-SUMMARY.md (CSS tokens, shadcn components installed)
@/Users/chs/Downloads/exemble-ontology-docs-v1.3/03_D3-Visualization-Spec.md (section 1.7 tooltip, section 1.2 chart template)
</context>

<tasks>

<task type="auto">
  <name>Task 1: D3 차트 유틸리티 3종 (chart-utils, chart-theme, chart-tooltip)</name>
  <files>
    src/components/charts/shared/chart-utils.ts
    src/components/charts/shared/chart-theme.ts
    src/components/charts/shared/chart-tooltip.ts
  </files>
  <action>
    `src/components/charts/shared/` 디렉토리 생성 후 3개 유틸리티 파일을 작성한다.

    **chart-utils.ts:**

    ```
    cleanupD3Svg(container: HTMLElement | null): void
    ```
    - container가 null이면 early return
    - d3.select(container).selectAll("*").interrupt() 로 진행 중인 트랜지션 중단
    - container.innerHTML = "" 로 SVG 내용 제거
    - 이 패턴은 D3 Viz Spec의 언마운트 정리 요구사항을 충족

    ```
    formatNumber(value: number): string
    ```
    - >= 1_000_000 → `${(value/1_000_000).toFixed(1)}M`
    - >= 1_000 → `${(value/1_000).toFixed(1)}K`
    - else → value.toLocaleString()
    - 소수점이 .0이면 제거 (1.0K → 1K)

    ```
    generateTimeSeriesData(points: number, range: [number, number], startTime?: Date): Array<{time: Date; value: number}>
    ```
    - startTime 기본값: 현재 시각에서 points * 5분 전
    - 각 포인트: { time: startTime + i * 5분, value: range[0] + random * (range[1] - range[0]) }
    - 자연스러운 변동: 이전 값 기반 random walk (급격한 변화 방지)

    ```
    addJitter(value: number, percent?: number): number
    ```
    - percent 기본값: 5
    - return value + (Math.random() - 0.5) * 2 * value * (percent / 100)

    ```
    createDebouncedResizeObserver(callback: (width: number, height: number) => void, delay?: number): ResizeObserver
    ```
    - delay 기본값: 150ms
    - ResizeObserver 생성하되 callback을 setTimeout으로 디바운스
    - 이전 timeout은 clearTimeout으로 정리
    - entry.contentRect에서 width, height 추출

    D3 import는 선택적 sub-module: `import { select, selectAll } from "d3-selection"`

    **chart-theme.ts:**

    ```
    interface ChartColors
    ```
    - chart1~chart8: string (8개 시리즈 색상)
    - text, textSecondary: string (축 레이블)
    - border: string (차트 테두리)
    - background: string (차트 배경)
    - axisLine, tickLine, gridLine: string (축/그리드)
    - tooltipBg, tooltipText: string (툴팁)

    ```
    getChartColors(): ChartColors
    ```
    - `getComputedStyle(document.documentElement)` 로 CSS 변수 resolve
    - 각 ChartColors 프로퍼티를 해당 CSS 변수에서 추출
    - 예: chart1 → `--color-chart-1`, text → `--color-text-primary`, tooltipBg → `--color-material-tooltip`

    ```
    resolveColor(cssVar: string): string
    ```
    - `getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim()`
    - cssVar에 `--` prefix가 없으면 자동 추가

    ```
    isLightTheme(): boolean
    ```
    - `!document.documentElement.classList.contains('dark')`

    **chart-tooltip.ts:**

    ```
    interface TooltipInstance { show, hide, destroy }
    ```

    ```
    createTooltip(): TooltipInstance
    ```
    - `document.createElement('div')` 로 tooltip div 생성
    - 스타일: position absolute, pointer-events none, z-index 9999, padding 8px 12px, border-radius 6px
    - 배경색: `var(--color-material-tooltip)`, 글자색: `var(--color-mono-white)`, font-size 12px
    - opacity 0 + transition opacity 150ms
    - document.body에 append

    - `show(content: string, event: MouseEvent)`: innerHTML = content, opacity = 1, left/top 계산 (커서 오른쪽 12px, 위 12px, 뷰포트 경계 보정)
    - `hide()`: opacity = 0
    - `destroy()`: document.body에서 removeChild

    경계 보정: tooltip이 뷰포트 오른쪽/아래를 벗어나면 커서 왼쪽/위에 배치
  </action>
  <verify>
    - `npx tsc --noEmit` → 3개 파일 모두 타입 에러 없음
    - `grep "export function cleanupD3Svg" src/components/charts/shared/chart-utils.ts` → 존재
    - `grep "export function getChartColors" src/components/charts/shared/chart-theme.ts` → 존재
    - `grep "export function createTooltip" src/components/charts/shared/chart-tooltip.ts` → 존재
    - `grep "export function addJitter" src/components/charts/shared/chart-utils.ts` → 존재
    - `grep "export function createDebouncedResizeObserver" src/components/charts/shared/chart-utils.ts` → 존재
  </verify>
  <done>
    chart-utils.ts에 cleanupD3Svg/formatNumber/generateTimeSeriesData/addJitter/createDebouncedResizeObserver 5개 함수가 export되고, chart-theme.ts에 ChartColors/getChartColors/resolveColor/isLightTheme가 export되고, chart-tooltip.ts에 TooltipInstance/createTooltip이 export되고, TypeScript 컴파일 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: 차트 로딩 스켈레톤 + 빈 상태 컴포넌트 (data-testid 포함)</name>
  <files>
    src/components/charts/shared/ChartSkeleton.tsx
    src/components/charts/shared/ChartEmpty.tsx
  </files>
  <action>
    **ChartSkeleton.tsx:**
    - "use client" 지시문
    - `cn()` 유틸 import: `import { cn } from "@/lib/utils"`
    - Props: `{ className?: string }`
    - 렌더링: 최소 높이 200px, rounded-lg, bg-muted, animate-pulse
    - 내부: 원형 pulse 아이콘 + "Loading chart..." 텍스트
    - `data-testid="chart-skeleton"` 속성 필수

    **ChartEmpty.tsx:**
    - "use client" 지시문
    - `cn()` 유틸 import
    - `BarChart3` 아이콘 import: `import { BarChart3 } from "lucide-react"` (shadcn이 lucide-react 설치)
    - Props: `{ message?: string; className?: string }`
    - message 기본값: "No data available"
    - 렌더링: 최소 높이 200px, border-dashed, border-border
    - 내부: BarChart3 아이콘 (h-8 w-8 opacity-50) + message 텍스트
    - `data-testid="chart-empty"` 속성 필수

    data-testid 패턴 (UX-03 요구사항): `{action}-{target}` 형식
    - chart-skeleton (로딩 상태)
    - chart-empty (빈 상태)

    두 컴포넌트 모두 Tailwind 유틸리티 클래스만 사용 (shadcn의 `cn()` 으로 조합). shadcn Card를 래퍼로 사용하지 않음 — 차트 컨테이너 내부에 직접 배치되므로.
  </action>
  <verify>
    - `npx tsc --noEmit` → 타입 에러 없음
    - `grep "data-testid" src/components/charts/shared/ChartSkeleton.tsx` → "chart-skeleton"
    - `grep "data-testid" src/components/charts/shared/ChartEmpty.tsx` → "chart-empty"
    - `grep "use client" src/components/charts/shared/ChartSkeleton.tsx` → 존재
    - `grep "lucide-react" src/components/charts/shared/ChartEmpty.tsx` → BarChart3 import
    - `npm run build` → 빌드 성공
  </verify>
  <done>
    ChartSkeleton.tsx와 ChartEmpty.tsx가 data-testid 속성을 갖고 렌더 가능하며, cn() 유틸과 lucide-react 아이콘을 올바르게 사용하고, TypeScript/빌드 성공
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` → 5개 파일 모두 컴파일 성공
2. `npm run build` → 빌드 성공
3. chart-utils.ts에 5개 함수, chart-theme.ts에 4개 export, chart-tooltip.ts에 2개 export
4. ChartSkeleton/ChartEmpty에 data-testid 속성 존재
</verification>

<success_criteria>
- D3 차트 유틸리티 3종이 올바른 API로 export되고 TypeScript 컴파일 성공
- ChartSkeleton, ChartEmpty 컴포넌트가 data-testid 포함하여 렌더 가능
- 모든 파일이 src/components/charts/shared/ 에 위치
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-03-SUMMARY.md`
</output>
