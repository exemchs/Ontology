---
phase: 01-foundation-data-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - supabase/migrations/20260219000000_initial_schema.sql
autonomous: true
requirements:
  - FOUN-04
  - DATA-01
  - DATA-02

must_haves:
  truths:
    - "TypeScript 타입을 import하여 클러스터, 노드, GPU, 온톨로지 등 도메인 객체를 타입 안전하게 다룰 수 있다"
    - "Supabase 8개 테이블 스키마가 SQL 파일로 정의되어 있고 시드 데이터가 포함되어 있다"
    - "시드 데이터에 SKS-FAB1-PROD 클러스터, 12노드, 4 GPU, 6 온톨로지 타입, 5 유저가 있다"
  artifacts:
    - path: "src/types/index.ts"
      provides: "All domain type definitions"
      exports: ["Role", "PiiLevel", "Cluster", "ClusterNode", "Gpu", "OntologyType", "Query", "Alert", "User", "Metric", "TimeSeriesPoint", "GaugeData", "PiiFieldConfig"]
      min_lines: 80
    - path: "supabase/migrations/20260219000000_initial_schema.sql"
      provides: "Supabase schema + seed data"
      contains: "SKS-FAB1-PROD"
      min_lines: 80
  key_links:
    - from: "src/types/index.ts"
      to: "domain model"
      via: "TypeScript type exports"
      pattern: "export (type|interface)"
---

<objective>
TypeScript 도메인 타입 정의 + Supabase 스키마/시드 데이터 SQL 작성

Purpose: 나머지 모든 Phase 1 작업(데이터 파일, 차트 유틸)이 의존하는 TypeScript 타입을 정의하고, Supabase 8테이블 스키마와 시드 데이터를 SQL로 준비한다. Plan 01과 파일 겹침이 없으므로 동시 실행 가능.

Output: src/types/index.ts (모든 도메인 타입), supabase/migrations/ SQL (스키마 + 시드)
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-layer/01-RESEARCH.md (TypeScript types Example 3, Supabase SQL Example 4)
@/Users/chs/Downloads/exemble-ontology-docs-v1.3/02_Data-Schema.md (table schemas, seed data, PII types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript 도메인 타입 정의 (types/index.ts)</name>
  <files>
    src/types/index.ts
  </files>
  <action>
    `src/types/` 디렉토리 생성 후 `index.ts` 작성. PRD Data Schema + 연구 파일의 Example 3을 기반으로 모든 도메인 타입을 정의한다.

    포함할 타입:

    **RBAC Types:**
    - `Role` = "super_admin" | "service_app" | "data_analyst" | "auditor"
    - `PiiLevel` = "highest" | "high" | "medium" | "low" | "none"

    **Cluster & Node Types:**
    - `NodeType` = "zero" | "alpha" | "shard"
    - `NodeStatus` = "healthy" | "warning" | "error"
    - `ClusterStatus` = "healthy" | "warning" | "error"
    - `Cluster` interface (id, name, status, version, nodeCount, replicationFactor, createdAt, updatedAt)
    - `ClusterNode` interface (id, clusterId, name, type, status, host, port, cpuUsage, memoryUsage, diskUsage)

    **GPU Types:**
    - `GpuStatus` = "healthy" | "warning" | "error"
    - `Gpu` interface (id, nodeId, name, model, status, utilization, memoryUsed, memoryTotal, temperature, powerUsage, powerLimit)

    **Ontology Types:**
    - `OntologyType` interface (id, name, description, nodeCount, predicates, relations with name/target/direction)

    **Query Types:**
    - `QueryType` = "graphql" | "dql"
    - `QueryStatus` = "pending" | "completed" | "error"
    - `Query` interface (id, userId, queryText, queryType, status, executionTime, resultCount, createdAt)

    **Alert Types:**
    - `AlertSeverity` = "error" | "warning" | "info"
    - `Alert` interface (id, clusterId, nodeId, severity, title, message, resolved, resolvedAt)

    **User Types:**
    - `User` interface (id, username, email, role, lastLogin, createdAt)

    **Metric Types:**
    - `Metric` interface (id, clusterId?, nodeId?, gpuId?, type, value, unit, timestamp)

    **PII Types:**
    - `PiiFieldConfig` interface (field, level, maskFn as Record of Role to function)

    **Chart Data Types:**
    - `TimeSeriesPoint` interface (time: Date, value: number)
    - `GaugeData` interface (label, value, max, color)

    모든 타입은 named export. camelCase 프로퍼티명 사용 (Supabase snake_case와 매핑은 데이터 레이어에서 처리). TypeScript strict mode 호환 필수.
  </action>
  <verify>
    - `npx tsc --noEmit` → 타입 에러 없음
    - `grep "export" src/types/index.ts | wc -l` >= 15 (최소 15개 export)
    - `grep "Role" src/types/index.ts` → Role 타입 존재
    - `grep "ClusterNode" src/types/index.ts` → ClusterNode 인터페이스 존재
    - `grep "PiiFieldConfig" src/types/index.ts` → PII 타입 존재
  </verify>
  <done>
    src/types/index.ts에 Role, PiiLevel, Cluster, ClusterNode, Gpu, OntologyType, Query, Alert, User, Metric, PiiFieldConfig, TimeSeriesPoint, GaugeData 등 모든 도메인 타입이 정의되고 TypeScript 컴파일 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: Supabase 스키마 + 시드 데이터 SQL 마이그레이션</name>
  <files>
    supabase/migrations/20260219000000_initial_schema.sql
  </files>
  <action>
    `supabase/migrations/` 디렉토리 생성 후 단일 SQL 파일에 스키마 + 시드 데이터를 작성한다.

    **스키마 (8 테이블, snake_case):**

    1. `clusters` — id(SERIAL PK), name(VARCHAR NOT NULL), status(VARCHAR DEFAULT 'healthy'), version(VARCHAR), node_count(INT DEFAULT 0), replication_factor(INT DEFAULT 3), created_at(TIMESTAMPTZ DEFAULT now()), updated_at(TIMESTAMPTZ DEFAULT now())

    2. `nodes` — id(SERIAL PK), cluster_id(INT FK→clusters), name(VARCHAR NOT NULL), type(VARCHAR NOT NULL), status(VARCHAR DEFAULT 'healthy'), host(VARCHAR), port(INT), cpu_usage(REAL DEFAULT 0), memory_usage(REAL DEFAULT 0), disk_usage(REAL DEFAULT 0), created_at(TIMESTAMPTZ), updated_at(TIMESTAMPTZ)

    3. `gpus` — id(SERIAL PK), node_id(INT FK→nodes), name(VARCHAR NOT NULL), model(VARCHAR), status(VARCHAR DEFAULT 'healthy'), utilization(REAL), memory_used(REAL), memory_total(REAL), temperature(REAL), power_usage(REAL), power_limit(REAL)

    4. `metrics` — id(SERIAL PK), cluster_id(INT FK→clusters), node_id(INT FK→nodes), gpu_id(INT FK→gpus), type(VARCHAR NOT NULL), value(REAL NOT NULL), unit(VARCHAR), timestamp(TIMESTAMPTZ DEFAULT now())

    5. `ontology_types` — id(SERIAL PK), name(VARCHAR NOT NULL UNIQUE), description(TEXT), node_count(INT DEFAULT 0), predicates(JSONB DEFAULT '[]'), relations(JSONB DEFAULT '[]')

    6. `queries` — id(SERIAL PK), user_id(INT), query_text(TEXT NOT NULL), query_type(VARCHAR DEFAULT 'graphql'), status(VARCHAR DEFAULT 'pending'), execution_time(INT), result_count(INT), created_at(TIMESTAMPTZ DEFAULT now())

    7. `alerts` — id(SERIAL PK), cluster_id(INT FK→clusters), node_id(INT FK→nodes), severity(VARCHAR NOT NULL), title(VARCHAR NOT NULL), message(TEXT), resolved(BOOLEAN DEFAULT false), resolved_at(TIMESTAMPTZ)

    8. `users` — id(SERIAL PK), username(VARCHAR NOT NULL UNIQUE), email(VARCHAR NOT NULL), password(VARCHAR NOT NULL), role(VARCHAR DEFAULT 'data_analyst'), last_login(TIMESTAMPTZ), created_at(TIMESTAMPTZ DEFAULT now())
       - FK: queries.user_id → users.id (ALTER TABLE after users created)

    **RLS 설정 (POC용):**
    - 모든 테이블에 RLS 활성화
    - 모든 테이블에 "Allow anon select" 정책 (FOR SELECT USING (true))

    **시드 데이터 (연구 파일 Example 4 참조):**
    - 1 cluster: SKS-FAB1-PROD, healthy, v23.1.0, 12노드, RF 3
    - 12 nodes: sks-zero-01~03 (zero), sks-alpha-01~06 (alpha), sks-compute-01~03 (alpha)
      - sks-alpha-03: warning 상태
      - sks-compute-03: error 상태
      - CPU/Memory/Disk usage 값은 연구 파일의 정확한 값 사용
    - 4 GPUs: GPU-0~3 (node_id 10, 10, 11, 11)
      - A100 80GB × 2, A100 40GB × 2
      - GPU-2: warning 상태
    - 6 ontology_types: Equipment(832), Process(24500), Wafer(156000), Recipe(310), Defect(48800), MaintenanceRecord(3820)
      - predicates와 relations는 JSONB 형식 (연구 파일 Example 4 참조)
    - 5 users: admin(super_admin), api-server(service_app), analyst1(data_analyst), auditor1(auditor), operator1(service_app)
      - password는 placeholder hash 값

    SQL 파일 상단에 용도 설명 주석 포함. `supabase/migrations/` 경로에 저장하여 버전 관리. 실제 적용은 Supabase Dashboard SQL Editor에서 수동 실행.
  </action>
  <verify>
    - `cat supabase/migrations/20260219000000_initial_schema.sql | grep "CREATE TABLE" | wc -l` = 8
    - `grep "SKS-FAB1-PROD" supabase/migrations/20260219000000_initial_schema.sql` → 시드 데이터 존재
    - `grep "INSERT INTO users" supabase/migrations/20260219000000_initial_schema.sql` → 5명 유저
    - `grep "ENABLE ROW LEVEL SECURITY" supabase/migrations/20260219000000_initial_schema.sql` → RLS 활성화
    - SQL 문법 에러 검증: `grep -c ";" supabase/migrations/20260219000000_initial_schema.sql` >= 30
  </verify>
  <done>
    supabase/migrations/ SQL에 8테이블 스키마(snake_case) + RLS 정책 + 시드 데이터(1 cluster, 12 nodes, 4 GPUs, 6 ontology types, 5 users)가 포함되어 있다
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` → TypeScript 컴파일 성공 (types 파일 포함)
2. `ls supabase/migrations/` → SQL 파일 존재
3. `grep -c "export" src/types/index.ts` >= 15 → 충분한 타입 export
4. SQL에 8개 CREATE TABLE + INSERT 문 포함
</verification>

<success_criteria>
- src/types/index.ts에서 모든 도메인 타입을 named export로 import 가능
- Supabase SQL 파일에 8테이블 스키마, RLS, 시드 데이터 완비
- TypeScript 컴파일 성공
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-02-SUMMARY.md`
</output>
