---
phase: 07-query-console-rbac
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/components/query/views/ForceGraphView.tsx
  - src/components/query/views/TreemapView.tsx
  - src/components/query/views/ArcDiagramView.tsx
  - src/components/query/views/ScatterView.tsx
  - src/components/query/views/DistributionView.tsx
  - src/components/query/QueryConsole.tsx
autonomous: true
requirements: [QURY-05, QURY-06, QURY-07, QURY-08, QURY-09]

must_haves:
  truths:
    - "Graph 뷰에서 장비-위치 Bipartite Force 그래프가 렌더되고 노드를 드래그할 수 있다"
    - "Treemap 뷰에서 장비 타입별 그룹이 색상 구분된 사각형으로 표시된다"
    - "Arc Diagram 뷰에서 Equipment-Bay 연결이 곡선 아크로 표시된다"
    - "Scatter 뷰에서 Location x Complexity 산점도가 렌더되고 Brush로 영역 선택이 가능하다"
    - "Distribution 뷰에서 Stacked/Grouped 토글로 Location x Type 바 차트가 전환된다"
    - "모든 D3 차트가 다크/라이트 테마 전환에 반응한다"
    - "ResultViewBar에서 뷰 전환 시 해당 D3 차트가 표시된다"
  artifacts:
    - path: "src/components/query/views/ForceGraphView.tsx"
      provides: "Bipartite force graph (equipment left, location right)"
      contains: "forceSimulation"
      min_lines: 80
    - path: "src/components/query/views/TreemapView.tsx"
      provides: "Equipment type treemap"
      contains: "treemap"
      min_lines: 60
    - path: "src/components/query/views/ArcDiagramView.tsx"
      provides: "Arc diagram with curved links"
      contains: "arc"
      min_lines: 60
    - path: "src/components/query/views/ScatterView.tsx"
      provides: "Brushable scatter plot"
      contains: "brush"
      min_lines: 70
    - path: "src/components/query/views/DistributionView.tsx"
      provides: "Stacked/Grouped bar chart"
      contains: "stack"
      min_lines: 80
  key_links:
    - from: "src/components/query/views/ForceGraphView.tsx"
      to: "src/components/charts/shared/chart-utils.ts"
      via: "cleanupD3Svg, createDebouncedResizeObserver"
      pattern: "cleanupD3Svg|createDebouncedResizeObserver"
    - from: "src/components/query/views/ScatterView.tsx"
      to: "d3-brush"
      via: "d3.brush() for 2D selection"
      pattern: "d3\\.brush"
    - from: "src/components/query/QueryConsole.tsx"
      to: "src/components/query/views/"
      via: "dynamic view switching based on activeView state"
      pattern: "ForceGraphView|TreemapView|ArcDiagramView|ScatterView|DistributionView"
---

<objective>
Query Console의 5종 D3 시각화 뷰(Force Graph, Treemap, Arc Diagram, Scatter, Distribution)를 구현하고 ResultViewBar에 연결한다.

Purpose: 쿼리 결과를 다양한 시각적 관점에서 탐색할 수 있도록 5개 D3.js 차트를 추가한다. 이 차트들은 기존 chart-utils 패턴(useRef + useEffect + ResizeObserver + cleanupD3Svg)을 따르며, Plan 01에서 만든 뷰 전환 인프라에 플러그인된다.
Output: 6종 뷰(Table + 5 D3) 전환이 완전히 동작하는 Query Console 결과 영역.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-query-console-rbac/07-RESEARCH.md
@.planning/phases/07-query-console-rbac/07-01-SUMMARY.md
@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
@src/data/query-data.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ForceGraphView + TreemapView + ArcDiagramView (3 D3 차트)</name>
  <files>
    src/components/query/views/ForceGraphView.tsx
    src/components/query/views/TreemapView.tsx
    src/components/query/views/ArcDiagramView.tsx
  </files>
  <action>
모든 D3 차트는 프로젝트 기존 패턴을 따른다: "use client", useRef + useEffect + ResizeObserver, cleanupD3Svg 호출, getChartColors() 테마 색상, createTooltip() 호버 정보.

1. `src/components/query/views/ForceGraphView.tsx`:
   - Props: `data: Record<string, unknown>[]` (쿼리 결과 데이터)
   - 데이터 변환: 장비(equipment)와 위치(location) 노드 추출, 간선 생성
   - d3.forceSimulation 사용:
     - forceLink: id 기반, distance 120
     - forceManyBody: strength -200
     - forceX: equipment는 width*0.3, location은 width*0.7 (bipartite 레이아웃)
     - forceY: height/2, strength 0.1
     - alphaDecay: 0.02 (3초 내 안정화)
   - 노드: 원형, equipment 타입은 chart1 색상, location 타입은 chart2 색상
   - 간선: 직선 path, opacity 0.4
   - 드래그: d3.drag로 노드 위치 변경 가능
   - 호버: createTooltip으로 노드 ID + 타입 표시
   - 반응형: createDebouncedResizeObserver로 리사이즈 대응

2. `src/components/query/views/TreemapView.tsx`:
   - Props: `data: Record<string, unknown>[]`
   - 데이터 변환: 장비를 타입별(CVD/Etcher/Furnace/CMP)로 그룹핑 -> d3.hierarchy 구조
   - d3.treemap().size([width, height]).padding(2).round(true)
   - root = d3.hierarchy(hierarchyData).sum(d => d.value).sort((a,b) => b.value - a.value)
   - 리프 노드: rect (fill = colorScale per equipment type), rx=2
   - 텍스트 라벨: 사각형 크기가 충분할 때만 표시 (width > 50 && height > 20)
   - 호버: tooltip에 장비명 + 타입 + 값 표시
   - colorScale: scaleOrdinal, chart1~chart4 색상

3. `src/components/query/views/ArcDiagramView.tsx`:
   - Props: `data: Record<string, unknown>[]`
   - 데이터 변환: Equipment/Bay 노드 추출, 연결 링크 생성
   - 노드를 x축 하단에 scalePoint로 배치
   - 아크: SVG path로 반원 곡선 (M x1,yBase A rx,ry 0 0,1 x2,yBase)
   - 아크 높이 = abs(x2-x1) * 0.5 (거리에 비례)
   - 노드 라벨: 45도 회전 텍스트 (겹침 방지, research pitfall #7 대응)
   - 호버: 연결된 아크 하이라이트 (opacity 1, 나머지 0.15)
   - 노드: 원형 마커, chart1 색상
   - 아크: chart2 색상, opacity 0.5, 호버 시 1.0
  </action>
  <verify>
    - `npm run build` 성공
    - 3개 뷰 컴포넌트 파일 존재, TypeScript 오류 없음
    - `npm run lint` 통과
  </verify>
  <done>
    ForceGraphView에서 bipartite 레이아웃 노드가 렌더되고 드래그 가능하며, TreemapView에서 타입별 사각형이 색상 구분되고, ArcDiagramView에서 곡선 연결이 표시된다. 모든 차트가 테마 색상과 반응형 리사이즈에 대응한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: ScatterView + DistributionView + QueryConsole 뷰 연결</name>
  <files>
    src/components/query/views/ScatterView.tsx
    src/components/query/views/DistributionView.tsx
    src/components/query/QueryConsole.tsx
  </files>
  <action>
1. `src/components/query/views/ScatterView.tsx`:
   - Props: `data: Record<string, unknown>[]`
   - 데이터 변환: location(x축) x complexity(y축) 산점도 데이터 생성
   - x축: scaleLinear (location index 또는 값)
   - y축: scaleLinear (complexity 값)
   - 점: 원형, r=5, chart1 색상, opacity 0.7
   - Brush 선택 (d3.brush):
     - extent: [[margin.left, margin.top], [width-margin.right, height-margin.bottom]]
     - brush 이벤트: 선택 영역 내 점 opacity 1 + chart2 색상, 외부 점 opacity 0.15
     - brush 해제: 모든 점 원래 상태 복원
   - 주의: brush만 사용, zoom 미사용 (충돌 방지, research pitfall #6)
   - 축: d3.axisBottom, d3.axisLeft
   - 호버: tooltip에 라벨 + x/y 값 표시

2. `src/components/query/views/DistributionView.tsx`:
   - Props: `data: Record<string, unknown>[]`
   - 내부 state: mode ("stacked" | "grouped"), 토글 버튼
   - 데이터 변환: location별 type 카운트 -> { location, CVD, Etcher, Furnace, CMP }
   - Stacked 모드:
     - d3.stack().keys(types) -> stacked series
     - yScale domain: [0, max stacked sum]
     - rect: stacked position
   - Grouped 모드:
     - xSub = scaleBand().domain(types).range([0, xScale.bandwidth()])
     - rect: 나란히 배치
   - 모드 전환 시 D3 transition (duration 400ms)
   - colorScale: scaleOrdinal, chart1~chart4
   - 축: scaleBand (x), scaleLinear (y)
   - 범례: 하단에 타입별 색상 표시

3. QueryConsole.tsx 수정 (Plan 01에서 생성된 파일):
   - 기존 placeholder "Coming soon" 영역을 실제 뷰 컴포넌트로 교체:
     - "table" -> TableView (이미 Plan 01에서 구현)
     - "graph" -> ForceGraphView
     - "treemap" -> TreemapView
     - "arc" -> ArcDiagramView
     - "scatter" -> ScatterView
     - "distribution" -> DistributionView
   - 각 뷰에 activeTab의 결과 데이터를 props로 전달
   - query-data.ts에서 시각화용 데이터 함수 추가 필요 시 getQueryResultData() 생성:
     - 장비-위치 쌍, 타입 분포, location-complexity 매핑 등 통합 데이터
     - 모든 뷰가 같은 "쿼리 결과"를 다른 각도로 보여줌
  </action>
  <verify>
    - `npm run build` 성공
    - /workspace/query에서 ResultViewBar 아이콘 클릭 시 6종 뷰 전환 동작
    - Scatter 뷰에서 brush 드래그로 점 선택/해제 동작
    - Distribution 뷰에서 Stacked/Grouped 토글 동작
    - 다크/라이트 테마 전환 시 모든 D3 차트 색상 반응
    - `npm run lint` 통과
  </verify>
  <done>
    Query Console에서 6종 뷰(Table/Graph/Treemap/Arc/Scatter/Distribution) 전환이 완전히 동작한다. ScatterView에서 Brush 선택으로 점이 필터링되고, DistributionView에서 Stacked/Grouped 전환이 애니메이션으로 동작한다. 모든 D3 차트가 테마 반응형이고 ResizeObserver로 리사이즈에 대응한다.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` 성공
2. ResultViewBar에서 6종 아이콘 클릭 시 각 뷰로 전환
3. Force Graph: 노드 드래그, bipartite 레이아웃, 3초 내 안정화
4. Treemap: 타입별 색상 사각형, 호버 tooltip
5. Arc Diagram: 곡선 아크, 호버 하이라이트, 45도 라벨
6. Scatter: Brush 영역 선택 -> 점 필터링, 해제 시 복원
7. Distribution: Stacked/Grouped 토글, transition 애니메이션
8. 다크/라이트 테마 전환 시 모든 차트 색상 반응
</verification>

<success_criteria>
- 5개 D3 시각화가 모두 렌더되고 각각의 인터랙션(드래그, Brush, 토글)이 동작
- ResultViewBar에서 6종 뷰 전환이 매끄럽게 동작
- 모든 차트가 getChartColors()를 통해 테마 색상 사용
- cleanupD3Svg로 언마운트 시 메모리 누수 없이 정리
- TypeScript strict mode 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/07-query-console-rbac/07-02-SUMMARY.md`
</output>
