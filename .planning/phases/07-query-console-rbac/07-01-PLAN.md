---
phase: 07-query-console-rbac
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/workspace/query/page.tsx
  - src/components/query/QueryConsole.tsx
  - src/components/query/QueryEditor.tsx
  - src/components/query/QueryModeToggle.tsx
  - src/components/query/TemplateSelector.tsx
  - src/components/query/QueryHistory.tsx
  - src/components/query/ResultTabs.tsx
  - src/components/query/ResultViewBar.tsx
  - src/components/query/views/TableView.tsx
autonomous: true
requirements: [QURY-01, QURY-02, QURY-03, QURY-04, QURY-10]

must_haves:
  truths:
    - "CodeMirror 에디터에 라인 넘버가 표시되고 코드를 입력할 수 있다"
    - "GraphQL/DQL 모드를 토글하면 문법 하이라이팅이 전환된다"
    - "템플릿 드롭다운에서 쿼리를 선택하면 에디터에 자동 삽입된다"
    - "쿼리 히스토리 패널에서 과거 쿼리 목록이 표시된다"
    - "Run Query 클릭 시 결과가 새 탭에 나타나고 실행시간 배지가 표시된다"
    - "결과 탭을 최대 5개까지 추가할 수 있고 닫기 버튼으로 제거할 수 있다"
    - "결과 테이블 뷰에서 데이터가 행/열로 표시된다"
  artifacts:
    - path: "src/app/workspace/query/page.tsx"
      provides: "Query Console route page (server component shell)"
      contains: "QueryConsole"
    - path: "src/components/query/QueryConsole.tsx"
      provides: "Main client component orchestrating editor + results"
      min_lines: 80
    - path: "src/components/query/QueryEditor.tsx"
      provides: "CodeMirror 6 editor with line numbers, syntax highlighting, theme"
      contains: "CodeMirror"
    - path: "src/components/query/ResultTabs.tsx"
      provides: "Multi-tab container with max 5, close button, execution time badges"
      min_lines: 40
    - path: "src/components/query/views/TableView.tsx"
      provides: "shadcn Table result view"
      contains: "Table"
  key_links:
    - from: "src/components/query/QueryEditor.tsx"
      to: "@uiw/react-codemirror"
      via: "CodeMirror component import"
      pattern: "import.*CodeMirror.*@uiw/react-codemirror"
    - from: "src/components/query/TemplateSelector.tsx"
      to: "src/data/query-data.ts"
      via: "getQueryTemplates import"
      pattern: "getQueryTemplates|QueryTemplate"
    - from: "src/components/query/QueryConsole.tsx"
      to: "src/components/query/ResultTabs.tsx"
      via: "tab state management"
      pattern: "ResultTabs|addResultTab"
    - from: "src/components/query/QueryEditor.tsx"
      to: "next-themes"
      via: "useTheme for dark/light sync"
      pattern: "useTheme|resolvedTheme"
---

<objective>
Query Console 페이지 셸, CodeMirror 6 에디터, 멀티탭 결과 컨테이너, 테이블 뷰를 구축한다.

Purpose: Phase 7의 핵심 인프라를 세우고, 이후 Plan 02 (D3 시각화)와 Plan 03 (PII 데모)가 플러그인할 구조를 완성한다. CodeMirror 6는 이 프로젝트에서 처음 도입하는 의존성이므로 설치와 SSR 호환성 검증이 포함된다.
Output: 동작하는 Query Console 페이지에서 쿼리를 입력하고 실행하면 결과가 멀티탭 + 테이블로 표시된다.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-query-console-rbac/07-RESEARCH.md
@src/types/index.ts
@src/data/query-data.ts
@src/components/charts/shared/chart-theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CodeMirror 6 설치 + QueryEditor + QueryModeToggle + TemplateSelector + QueryHistory</name>
  <files>
    src/components/query/QueryEditor.tsx
    src/components/query/QueryModeToggle.tsx
    src/components/query/TemplateSelector.tsx
    src/components/query/QueryHistory.tsx
  </files>
  <action>
1. npm 패키지 설치:
   ```bash
   npm install @uiw/react-codemirror cm6-graphql @codemirror/theme-one-dark @codemirror/lang-json
   ```

2. `src/components/query/QueryEditor.tsx` ("use client"):
   - @uiw/react-codemirror의 CodeMirror 컴포넌트 사용 (controlled: value + onChange props)
   - Props: `value: string`, `onChange: (value: string) => void`, `mode: QueryType`
   - mode === "graphql" 이면 `graphql()` extension, "dql" 이면 `json()` extension 사용 (useMemo)
   - basicSetup: lineNumbers: true, foldGutter: true, bracketMatching: true, autocompletion: false
   - height="280px", className="border rounded-md overflow-hidden"
   - next-themes의 useTheme() -> resolvedTheme === "dark" ? oneDark : "light"
   - 주의: "use client" 필수 (CodeMirror는 브라우저 API 의존). SSR 충돌 방지.

3. `src/components/query/QueryModeToggle.tsx` ("use client"):
   - Props: `mode: QueryType`, `onModeChange: (mode: QueryType) => void`
   - shadcn Tabs 또는 두 개의 Button으로 GraphQL / DQL 토글
   - 현재 선택 모드 하이라이트 (primary variant)

4. `src/components/query/TemplateSelector.tsx` ("use client"):
   - Props: `mode: QueryType`, `onSelect: (query: string) => void`
   - query-data.ts의 getQueryTemplates() 호출 -> 현재 mode에 맞는 템플릿만 필터
   - shadcn Select 드롭다운 (name + description 표시)
   - 선택 시 onSelect(template.query) 호출 -> 에디터에 삽입

5. `src/components/query/QueryHistory.tsx` ("use client"):
   - Props: `onSelect: (query: string) => void`
   - query-data.ts의 getQueryHistory() 호출 -> 10개 히스토리 아이템 표시
   - shadcn Sheet (사이드 패널) 또는 collapsible 패널
   - 각 아이템: query snippet (truncated), type 배지, status 배지, executionTime
   - 아이템 클릭 시 onSelect(item.query) -> 에디터에 삽입
  </action>
  <verify>
    - `npm run build` 성공 (CodeMirror SSR 충돌 없음)
    - 4개 컴포넌트 파일이 존재하고 TypeScript 타입 오류 없음
    - `npm run lint` 통과
  </verify>
  <done>
    CodeMirror 에디터가 GraphQL/DQL 모드 전환, 라인 넘버, 다크/라이트 테마 연동으로 동작하고, 템플릿 선택 시 에디터에 코드가 삽입되며, 히스토리 패널에서 과거 쿼리를 선택할 수 있다.
  </done>
</task>

<task type="auto">
  <name>Task 2: QueryConsole 페이지 + ResultTabs 멀티탭 + TableView + ResultViewBar</name>
  <files>
    src/app/workspace/query/page.tsx
    src/components/query/QueryConsole.tsx
    src/components/query/ResultTabs.tsx
    src/components/query/ResultViewBar.tsx
    src/components/query/views/TableView.tsx
  </files>
  <action>
1. `src/components/query/ResultTabs.tsx` ("use client"):
   - ResultTab 인터페이스: { id, label, executionTime, resultCount, queryText, queryType, timestamp }
   - Props: `tabs: ResultTab[]`, `activeTabId: string | null`, `onTabChange`, `onTabClose`
   - shadcn Tabs 기반. 각 탭에:
     - 라벨 텍스트 + 실행시간 배지 (shadcn Badge, e.g. "142ms")
     - 닫기 버튼 (X 아이콘)
   - 최대 5탭 제한은 QueryConsole에서 관리 (addResultTab 시 FIFO eviction)
   - 빈 상태: "쿼리를 실행하면 결과가 여기에 표시됩니다" 메시지

2. `src/components/query/ResultViewBar.tsx` ("use client"):
   - Props: `activeView: ViewType`, `onViewChange: (view: ViewType) => void`
   - ViewType = "table" | "graph" | "treemap" | "arc" | "scatter" | "distribution"
   - 6개 lucide-react 아이콘 버튼 (Table2, Network, LayoutGrid, Activity, ScatterChart, BarChart3 등)
   - 기본 뷰: "table" (per user decision)
   - 아이콘 + 라벨 표시, 선택된 뷰 하이라이트

3. `src/components/query/views/TableView.tsx` ("use client"):
   - Props: `data: Record<string, unknown>[]` (쿼리 결과 배열)
   - shadcn Table (TableHeader, TableBody, TableRow, TableCell)
   - data[0]의 키를 컬럼 헤더로 사용
   - 빈 데이터 시 빈 상태 메시지

4. `src/components/query/QueryConsole.tsx` ("use client"):
   - 전체 Query Console 상태 관리 (main orchestrator):
     - queryText: string (에디터 내용)
     - queryMode: QueryType ("graphql" | "dql")
     - tabs: ResultTab[] (최대 5)
     - activeTabId: string | null
     - activeView: ViewType (현재 결과 뷰 모드)
     - isExecuting: boolean
   - 레이아웃: 상단 = 에디터 영역 (QueryModeToggle + TemplateSelector + QueryEditor + Run 버튼 + QueryHistory 버튼), 하단 = 결과 영역 (ResultTabs + ResultViewBar + 뷰 컴포넌트)
   - "Run Query" 버튼 클릭 시:
     a. isExecuting = true, 200-800ms setTimeout 지연 (시뮬레이션)
     b. query-data.ts에서 mock 결과 데이터 생성 (getQueryResultData 함수 호출 또는 inline 결과)
     c. 새 ResultTab 추가 (id = crypto.randomUUID(), executionTime = 지연시간)
     d. tabs.length > 5 이면 첫 번째 탭 제거 (FIFO)
     e. activeTabId = 새 탭
   - activeView에 따라 뷰 컴포넌트 렌더: table -> TableView, 나머지는 placeholder div "Coming soon" (Plan 02에서 구현)
   - Resizable 패널 고려: 에디터/결과 영역 사이에 드래그 리사이즈 (shadcn ResizablePanelGroup 사용 또는 고정 분할)

5. `src/app/workspace/query/page.tsx`:
   - 서버 컴포넌트 셸: metadata export, QueryConsole import
   - 페이지 타이틀/설명 없이 QueryConsole 전체 렌더 (레이아웃 셸이 Phase 2에서 제공)
  </action>
  <verify>
    - `npm run build` 성공
    - dev 서버에서 /workspace/query 접속 시 에디터 + 결과 영역 렌더
    - Run Query 클릭 시 결과 탭 생성 + 테이블 뷰 표시
    - 탭 닫기 동작, 5탭 초과 시 FIFO 제거 동작
    - `npm run lint` 통과
  </verify>
  <done>
    /workspace/query 페이지에서 CodeMirror 에디터로 쿼리를 입력하고, 모드 토글/템플릿 선택이 동작하며, Run Query 실행 시 결과가 멀티탭(최대 5) + 테이블 뷰로 표시된다. ResultViewBar에서 6종 뷰 전환 UI가 보이고, table 외 뷰는 placeholder 상태이다.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` 전체 빌드 성공 (SSR 충돌 없음)
2. /workspace/query 페이지 로드 시 CodeMirror 에디터가 라인 넘버와 함께 렌더
3. GraphQL/DQL 모드 토글 시 문법 하이라이팅 전환
4. 다크/라이트 테마 전환 시 에디터 테마도 동기화
5. 템플릿 셀렉터에서 쿼리 선택 시 에디터에 삽입
6. Run Query -> 200-800ms 후 결과 탭 생성 + 실행시간 배지
7. 6종 뷰 전환 아이콘바에서 Table 뷰 선택 시 데이터 표시
</verification>

<success_criteria>
- CodeMirror 6 에디터가 GraphQL/DQL 모드, 라인 넘버, 다크/라이트 테마와 함께 동작
- 4개 템플릿에서 선택 시 에디터에 자동 삽입
- 10개 히스토리 아이템이 패널에 표시되고 선택 시 에디터에 삽입
- 멀티탭 최대 5개, FIFO 제거, 실행시간 배지 표시
- Table View에서 결과 데이터가 행/열로 렌더
- TypeScript strict mode 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/07-query-console-rbac/07-01-SUMMARY.md`
</output>
