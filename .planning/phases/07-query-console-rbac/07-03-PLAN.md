---
phase: 07-query-console-rbac
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/components/query/pii/PiiDemo.tsx
  - src/components/query/pii/RoleSelector.tsx
  - src/components/query/pii/RoleInfoBanner.tsx
  - src/components/query/pii/PiiTable.tsx
  - src/components/query/QueryConsole.tsx
autonomous: true
requirements: [RBAC-01, RBAC-02, RBAC-03, RBAC-04, RBAC-05, RBAC-06, RBAC-07, RBAC-08]

must_haves:
  truths:
    - "Role Selector 드롭다운에서 4종 역할(super_admin/service_app/data_analyst/auditor)을 선택할 수 있다"
    - "역할 변경 시 PII 테이블의 마스킹이 실시간으로 전환된다"
    - "super_admin으로 선택하면 모든 필드가 Plain으로 보인다"
    - "auditor로 선택하면 대부분 필드가 Denied/Anonymized로 마스킹된다"
    - "FAB Equipment 탭에 8행 데이터가 표시되고 General PII 탭에 5행 데이터가 표시된다"
    - "마스킹된 셀은 amber(masked) 또는 red(anonymized/denied) 배경색과 아이콘으로 구분된다"
    - "컬럼 헤더에 PII 등급 배지(highest/high/medium/low/none)가 표시된다"
    - "Info Banner에 선택된 역할의 권한 요약 메시지가 표시된다"
  artifacts:
    - path: "src/components/query/pii/PiiDemo.tsx"
      provides: "PII masking demo container with FAB/General tabs"
      contains: "Tabs"
      min_lines: 40
    - path: "src/components/query/pii/RoleSelector.tsx"
      provides: "4-role dropdown selector"
      contains: "Select"
      min_lines: 20
    - path: "src/components/query/pii/RoleInfoBanner.tsx"
      provides: "Role-specific permission summary banner"
      contains: "Banner|Alert"
      min_lines: 30
    - path: "src/components/query/pii/PiiTable.tsx"
      provides: "PII masking table with cell styling and header badges"
      contains: "Table"
      min_lines: 80
  key_links:
    - from: "src/components/query/pii/PiiTable.tsx"
      to: "src/data/pii-config.ts"
      via: "applyPiiMasking and field config imports"
      pattern: "applyPiiMasking|fabPiiFieldConfigs|generalPiiFieldConfigs"
    - from: "src/components/query/pii/PiiTable.tsx"
      to: "src/lib/pii-masking.ts"
      via: "masking function application through pii-config"
      pattern: "PiiAction|getMaskFn"
    - from: "src/components/query/pii/RoleSelector.tsx"
      to: "src/types/index.ts"
      via: "Role type import"
      pattern: "import.*Role.*from.*@/types"
    - from: "src/components/query/pii/PiiDemo.tsx"
      to: "src/data/query-data.ts"
      via: "getPiiDemoData import for FAB + General datasets"
      pattern: "getPiiDemoData|fabEquipmentData|generalPiiData"
---

<objective>
PII 마스킹 시뮬레이터 UI를 구축한다: Role Selector, Info Banner, FAB Equipment/General PII 2탭, 마스킹 셀 스타일링.

Purpose: Phase 7의 킬러 데모 피처인 역할별 PII 마스킹 시연 UI를 완성한다. Phase 1에서 구축한 마스킹 인프라(pii-masking.ts, pii-config.ts, query-data.ts의 PII 데모 데이터)를 UI 레이어에서 소비하여, 역할 전환 시 실시간 마스킹 변화를 시각적으로 보여준다.
Output: Query Console 내에서 역할을 변경하면 PII 필드가 실시간으로 마스킹/해제되는 인터랙티브 데모.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-query-console-rbac/07-RESEARCH.md
@.planning/phases/07-query-console-rbac/07-01-SUMMARY.md
@.planning/phases/01-foundation-data-layer/01-04-SUMMARY.md
@src/data/pii-config.ts
@src/lib/pii-masking.ts
@src/data/query-data.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RoleSelector + RoleInfoBanner + PiiTable 컴포넌트</name>
  <files>
    src/components/query/pii/RoleSelector.tsx
    src/components/query/pii/RoleInfoBanner.tsx
    src/components/query/pii/PiiTable.tsx
  </files>
  <action>
1. `src/components/query/pii/RoleSelector.tsx` ("use client"):
   - Props: `selectedRole: Role`, `onRoleChange: (role: Role) => void`
   - shadcn Select 드롭다운, 4개 옵션:
     - super_admin: "Super Admin" (전체 접근)
     - service_app: "Service App" (서비스 계정)
     - data_analyst: "Data Analyst" (분석가)
     - auditor: "Auditor" (감사인)
   - 각 옵션에 역할 설명 부제 또는 아이콘 표시
   - 현재 선택된 역할 표시

2. `src/components/query/pii/RoleInfoBanner.tsx` ("use client"):
   - Props: `role: Role`
   - 역할별 메시지 (한국어):
     - super_admin: "모든 PII 필드에 전체 접근 권한이 있습니다. 민감 정보가 마스킹 없이 표시됩니다."
     - service_app: "서비스 운영에 필요한 최소 PII 필드만 접근 가능합니다. 일부 필드가 마스킹됩니다."
     - data_analyst: "분석 업무에 필요한 데이터만 접근 가능합니다. 개인 식별 정보는 마스킹됩니다."
     - auditor: "감사 목적으로 제한된 접근 권한이 있습니다. 대부분의 PII 필드가 차단됩니다."
   - 역할별 배경색 구분:
     - super_admin: green/emerald 톤
     - service_app: blue 톤
     - data_analyst: amber 톤
     - auditor: red 톤
   - lucide-react 아이콘: ShieldCheck(super_admin), Server(service_app), BarChart3(data_analyst), Eye(auditor)

3. `src/components/query/pii/PiiTable.tsx` ("use client"):
   - Props: `data: Record<string, string>[]`, `fieldConfigs: PiiFieldRule[]`, `role: Role`
   - 데이터를 useMemo로 마스킹 계산 (role 변경 시 재계산, research pitfall #5 대응):
     ```
     const maskedData = useMemo(() =>
       data.map(row => {
         const maskedRow: Record<string, { value: string; action: PiiAction }> = {};
         for (const [field, value] of Object.entries(row)) {
           const config = fieldConfigs.find(c => c.field === field);
           const action = config?.actions[role] ?? "plain";
           maskedRow[field] = { value: applyPiiMasking(value, field, action), action };
         }
         return maskedRow;
       })
     , [data, fieldConfigs, role]);
     ```
   - 컬럼 헤더:
     - 필드명 표시
     - PII 등급 배지 (shadcn Badge):
       - highest: variant="destructive" (빨간색)
       - high: variant="destructive" (빨간색)
       - medium: variant="default" (기본색)
       - low: variant="secondary" (회색)
       - none: variant="outline" (테두리만)
     - 배지 텍스트: 등급 한글명 또는 영문 (highest/high/medium/low/none)
   - 셀 스타일링:
     - plain: 기본 배경 (스타일 없음)
     - masked: bg-amber-500/10 배경 + EyeOff 아이콘 (amber-500)
     - anonymized: bg-red-500/10 배경 + ShieldAlert 아이콘 (red-500)
     - denied: bg-red-500/10 배경 + Lock 아이콘 (red-500)
   - 셀 내부: 아이콘(왼쪽) + 마스킹된 값(오른쪽) flex row 배치
   - transition-colors duration-200 클래스로 역할 전환 시 부드러운 색상 전환
   - shadcn Table (TableHeader, TableBody, TableRow, TableCell, TableHead) 사용
  </action>
  <verify>
    - 3개 컴포넌트 파일이 존재하고 TypeScript 오류 없음
    - `npm run build` 성공
    - `npm run lint` 통과
  </verify>
  <done>
    RoleSelector에서 4종 역할 선택이 가능하고, RoleInfoBanner에 역할별 권한 메시지가 표시되며, PiiTable에서 마스킹 셀이 amber/red 배경과 아이콘으로 구분된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: PiiDemo 컨테이너 + QueryConsole PII 섹션 통합</name>
  <files>
    src/components/query/pii/PiiDemo.tsx
    src/components/query/QueryConsole.tsx
  </files>
  <action>
1. `src/components/query/pii/PiiDemo.tsx` ("use client"):
   - 내부 state: selectedRole: Role (기본값 "super_admin")
   - 내부 state: activeTab: "fab" | "general" (기본값 "fab")
   - query-data.ts에서 PII 데모 데이터 로드 (getPiiDemoData() 또는 직접 import)
   - pii-config.ts에서 fabPiiFieldConfigs, generalPiiFieldConfigs import
   - 레이아웃 (위에서 아래로):
     a. RoleSelector (selectedRole, onRoleChange)
     b. RoleInfoBanner (selectedRole)
     c. shadcn Tabs (FAB Equipment | General PII):
        - "fab" 탭: PiiTable (data=fabEquipmentData 8행, fieldConfigs=fabPiiFieldConfigs, role=selectedRole)
        - "general" 탭: PiiTable (data=generalPiiData 5행, fieldConfigs=generalPiiFieldConfigs, role=selectedRole)
   - 탭 라벨에 데이터 행 수 표시: "FAB Equipment (8)" / "General PII (5)"

2. QueryConsole.tsx 수정 (Plan 01에서 생성, Plan 02에서도 수정된 파일):
   - PiiDemo 컴포넌트를 Query Console 레이아웃의 적절한 위치에 배치:
     - 방법 A: 결과 영역 아래에 별도 섹션으로 배치 (구분선 + "PII Masking Demo" 제목)
     - 방법 B: ResultTabs의 특별 탭으로 배치 (쿼리 실행과 무관하게 항상 접근 가능)
     - 권장: 방법 A (결과와 독립적인 데모 섹션, 항상 보임) 또는 별도 Card 컴포넌트로 래핑
   - PII 데모 섹션은 쿼리 실행 상태와 무관하게 항상 표시
   - 전체 레이아웃: 에디터 | 결과 뷰 | PII 데모 (3단 구성 또는 2단 + PII 별도)
   - ResizablePanelGroup 사용 시 PII 패널도 리사이즈 가능하게 처리
  </action>
  <verify>
    - `npm run build` 성공
    - /workspace/query에서 PII 데모 섹션이 보임
    - Role Selector에서 역할 변경 시 PII 테이블 마스킹 실시간 전환
    - super_admin: 모든 값 Plain, auditor: 대부분 Denied/Anonymized
    - FAB Equipment 탭: 8행, General PII 탭: 5행
    - 마스킹 셀: amber/red 배경 + 아이콘 구분
    - 컬럼 헤더: PII 등급 배지 표시
    - Info Banner: 역할별 메시지 표시
    - `npm run lint` 통과
  </verify>
  <done>
    Query Console 페이지에서 PII 마스킹 데모가 완전히 동작한다. Role Selector로 4종 역할을 전환하면 FAB Equipment(8행)/General PII(5행) 테이블의 마스킹이 실시간으로 변경되고, amber/red 배경색 + 아이콘 + PII 등급 배지 + Info Banner가 모두 표시된다.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` 성공
2. Role Selector에서 super_admin 선택 -> 모든 PII 필드 Plain (마스킹 없음)
3. Role Selector에서 auditor 선택 -> 대부분 필드 Denied/Anonymized (빨간 배경)
4. Role Selector에서 data_analyst 선택 -> 일부 Masked (amber 배경)
5. FAB Equipment 탭: equipment_id, operator_name, phone, email 등 8행 확인
6. General PII 탭: 5행 확인
7. 컬럼 헤더에 PII 등급 배지 (highest=red, medium=default, none=outline)
8. Info Banner에 역할별 한국어 메시지 표시
9. 역할 전환 시 CSS transition으로 부드러운 전환
</verification>

<success_criteria>
- 4종 역할 선택이 PII 테이블 마스킹을 실시간 전환
- super_admin은 전체 Plain, auditor는 대부분 Denied
- FAB Equipment 8행 + General PII 5행 데이터 표시
- 마스킹 셀: amber(masked)/red(anonymized,denied) 배경 + 아이콘(EyeOff/ShieldAlert/Lock)
- 컬럼 헤더 PII 등급 배지 (highest/high/medium/low/none)
- Info Banner 역할별 권한 메시지
- pii-config.ts의 applyPiiMasking()을 직접 사용 (마스킹 로직 재구현 금지)
- TypeScript strict mode 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/07-query-console-rbac/07-03-SUMMARY.md`
</output>
