---
phase: 05-gpu-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/gpu/GpuPerformanceTrend.tsx
  - src/components/gpu/GpuComparisonBar.tsx
autonomous: true
requirements: [GPU-03, GPU-06]

must_haves:
  truths:
    - "Performance Trend chart renders 4 GPU lines for the active metric tab"
    - "Tabs switch between Utilization/Temperature/Power/Memory and the chart re-renders with correct data"
    - "Clicking a legend item toggles that GPU line's visibility on/off"
    - "Y-axis domain stays fixed when toggling individual GPU lines (no scale jump)"
    - "Comparison Bar chart shows 4 GPUs side-by-side with grouped bars for 4 metrics"
    - "Both charts respond to container resize and clean up SVG on unmount"
  artifacts:
    - path: "src/components/gpu/GpuPerformanceTrend.tsx"
      provides: "D3 multi-line chart with tab switching and legend toggle"
      min_lines: 120
    - path: "src/components/gpu/GpuComparisonBar.tsx"
      provides: "D3 grouped bar chart comparing 4 GPUs"
      min_lines: 80
  key_links:
    - from: "src/components/gpu/GpuPerformanceTrend.tsx"
      to: "@/components/charts/shared/chart-utils"
      via: "cleanupD3Svg, createDebouncedResizeObserver"
      pattern: "import.*cleanupD3Svg.*from.*chart-utils"
    - from: "src/components/gpu/GpuPerformanceTrend.tsx"
      to: "@/components/charts/shared/chart-theme"
      via: "getChartColors for resolved colors"
      pattern: "import.*getChartColors.*from.*chart-theme"
    - from: "src/components/gpu/GpuPerformanceTrend.tsx"
      to: "@/components/charts/shared/chart-tooltip"
      via: "createTooltip for hover interactions"
      pattern: "import.*createTooltip.*from.*chart-tooltip"
    - from: "src/components/gpu/GpuComparisonBar.tsx"
      to: "@/components/charts/shared/chart-utils"
      via: "cleanupD3Svg, createDebouncedResizeObserver"
      pattern: "import.*cleanupD3Svg.*from.*chart-utils"
---

<objective>
Implement the D3 multi-line Performance Trend chart (GPU-03) with metric tab switching and interactive legend, plus the D3 grouped Comparison Bar chart (GPU-06). Replace the ChartSkeleton stubs created in Plan 01 with fully functional D3 chart components.

Purpose: Deliver the two "standard" D3 chart types (line + bar) that use well-established D3 patterns. These charts let users analyze GPU performance over time and compare GPU metrics side-by-side.
Output: Two working D3 chart components with theme-aware colors, responsive sizing, tooltips, and proper cleanup.
</objective>

<execution_context>
@/Users/chs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gpu-monitoring/05-CONTEXT.md
@.planning/phases/05-gpu-monitoring/05-RESEARCH.md
@.planning/phases/05-gpu-monitoring/05-01-SUMMARY.md
@src/components/charts/shared/chart-utils.ts
@src/components/charts/shared/chart-theme.ts
@src/components/charts/shared/chart-tooltip.ts
@src/components/charts/shared/ChartSkeleton.tsx
@src/data/gpu-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: D3 Multi-line Performance Trend Chart</name>
  <files>src/components/gpu/GpuPerformanceTrend.tsx</files>
  <action>
Replace the ChartSkeleton stub in GpuPerformanceTrend.tsx with a full D3 multi-line chart implementation.

**Component structure:**
- `"use client"` component
- Props: `{ series: GpuTimeSeries[] }` (imported from `@/data/gpu-data`)
- State: `activeMetric: GpuMetricType` (default "utilization"), `visibleGpus: Set<string>` (default all 4 GPU names), `isClient: boolean`
- Ref: `containerRef` for the D3 SVG container div

**Outer layout:**
- shadcn Card wrapping everything
- CardHeader with title "Performance Trends" and shadcn Tabs for metric switching
- Tabs with 4 TabsTrigger items: Utilization, Temperature, Power, Memory
- TabsContent is shared (single chart area) — the activeMetric state controls which data is plotted
- Chart container div: `className="w-full h-[350px]"` with `data-testid="gpu-performance-trend"`

**D3 rendering (inside useEffect, depends on [isClient, series, activeMetric, visibleGpus]):**
1. Guard: `if (!isClient || !containerRef.current || series.length === 0) return`
2. Get colors via `getChartColors()` and create tooltip via `createTooltip()`
3. Call `cleanupD3Svg(containerRef.current)` at start of each draw
4. Get container dimensions, define margins: `{ top: 40, right: 20, bottom: 40, left: 50 }`
5. Filter series to active metric: `series.filter(s => s.metric === activeMetric)`
6. **CRITICAL — Fixed Y-axis domain:** Compute Y-axis domain from ALL series of the active metric (not just visible ones). This prevents scale jumping when toggling GPU lines. Use `d3.extent()` on the full filtered dataset, then `yScale.nice()`.
7. X-axis: `d3.scaleTime()` from extent of time values
8. Y-axis: `d3.scaleLinear()` with domain from step 6
9. Draw axes with `d3.axisBottom(xScale).ticks(6)` and `d3.axisLeft(yScale).ticks(5)`. Style axis lines and text with theme colors from `colors.axisLine` and `colors.text`.
10. Line generator: `d3.line<TimeSeriesPoint>().x(d => xScale(d.time)).y(d => yScale(d.value)).curve(d3.curveMonotoneX)`
11. Draw lines only for visible GPUs: filter by `visibleGpus.has(s.gpuName)`. Use `var(--chart-N)` for stroke colors (N = 1-based index of GPU in the full list, not the filtered list).
12. Add hover circles on each line for tooltip interaction: invisible circles at each data point, on mouseover show tooltip with GPU name, time, and value.

**Legend (drawn inside SVG, above chart area in the top margin):**
- Position at top-left of chart area
- One legend item per GPU (all 4, regardless of visibility)
- Each item: short colored line + GPU name text
- Opacity: 1 if visible, 0.3 if hidden
- Cursor: pointer
- On click: toggle GPU in `visibleGpus` set (use React setState with new Set)

**Y-axis unit labels by metric:**
- utilization: "%" (range 0-100)
- temperature: "C" (range ~40-90)
- power: "W" (range ~100-400)
- memory: "GB" (range ~0-80)

Add a Y-axis label text element showing the unit.

**Cleanup:** Return function from useEffect that calls `observer.disconnect()`, `tooltip.destroy()`, `cleanupD3Svg(container)`.

**SSR guard:** Show `<ChartSkeleton />` when `!isClient`.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify the component file has D3 imports: `grep "d3-" src/components/gpu/GpuPerformanceTrend.tsx` should show d3-scale, d3-shape, d3-axis, d3-selection, d3-array, d3-time-format imports. Verify `cleanupD3Svg` and `createDebouncedResizeObserver` are imported from chart-utils.</verify>
  <done>Performance Trend chart renders 4 GPU multi-line paths. Tabs switch between Utilization/Temperature/Power/Memory. Legend toggles individual GPU line visibility. Y-axis domain is stable when toggling. Chart resizes responsively. Tooltip shows on hover. SVG cleans up on unmount.</done>
</task>

<task type="auto">
  <name>Task 2: D3 Grouped Comparison Bar Chart</name>
  <files>src/components/gpu/GpuComparisonBar.tsx</files>
  <action>
Replace the ChartSkeleton stub in GpuComparisonBar.tsx with a full D3 grouped bar chart.

**Component structure:**
- `"use client"` component
- Props: `{ data: GpuComparisonItem[] }` (imported from `@/data/gpu-data`)
- State: `isClient: boolean`
- Ref: `containerRef` for D3 SVG container

**Outer layout:**
- shadcn Card wrapping the chart
- CardHeader with title "GPU Comparison"
- Chart container div: `className="w-full h-[300px]"` with `data-testid="gpu-comparison-bar"`

**D3 rendering:**
1. Guard + colors + tooltip + cleanup (same pattern as Task 1)
2. Margins: `{ top: 30, right: 20, bottom: 50, left: 50 }`
3. Define metrics array: `["utilization", "memoryPercent", "temperature", "powerPercent"]`
4. Define metric display labels: `["Utilization %", "Memory %", "Temp (norm)", "Power %"]`
5. GPU names from data: `data.map(d => d.gpuName)`

**Scales:**
- `x0`: `d3.scaleBand()` for GPU names, range [0, innerW], paddingInner(0.2)
- `x1`: `d3.scaleBand()` for metrics within each GPU group, range [0, x0.bandwidth()], padding(0.05)
- `yScale`: `d3.scaleLinear()` domain [0, 100], range [innerH, 0]

**Bars:**
- For each GPU, create a group at x0(gpuName)
- For each metric, draw a rect at x1(metric)
- Temperature is normalized to 0-100 scale: `(value / 90) * 100`
- Fill colors: `var(--chart-1)` through `var(--chart-4)` for the 4 metrics
- Round top corners: `rx: 2`

**Axes:**
- X-axis: GPU names (GPU-0, GPU-1, GPU-2, GPU-3)
- Y-axis: 0-100 scale with ticks
- Style with theme colors

**Legend:**
- Below the chart or in CardHeader area
- 4 items: one per metric with matching color swatch
- Static legend (no toggle interaction needed for bar chart)

**Tooltip:**
- On bar hover: show GPU name, metric name, actual value (not normalized)
- For temperature, show actual C value; for others, show percentage

**Cleanup:** Same pattern — observer.disconnect(), tooltip.destroy(), cleanupD3Svg().
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Verify D3 imports: `grep "d3-" src/components/gpu/GpuComparisonBar.tsx` shows d3-scale, d3-axis, d3-selection, d3-array. Verify the file is more than 80 lines: `wc -l src/components/gpu/GpuComparisonBar.tsx`.</verify>
  <done>Comparison Bar chart renders 4 GPU groups, each with 4 metric bars side-by-side. Y-axis scaled 0-100. Temperature normalized for comparison. Legend shows metric labels with color swatches. Tooltip shows actual values on hover. Chart resizes and cleans up properly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds with /monitoring/gpu route
3. GpuPerformanceTrend.tsx contains D3 multi-line rendering with tab switching and legend toggle
4. GpuComparisonBar.tsx contains D3 grouped bar rendering
5. Both components use established patterns: cleanupD3Svg, createDebouncedResizeObserver, getChartColors, createTooltip
6. Both components handle SSR with isClient guard and ChartSkeleton fallback
</verification>

<success_criteria>
- Performance Trend: 4 GPU lines render per metric tab, tabs switch content, legend toggles lines, Y-axis stays fixed
- Comparison Bar: 4 GPU groups with 4 metric bars each, correct color coding, tooltip with actual values
- Both charts resize on container change and clean up D3 elements on unmount
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-gpu-monitoring/05-02-SUMMARY.md`
</output>
